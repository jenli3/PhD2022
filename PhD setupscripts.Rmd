---
title: "Jen's scripts for PhD - set up files"
output:
  html_document:
    df_print: paged
---

### AUSCAD related set up files

This chunk has setup.auscad.R and auscad.extra.functions.R files combined
```{r, echo=TRUE, results = FALSE, warning = FALSE, eval = FALSE}

###############################
####### Load packages ########
###############################
packagesload <- c()
packagesload <- c("tidyverse", "dplyr", "readxl", "ggpubr", 
                  "graphics", "eeptools", "Gmisc", "knitr", 
                  "table1", "MatchIt", "htmlTable", "magrittr", 
                  "survminer", "survival", "lattice", "rstatix", 
                  "viridis",  "reshape2", "rcompanion", "ggsci",
                  "edgeR", "limma", "Glimma", "gridExtra",
                  "AnnotationDbi", "GOexpress", "Matrix", 
                  "org.Hs.eg.db", "org.Mm.eg.db", "ggfortify",  
                  "RColorBrewer", "mixOmics", "VennDiagram", 
                  "monocle", "Rtsne", "gplots", "ggplot2", 
                  "NMF", "EnhancedVolcano", "calibrate", "epitools",
                  "pheatmap", "vsn", "Seurat", "SeuratObject", 
                  "FSA", "pathfindR",  "PCAtools", "rrcov", 
                  "pcaExplorer", "usethis", "devtools", "ComICS", 
                  "pathview", "rjson", "cowplot", "grid",
                  "readbitmap", "rhdf5",  "hdf5r",  "data.table", 
                  "tibble", "clusterProfiler", "ReactomePA", 
                  "pathview",  "enrichplot", "DOSE", "superheat", 
                  "stringr",  "Rcpp", "NMF",  "kableExtra", "imager", 
                  "spData", "spdep", "topGO", "biomaRt", 
                  "STdeconvolve", "STutility", "SpatialCPie",  
                  "clustree", "pander",  "pagoda2", "harmony", 
                  "SingleCellExperiment",  "SCINA", "shiny", 
                  "xtable","S4Vectors", "MASS", "singleCellHaystack", 
                  "NMF", "gt", "igraph", "GOplot", "ggnewscale",
                  "ggvenn", "GEOquery",  "forcats", "stringr",
                  "ggrepel", "readr", "tidyr", "XML", "harmony", 
                  "MLeval", "GGally", "gtsummary", "finalfit", 
                  "caret", "shiny",  "SingleR", "scmap", "celldex", 
                  "SingleCellExperiment", "SCINA", "ggVennDiagram", 
                  "directPA", "Nebulosa", "nnet", "broom", "cmprsk",
                  "MuSiC", "granulator", "scMappR","patchwork", 
                  "networkD3", "ggalluvial", "ggsankey", "FactoMineR", 
                  "factoextra", "writexl", "caret", "skimr", "RANN",
                  "elasticnet", "pROC", "glmnet", "ROCR")


installed_packages <- packagesload %in% rownames(installed.packages())
  if (any(installed_packages == FALSE)) {
    install.packages(packagesload[!installed_packages], dependencies = TRUE)}
  invisible(lapply(packagesload, library, character.only = TRUE, quietly = TRUE))

  pkg.versions = data.frame(packagesload)
  colnames(pkg.versions) = "packages.used"
  pkg.versions$version = "NA"
  for (i in 1:length(pkg.versions$packages.used)){
    pkg.versions[i,]$version = package.version(pkg.versions[i,]$packages.used)}

  
########################################################################
######### Making the S4 to store clin + RNA data in one place ##########
########################################################################
setClass("auscad.sorted",
         slots = c(metadata.all = "data.frame", samples.all = "data.frame",
                   counts.all = "data.frame", conversions = "data.frame",
                   samples.biopsy.0m = "data.frame", counts.biopsy.0m = "data.frame",
                   samples.biopsy.1m = "data.frame", counts.biopsy.1m = "data.frame",
                   samples.biopsy.3m = "data.frame", counts.biopsy.3m = "data.frame",
                   samples.blood.0m = "data.frame", counts.blood.0m = "data.frame",
                   samples.blood.3m = "data.frame", counts.blood.3m = "data.frame"),
         
         prototype = list(metadata.all = data.frame(), samples.all = data.frame(),
                          counts.all = data.frame(), conversions = data.frame(),
                          samples.biopsy.0m = data.frame(), counts.biopsy.0m = data.frame(),
                          samples.biopsy.1m = data.frame(), counts.biopsy.1m = data.frame(),
                          samples.biopsy.3m = data.frame(), counts.biopsy.3m = data.frame(),
                          samples.blood.0m = data.frame(), counts.blood.0m = data.frame(),
                          samples.blood.3m = data.frame(), counts.blood.3m = data.frame()))

####################################################
###### CUSTOM FUNCTIONS for AUSCAD analysis
####################################################
  
#### Normalise for DGE #######
sort.normalise = function(sample, counts, spec.group){
  sample1 = sample
  sample1c = counts
  meta.sample1 = sample1 %>% mutate(samplename = rownames(sample1))
  counts.sample1 = sample1c %>% mutate(ensg = rownames(sample1c))
  groups.sample1 = counts.sample1 %>% dplyr::filter(ensg %in% "ENSG00000237973")
  groups.sample1 = groups.sample1 %>% 
    gather(colnames(groups.sample1[,-ncol(groups.sample1)]), 
           key = "samplename", value = "normalized_counts")
  groups.1 = inner_join(meta.sample1, groups.sample1, by = "samplename")
  
  dge.auscad = DGEList(counts = sample1c,
                       lib.size = colSums(sample1c),
                       norm.factors = rep(1,ncol(sample1c)),
                       samples = groups.1,
                       group = unlist(groups.1[,which(colnames(groups.1) == spec.group)]))
  
  keep1 = filterByExpr(dge.auscad, group=dge.auscad$samples$group) # remove low exp
  dge.auscad = dge.auscad[keep1, keep.lib.sizes = FALSE]
  dge.auscad = calcNormFactors(dge.auscad, method = "TMM") 
  
  dge.auscad = dge.auscad[,which(!is.na(dge.auscad$samples$group))]
  dge.auscad$samples$group = as.factor(dge.auscad$samples$group)
  
  return(dge.auscad)
}
  

##### Basic plots for dge/overview
initial.plots = function(dge.auscad){
    dge.lcpm = edgeR::cpm(dge.auscad, log=TRUE)
    p1 = boxplot(dge.lcpm, las=2, col=brewer.pal(ncol(dge.lcpm), "Paired"), 
                 ylab = "Expression in log-cpm",
                 main="log-CPM After Filtering & TMM")
    
    pheatmap(cor(getCounts(dge.auscad)),
             annotation = dplyr::select(dge.auscad$samples, group),
             show_rownames = FALSE)
    
    dge.auscad.table = as.data.frame(t(dge.lcpm))
    dge.auscad.table$Condition = dge.auscad$samples$group
    dge.auscad.table$Batch = dge.auscad$samples$batch
    
    pca = prcomp(as.data.frame(t(dge.lcpm)), scale = TRUE)
    
    p2 = autoplot(pca, data=dge.auscad.table, colour = "Condition", 
                  size = 5, frame = TRUE, 
                  frame.type = 'norm') +  
      theme_bw() + theme(legend.position = "bottom") +
      guides(color=guide_legend(nrow=2, byrow=TRUE))
    
    p3 = autoplot(pca, data=dge.auscad.table, colour = "Batch", 
                  size = 5, frame = TRUE, frame.type = 'norm') + 
      theme_bw() +  theme(legend.position = "bottom") +
      guides(color=guide_legend(nrow=2, byrow=TRUE))
    
    dge.auscad.table1 = as.data.frame(t(removeBatchEffect(dge.lcpm, dge.auscad$samples$batch)))
    dge.auscad.table1$Condition = dge.auscad$samples$group
    dge.auscad.table1$Batch = dge.auscad$samples$batch
    p4 = autoplot(
      prcomp(dge.auscad.table1[,-((ncol(dge.auscad.table1)-1):ncol(dge.auscad.table1))],
             scale = TRUE, center = TRUE),
      data=dge.auscad.table1, colour = "Batch", size = 5,
      frame = TRUE, frame.type = 'norm') + 
      theme_bw() + theme(legend.position = "bottom") +
      guides(color=guide_legend(nrow=2, byrow=TRUE))
  
    
    d.pca = data.frame(PC_1 = pca$x[,1],PC_2 = pca$x[,2])
    d.pca = cbind(d.pca, dge.auscad$samples)
    
    fit1 = lm(PC_1 ~ group + batch + lib.size + donor_age +
                donor_gender + gender +  cit_min, data = d.pca)
    
    fit2 = glm(group ~ batch + lib.size +donor_age + donor_gender +  
                 gender  +  cit_min, data = d.pca, family = "binomial")
    summary(fit1)
    summary(fit2)
    
    p5 = ggarrange(p2, p3, p4,ncol = 3, nrow = 1) 
    
    p6 = ggplot(d.pca, 
           aes(x = PC_1, y = PC_2, color = dgf_define, 
               text = paste(samplename,batch, sep = "__"))) + 
      geom_point(size = 4) + theme_bw()
    
    output = list(p5, p6)
    return(output)
  }


######## Plotting KM/survival curves #######
p.surv = function(surv.1, legend.labs, palette, title){
  p.surv = ggsurvplot(surv.1, pval = TRUE, conf.int = FALSE, 
                      palette = palette, legend = "right",
                      legend.labs = legend.labs,
                      title = title,
                      ylab = "Event-free survival",  
                      xlab = "Time (months)",
                      xlim = c(0,60), ylim = c(0, 1), 
                      break.x.by=6,risk.table.col = "strata",  
                      linetype = "strata",   fontsize= 4,
                      risk.table = TRUE, risk.table.height = 0.3,
                      tables.theme = clean_table_theme(),
                      ggtheme = theme_classic())}


####### Plotting SANKEY diagram ####### 
auscad.sankey = function(dgf.filter, remove.lkd, list.s) {
  
  if (remove.lkd == TRUE) { # if living donor kidney tx included or not
    dgf.filter.s1 = dgf.filter
    dgf.filter.s1 = dgf.filter.s1[dgf.filter.s1$organ_type != "Living Kidney Transplant",]
    dgf.filter.s1$organ_type = droplevels(dgf.filter.s1$organ_type)
    dgf.filter.s1 = dgf.filter.s1[dgf.filter.s1$donor_criteria != "LKD",]
    dgf.filter.s1$donor_criteria = droplevels(dgf.filter.s1$donor_criteria)
  } else {dgf.filter.s1 = dgf.filter}
  
  
  dgf.filter.s1 = dgf.filter.s1 %>%
    make_long(list.s) # Use make_long to convert into the right format
  
  plot.s1 =  ggplot(dgf.filter.s1, aes(x = x
                                       , next_x = next_x
                                       , node = node
                                       , next_node = next_node
                                       , fill = factor(node)
                                       , label = node))+ 
    geom_sankey(flow.alpha = 0.5 , node.color = "black", show.legend = FALSE) +
    geom_sankey_label(size = 4, color = "black", fill= "white")+ 
    theme_bw()+ theme(legend.position = "right") +
    theme(axis.title = element_blank()  , axis.text.y = element_blank(), 
          axis.ticks = element_blank()  , panel.grid = element_blank()) +
    labs(title = "AUSCAD dataset")+  labs(fill = 'Nodes')
  
  plot.s1
}

###### Z scores 01 ######3
cal_z_score = function(x){(x - mean(x)) / sd(x)}


##### Filter out irrelevant terms in pathways dataframe ######
removecrap = function(data){
  remove1 = c(data$Description[grep("ameboidal", data$Description, ignore.case = TRUE)], 
              data$Description[grep("glial", data$Description, ignore.case = TRUE)], 
              data$Description[grep("spine", data$Description, ignore.case = TRUE)], 
              data$Description[grep("rhythmic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("heart", data$Description, ignore.case = TRUE)], 
              data$Description[grep("hair", data$Description, ignore.case = TRUE)],
              data$Description[grep("cardiac", data$Description, ignore.case = TRUE)], 
              data$Description[grep("aorta", data$Description, ignore.case = TRUE)], 
              data$Description[grep("valve", data$Description, ignore.case = TRUE)], 
              data$Description[grep("covid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("embryo", data$Description, ignore.case = TRUE)], 
              data$Description[grep("biotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neuromuscular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("antimicrobial", data$Description, ignore.case = TRUE)],
              data$Description[grep("spramolecular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("clathrin", data$Description, ignore.case = TRUE)], 
              data$Description[grep("bone", data$Description, ignore.case = TRUE)], 
              data$Description[grep("endocondral", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ER", data$Description, ignore.case = TRUE)], 
              data$Description[grep("melanocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("collagen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("tube", data$Description, ignore.case = TRUE)], 
              data$Description[grep("coronary", data$Description, ignore.case = TRUE)], 
              data$Description[grep("vascular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("visual", data$Description, ignore.case = TRUE)], 
              data$Description[grep("disc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("synaptic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("tree", data$Description, ignore.case = TRUE)], 
              data$Description[grep("somatodendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("detection", data$Description, ignore.case = TRUE)], 
              data$Description[grep("sensory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("virus", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neuron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("viral", data$Description, ignore.case = TRUE)], 
              data$Description[grep("gonad", data$Description, ignore.case = TRUE)], 
              data$Description[grep("biological", data$Description, ignore.case = TRUE)], 
              data$Description[grep("organ", data$Description, ignore.case = TRUE)], 
              data$Description[grep("male", data$Description, ignore.case = TRUE)], 
              data$Description[grep("female", data$Description, ignore.case = TRUE)], 
              data$Description[grep("syncitium", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ossification", data$Description, ignore.case = TRUE)], 
              data$Description[grep("reproductive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("symbiotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("alcohol", data$Description, ignore.case = TRUE)], 
              data$Description[grep("actin", data$Description, ignore.case = TRUE)], 
              data$Description[grep("synapse", data$Description, ignore.case = TRUE)], 
              data$Description[grep("muscle", data$Description, ignore.case = TRUE)], 
              data$Description[grep("gliogenesis", data$Description, ignore.case = TRUE)],
              data$Description[grep("neuron", data$Description, ignore.case = TRUE)],
              data$Description[grep("neural", data$Description, ignore.case = TRUE)],
              data$Description[grep("striated", data$Description, ignore.case = TRUE)],
              data$Description[grep("artery", data$Description, ignore.case = TRUE)],
              data$Description[grep("biotic", data$Description, ignore.case = TRUE)],
              data$Description[grep("cartilage", data$Description, ignore.case = TRUE)],
              data$Description[grep("vessel", data$Description, ignore.case = TRUE)],
              data$Description[grep("organic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lithium", data$Description, ignore.case = TRUE)], 
              data$Description[grep("progesterone", data$Description, ignore.case = TRUE)],
              data$Description[grep("spindle", data$Description, ignore.case = TRUE)],
              data$Description[grep("multicellular", data$Description, ignore.case = TRUE)],
              data$Description[grep("myoblast", data$Description, ignore.case = TRUE)],
              data$Description[grep("skeletal", data$Description, ignore.case = TRUE)],
              data$Description[grep("wound", data$Description, ignore.case = TRUE)],
              data$Description[grep("parkinson", data$Description, ignore.case = TRUE)],
              data$Description[grep("cytoskeleton", data$Description, ignore.case = TRUE)])
  data = data[!data$Description %in% remove1,]
  return(data)
}

##### Pick immune related terms in pathways dataframe #######
pickimmune = function(data){
  immune1 = c(data$Description[grep("immune", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammatory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("myeloid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("nk", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)], 
              data$Description[grep("innate", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adaptive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("complement", data$Description, ignore.case = TRUE)],
              data$Description[grep("toll", data$Description, ignore.case = TRUE)],
              data$Description[grep("mhc", data$Description, ignore.case = TRUE)],
              data$Description[grep("cxc", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("chemotaxis", data$Description, ignore.case = TRUE)],
              data$Description[grep("migration", data$Description, ignore.case = TRUE)],
              data$Description[grep("death", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("immune", data$Description, ignore.case = TRUE)],
              data$Description[grep("pyroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necrosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("autophagy", data$Description, ignore.case = TRUE)],
              data$Description[grep("ferroptosis", data$Description, ignore.case = TRUE)])
  data = data[data$Description %in% immune1,]
  return(data)
}


####### Pick relevant to renal IRI/tolDC in pathways dataframe#########
pickrelevant = function(data){
  immune1 = c(data$Description[grep("immune", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphoid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammatory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("myeloid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("nk", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)], 
              data$Description[grep("innate", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adaptive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("complement", data$Description, ignore.case = TRUE)],
              data$Description[grep("toll", data$Description, ignore.case = TRUE)],
              data$Description[grep("mhc", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("chemotaxis", data$Description, ignore.case = TRUE)],
              data$Description[grep("caspase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NLRP3", data$Description, ignore.case = TRUE)], 
              data$Description[grep("CXC", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammasome", data$Description, ignore.case = TRUE)], 
              data$Description[grep("aim2", data$Description, ignore.case = TRUE)], 
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("repair", data$Description, ignore.case = TRUE)], 
              data$Description[grep("migration", data$Description, ignore.case = TRUE)],
              data$Description[grep("death", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptotitc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("immune", data$Description, ignore.case = TRUE)],
              data$Description[grep("pyroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necrosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("autophagy", data$Description, ignore.case = TRUE)],
              data$Description[grep("mitochondria", data$Description, ignore.case = TRUE)],
              data$Description[grep("mitochondrial", data$Description, ignore.case = TRUE)],
              data$Description[grep("oxidative", data$Description, ignore.case = TRUE)],
              data$Description[grep("oxidation", data$Description, ignore.case = TRUE)],
              data$Description[grep("fatty acid", data$Description, ignore.case = TRUE)],
              data$Description[grep("lipid", data$Description, ignore.case = TRUE)],
              data$Description[grep("peroxisomes", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("glutathione", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ferroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("cycle", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adhesion", data$Description, ignore.case = TRUE)],  
              data$Description[grep("polarity", data$Description, ignore.case = TRUE)],  
              data$Description[grep("mitotic", data$Description, ignore.case = TRUE)],  
              data$Description[grep("epithelial", data$Description, ignore.case = TRUE)],
              data$Description[grep("fibroblast", data$Description, ignore.case = TRUE)], 
              data$Description[grep("exocytosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("arachadonic", data$Description, ignore.case = TRUE)],
              data$Description[grep("electron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("locomotion", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respiration", data$Description, ignore.case = TRUE)], 
              data$Description[grep("angiogenesis", data$Description, ignore.case = TRUE)],
              data$Description[grep("reduction", data$Description, ignore.case = TRUE)], 
              data$Description[grep("oxygen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("plasma membrane", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NADH", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dehydrogenase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respirasome", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respiratory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("oxidoreductase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("iron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("heme", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NAD", data$Description, ignore.case = TRUE)],
              data$Description[grep("NF", data$Description, ignore.case = TRUE)], 
              data$Description[grep("kappa", data$Description, ignore.case = TRUE)], 
              data$Description[grep("phosphatidylinositol", data$Description, ignore.case = TRUE)])
  data = data[data$Description %in% immune1,]
  return(data)
}

#### Trimmer to refine terms in pathways dataframe ####
trimmer = function(data){
  data = data[data$p.adjust < 0.05,]
  data = removecrap(data)
  data = data[!(data$Description == "viral entry into host cell"),]
  data = data[!(data$Description == "neuroinflammatory response"),]
  data = data[!(data$Description == "immune response"),]
  data = data[!(data$Description == "immune system process"),]
  data = data[!(data$Description == "enzyme linked receptor protein signaling pathway"),]
  data = data[!(data$Description == "inflammatory response"),]
  data = data[!(data$Description == "tissue migration"),]
  data = data[!(data$Description == "movement in host environment"),]
  
  remove = c(data$Description[grep("regulation",  data$Description, ignore.case = TRUE)],  
             data$Description[grep("epithelium",  data$Description, ignore.case = TRUE)],
             data$Description[grep("projection",  data$Description, ignore.case = TRUE)],
             data$Description[grep("sprouting",  data$Description, ignore.case = TRUE)],
             data$Description[grep("complex I",   data$Description, ignore.case = TRUE)], 
             data$Description[grep("plasma membrane",   data$Description, ignore.case = TRUE)],
             data$Description[grep("cellular lipid",   data$Description, ignore.case = TRUE)],
             data$Description[grep("locomotion",   data$Description, ignore.case = TRUE)],
             data$Description[grep("adhesion",   data$Description, ignore.case = TRUE)],
             data$Description[grep("protein",   data$Description, ignore.case = TRUE)],
             data$Description[grep("migration",   data$Description, ignore.case = TRUE)])
  data = data[!(data$Description %in% remove),]
  
  myeloid = c(data$Description[grep("myeloid", data$Description, ignore.case = TRUE)],
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("mononuclear", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("granulocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)],
              data$Description[grep("tumour", data$Description, ignore.case = TRUE)],
              data$Description[grep("complement", data$Description, ignore.case = TRUE)], 
              data$Description[grep("tumor", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)],
              data$Description[grep("innate", data$Description, ignore.case = TRUE)])
  
  lymphoid = c(data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)],
               data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
               data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
               data$Description[grep("humoral", data$Description, ignore.case = TRUE)], 
               data$Description[grep("chemotaxis", data$Description, ignore.case = TRUE)], 
               data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
               data$Description[grep("effector", data$Description, ignore.case = TRUE)], 
               data$Description[grep("adaptive", data$Description, ignore.case = TRUE)])
  lymphoid = lymphoid[!(lymphoid %in% myeloid)]
  
  c.death = c(data$Description[grep("death", data$Description, ignore.case = TRUE)],
              data$Description[grep("apoptotic", data$Description, ignore.case = TRUE)],
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("immune", data$Description, ignore.case = TRUE)])
  
  metab = c(data$Description[grep("oxidation", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxidative", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxygen", data$Description, ignore.case = TRUE)],
            data$Description[grep("heme", data$Description, ignore.case = TRUE)],
            data$Description[grep("fatty", data$Description, ignore.case = TRUE)],
            data$Description[grep("lipid", data$Description, ignore.case = TRUE)],
            data$Description[grep("iron", data$Description, ignore.case = TRUE)],
            data$Description[grep("respiratory", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxidoreductase", data$Description, ignore.case = TRUE)], 
            data$Description[grep("dehydrogenase", data$Description, ignore.case = TRUE)], 
            data$Description[grep("glutathione", data$Description, ignore.case = TRUE)], 
            data$Description[grep("NAD", data$Description, ignore.case = TRUE)], 
            data$Description[grep("tricarboxylic", data$Description, ignore.case = TRUE)], 
            data$Description[grep("respirasome", data$Description, ignore.case = TRUE)],
            data$Description[grep("respiration", data$Description, ignore.case = TRUE)],
            data$Description[grep("electron", data$Description, ignore.case = TRUE)], 
            data$Description[grep("mitochondrial", data$Description, ignore.case = TRUE)], 
            data$Description[grep("mitochondria", data$Description, ignore.case = TRUE)])
  
  adh.cycle = c(data$Description[grep("adhesion", data$Description, ignore.case = TRUE)],
                data$Description[grep("epithelial", data$Description, ignore.case = TRUE)],
                data$Description[grep("angiogenesis", data$Description, ignore.case = TRUE)],
                data$Description[grep("mitotic", data$Description, ignore.case = TRUE)],
                data$Description[grep("exocytosis", data$Description, ignore.case = TRUE)],
                data$Description[grep("membrane", data$Description, ignore.case = TRUE)],
                data$Description[grep("fibroblast", data$Description, ignore.case = TRUE)],
                data$Description[grep("endothelial", data$Description, ignore.case = TRUE)],
                data$Description[grep("polarity", data$Description, ignore.case = TRUE)],
                data$Description[grep("phosphatidylinositol", data$Description, ignore.case = TRUE)],
                data$Description[grep("cycle", data$Description, ignore.case = TRUE)])
  adh.cycle = adh.cycle[!(adh.cycle%in% metab)]
  adh.cycle = adh.cycle[!(adh.cycle%in% c.death)]
  
  data$group  = NA
  data$group = ifelse(data$Description %in% myeloid, "innate", data$group)
  data$group = ifelse(data$Description %in% lymphoid, "adaptive", data$group)
  data$group = ifelse(data$Description %in% metab, "metab", data$group)
  data$group = ifelse(data$Description %in% adh.cycle, "cell", data$group)
  data$group = ifelse(data$Description %in% c.death, "death", data$group)
  
  return(data)
}


########### sort genes in order for symbol annotation #########
gene0symbol = function(data1) {
  gene0 = c()
  gene0 = data1$avg_log2FC # the Log2FC
  names(gene0) = data1$symbol # genes
  gene0 = sort(gene0, decreasing = TRUE) # sort decreasing order
  gene0 = gene0[!duplicated(names(gene0))]
  return(gene0)
}

########### sort genes in order for ensembl ##################

gene0ensembl = function(data1) {
  gene0 = c()
  gene0 = data1$avg_log2FC # the Log2FC
  names(gene0) = data1$ensembl # genes
  gene0 = sort(gene0, decreasing = TRUE) # sort decreasing order
  gene0 = gene0[!duplicated(names(gene0))]
  return(gene0)
}

########### sort genes in order for entrezid ################
gene0entrezid = function(data1) {
  gene0 = c()
  gene0 = data1$avg_log2FC # the Log2FC
  names(gene0) = data1$ENTREZID # genes
  gene0 = sort(gene0, decreasing = TRUE) # sort decreasing order
  gene0 = gene0[!duplicated(names(gene0))]
  return(gene0)
}


######## GO:Over representation (Enrichment) analysis (clusterprofiler) ########
egosummary = function (gene0, pcutoff, qcutoff, adjmethod) {
  
  # ontology cytosolic component
  ego.cc = enrichGO(gene     = names(gene0),
                    OrgDb         = org.Mm.eg.db,
                    keyType       = 'ENTREZID',
                    ont           = "CC",
                    pAdjustMethod = adjmethod,
                    pvalueCutoff  = pcutoff,
                    qvalueCutoff  = qcutoff, 
                    readable      = TRUE)
  egocc = filter(ego.cc, p.adjust < 0.05, qvalue < 0.05)
  egocc = mutate(egocc, geneRatio = parse_ratio(GeneRatio)) %>% arrange(desc(geneRatio))
  egocc = mutate(egocc, richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
  egocc = mutate(egocc, FoldEnrichment =   parse_ratio(GeneRatio) /  parse_ratio(BgRatio))
  cc1 = barplot(egocc, showCategory=20, title ="cytosolic component")
  cc2 = dotplot(egocc, showCategory=20, title ="cytosolic component")
  cc3 = upsetplot(egocc)
  cc4 = heatplot(egocc)
  cc5 = goplot(egocc)
  cc6 = ggplot(egocc, showCategory = 20,  aes(FoldEnrichment,fct_reorder(Description, FoldEnrichment))) + 
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() + 
    xlab("FoldEnrichment") + ylab(NULL) + ggtitle("Enriched GO:CC - FE")
  
  listcc = list(cc1, cc2, cc3, cc4, cc5, cc6)
  
  # ontology = molecular function
  ego.mf = enrichGO(gene   = names(gene0),
                    OrgDb         = org.Mm.eg.db,
                    keyType       = 'ENTREZID',
                    ont           = "MF",
                    pAdjustMethod = adjmethod,
                    pvalueCutoff  = pcutoff,
                    qvalueCutoff  = qcutoff, 
                    readable      = TRUE)
  egomf = filter(ego.mf, p.adjust < 0.05, qvalue < 0.05)
  egomf = mutate(egomf, geneRatio = parse_ratio(GeneRatio)) %>%  arrange(desc(geneRatio))
  egomf = mutate(egomf, richFactor = Count /  as.numeric(sub("/\\d+", "", BgRatio)))
  egomf = mutate(egomf, FoldEnrichment =  parse_ratio(GeneRatio) / parse_ratio(BgRatio))
  mf1 = barplot(egomf, showCategory=20, title ="molecular function")
  mf2 = dotplot(egomf, showCategory=20, title ="molecular function")
  mf3 = upsetplot(egomf)
  mf4 = heatplot(egomf)
  mf5 = goplot(egomf)
  mf6  = ggplot(egomf, showCategory = 20, aes(FoldEnrichment, 
                                              fct_reorder(Description, FoldEnrichment))) + 
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() + 
    xlab("FoldEnrichment") + ylab(NULL) + ggtitle("Enriched GO:MF - FE")
  
  listmf = list(mf1, mf2, mf3, mf4, mf5, mf6)
  
  # ontology = biological process
  ego.bp = enrichGO(gene   = names(gene0),
                    OrgDb         = org.Mm.eg.db,
                    keyType       = 'ENTREZID',
                    ont           = "BP",
                    pAdjustMethod = adjmethod,
                    pvalueCutoff  = pcutoff,
                    qvalueCutoff  = qcutoff, 
                    readable      = TRUE)
  egobp = filter(ego.bp, p.adjust < 0.05, qvalue < 0.05)
  egobp = mutate(egobp, geneRatio = parse_ratio(GeneRatio)) %>% arrange(desc(geneRatio))
  egobp = mutate(egobp, richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
  egobp = mutate(egobp, FoldEnrichment =  parse_ratio(GeneRatio) / parse_ratio(BgRatio))
  bp1 = barplot(egobp, showCategory=20,  title ="biological process")
  bp2 = dotplot(egobp, showCategory=20,  title ="biological process")
  bp3 = upsetplot(egobp)
  bp4 = heatplot(egobp)
  bp5 = goplot(egobp)
  bp6 = ggplot(egobp, showCategory = 20, aes(FoldEnrichment, 
                                             fct_reorder(Description, FoldEnrichment))) + 
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() + 
    xlab("FoldEnrichment") +  ylab(NULL) + ggtitle("Enriched GO:BP")
  
  listbp=list(bp1, bp2, bp3, bp4, bp5, bp)
}


####### KEGG: Over representation (clusterprofiler) #############
ekeggsummary = function (gene0, pcutoff, qcutoff, adjmethod) {
  ekegg.mmu = enrichKEGG(gene  = names(gene0),
                         organism     = 'mmu',
                         pAdjustMethod = adjmethod,
                         pvalueCutoff = pcutoff,
                         qvalueCutoff = qcutoff)
  ekegg = filter(ekegg.mmu, p.adjust < 0.05, qvalue < 0.05)
  ekegg = mutate(ekegg, geneRatio = parse_ratio(GeneRatio)) %>% arrange(desc(geneRatio))
  ekegg = mutate(ekegg, richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
  ekegg = mutate(ekegg, FoldEnrichment =  parse_ratio(GeneRatio) / parse_ratio(BgRatio))
  ek1 = barplot(ekegg, showCategory=20,  title ="KEGG")
  ek2 = dotplot(ekegg, showCategory=20,  title ="KEGG")
  ek3 = upsetplot(ekegg)
  ek4 = heatplot(ekegg)
  ek5 = ggplot(ekegg, showCategory = 20, aes(geneRatio, fct_reorder(Description, geneRatio))) +
    geom_point(aes(color=p.adjust, size = Count))+ 
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() +
    xlab("GeneRatio") +ylab(NULL) + ggtitle("Enriched KEGG - GR")
  ek6 = ggplot(ekegg, showCategory = 20, aes(richFactor, fct_reorder(Description, richFactor))) +
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) + theme_minimal() + 
    xlab("RichFactor") +ylab(NULL) + ggtitle("Enriched KEGG - RF")
  ek7 = ggplot(ekegg, showCategory = 20,  aes(FoldEnrichment, 
                                              fct_reorder(Description, FoldEnrichment))) +
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() +
    xlab("FoldEnrichment") + ylab(NULL) + ggtitle("Enriched KEGG - FE")
  
  listkegg = list(ek1, ek2, ek3, ek4, ek5, ek6, ek7)
  enrichlist = list("egoKEGG" = ekegg,"ekeggplot" = listkegg)
  return(enrichlist)
}


############# GO: GSEA (clusterprofiler) ######################
ggosummarybp = function (gene0, pcutoff, adjmethod, ont){
  g.go.bp = gseGO(geneList = gene0, 
                  ont =ont, # options: All, BP MF  CC 
                  keyType = "ENSEMBL", 
                  OrgDb = org.Mm.eg.db, 
                  nPerm = 10000, # permutations, set 10,000 when correct
                  minGSSize = 10, # min number genes in set
                  maxGSSize = 1000, # max genes in a set
                  pvalueCutoff = pcutoff,
                  verbose = FALSE, 
                  seed = 42,
                  pAdjustMethod = adjmethod)
  ggo.bp = filter(g.go.bp, p.adjust < 0.05, qvalues < 0.05)
  x2.bp = pairwise_termsim(ggo.bp)
  ggo.bp1 = as.data.frame(ggo.bp)
  ggo.bp1 = ggo.bp1 %>%  dplyr::mutate(log.p.adj = -log(p.adjust)) %>%  arrange(ggo.bp1, NES)
  ggo.bp1$Pathway.Direction = cut(-1*ggo.bp1$NES,  c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  colnames(ggo.bp1)[4] = "Count"
  ggo.bp1 = removecrap(ggo.bp1)
  pg1.bp = dotplot(ggo.bp, showCategory = 20,  title = "GSEA-GO", split = ".sign") +
    facet_grid(.~.sign)
  pg2.bp = gseaplot(ggo.bp, by = "all", geneSetID = 1)
  pg3.bp = ridgeplot(ggo.bp) + labs(x = "enrichment distribution")
  pg4.bp = emapplot(x2.bp)
  pg5.bp = ggplot(ggo.bp1, aes(x = log.p.adj, y = Description)) + 
    geom_point(aes(color= p.adjust, size = setSize)) + theme_bw() + 
    geom_vline(xintercept  = 0, linetype = "dashed")+
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) + 
    theme(axis.text.y = element_text(size = 10)) +ylab("Description") +
    xlab("-log10 of P-value") + ggtitle("GSEA-GO:BP") + facet_grid(~Pathway.Direction)
  pg6.bp = cnetplot(x2.bp, categorySize = "p.adjust", 
                    colorEdge = TRUE, foldChange = gene0, 
                    node_label = "all", cex_label_category = 1.3)
  
  listgsego.bp = list(pg1.bp, pg2.bp, pg3.bp, pg4.bp, pg5.bp, pg6.bp)
  gselist = list("gsego.bp" = ggo.bp, "gsegoplot.bp" = listgsego.bp)
  return(gselist)
}


############# KEGG: GSEA (clusterprofiler)###################
gkeggsummary = function (gene0, pcutoff, adjmethod){
  pcutoff = 0.05
  adjmethod = "BH"
  g.kegg = gseKEGG(geneList  = gene0,
                   organism = "mmu",
                   keyType = "kegg",
                   minGSSize = 5,
                   maxGSSize = 1000,
                   pvalueCutoff = pcutoff,
                   pAdjustMethod = adjmethod,
                   verbose      = FALSE)
  gkegg = filter(g.kegg, p.adjust < 0.05, qvalues < 0.05)
  x2 = pairwise_termsim(gkegg)
  pk1 = dotplot(gkegg, showCategory = 20, title = "GSEA-kegg", split = ".sign") + facet_grid(.~.sign)
  pk2 = gseaplot(gkegg, by = "all", title = gkegg$Description[1], geneSetID = 1)
  pk3 = ridgeplot(gkegg, showCategory = 20) + labs(x = "enrichment distribution")
  listgsego = list(pk1, pk2, pk3)
  gselist = list("gsekegg" = gkegg, "gsekeggplot" = listgsego)
  return(gselist)
}

#### PathfindR pathway analysis for non human species ########
pathsummary = function (clustxvsy){
  clustxvsypath = clustxvsy[,c("symbol", "avg_log2FC", "p_val_adj")]
  pathrun = c()
  pathrun = run_pathfindR(clustxvsypath,
                          enrichment_threshold = 0.01,
                          gene_sets = "Custom",
                          custom_genes = mmu_kegg_genes,
                          custom_descriptions = mmu_kegg_descriptions,
                          output_dir = "pathfind")
  tablepath = knitr::kable(head(pathrun, 20))
  chartpath = enrichment_chart(result_df = pathrun, top_terms = 20)
  genepath = term_gene_graph(result_df = pathrun, use_description = TRUE)  
  heatpath = term_gene_heatmap(result_df = pathrun, genes_df = clustxvsypath)
  upsetpath = UpSet_plot(result_df = pathrun, genes_df = clustxvsypath)
  plotpath = list(tablepath, chartpath, genepath, heatpath, upsetpath)
  listpath = list("pathway" = pathrun, "pathway plots" = plotpath)
  return(listpath)
}


##################
# getting toptags
##################

convert.symbols = function(df){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(df), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    df = df[keep1,]
    df$symbol = Symbol.keep
    df$ensembl = rownames(df)
  return(df)
}


edgeR.tags = function(fit.0m){
  
  top.tags.edgeR = topTags(fit.0m,  n = Inf)
  summary(decideTests(fit.0m, adjust.method = "fdr", p.value = 0.05))
  top.tags.edgeR = as.data.frame(top.tags.edgeR) %>% 
    mutate(Symbol = rownames(top.tags.edgeR))
  top.tags.edgeR = top.tags.edgeR %>% mutate(Significant = FDR < 0.05)
  top.tags.edgeR = top.tags.edgeR %>% filter(FDR<0.05)
  
  if (nrow(top.tags.edgeR)>0){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(top.tags.edgeR), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    top.tags.edgeR = top.tags.edgeR[keep1,]
    top.tags.edgeR$symbol = Symbol.keep
    top.tags.edgeR$ensembl = rownames(top.tags.edgeR)
    }
  return(top.tags.edgeR)
}


limma.tags = function(efit, 
                      spec.group){
  top.tags.limma = topTable(efit, adjust.method="fdr", 
                            sort.by = "B", n = Inf, 
                            coef = spec.group)
  top.tags.limma = as.data.frame(top.tags.limma) %>% mutate(Symbol = rownames(top.tags.limma))
  top.tags.limma = top.tags.limma %>% mutate(Significant = adj.P.Val < 0.05)
  top.tags.limma = top.tags.limma %>% filter(adj.P.Val < 0.05)
  
  if (nrow(top.tags.limma)>0){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(top.tags.limma), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    top.tags.limma = top.tags.limma[keep1,]
    top.tags.limma$symbol = Symbol.keep
    top.tags.limma$ensembl = rownames(top.tags.limma)}

  return(top.tags.limma)
}


dge.summary = function(dge){
  dge = convert.symbols(dge)
  dge = arrange(dge, desc(logFC))
  up = sum(dge$logFC>0)
  down = sum(dge$logFC<0)
  top.10 = dge["logFC">0,]$symbol[1:10]
  output = data.frame(cbind(up, down, str_c(top.10, collapse = ", ")))
  colnames(output) = c("up", "down", "top.10")
  return(output)
}

###################################
# Basic DGE
###################################
basic.dge = function(samples, 
                     counts, 
                     variable1){
  sample1 = samples
  sample1c = counts
  meta.sample1 = sample1 %>% mutate(samplename = rownames(sample1))
  counts.sample1 = sample1c %>% mutate(ensg = rownames(sample1c))
  groups.sample1 = counts.sample1 %>% dplyr::filter(ensg %in% "ENSG00000237973")
  groups.sample1 = groups.sample1 %>% 
    gather(colnames(groups.sample1[,-ncol(groups.sample1)]), 
           key = "samplename", value = "normalized_counts")
  groups.1 = inner_join(meta.sample1, groups.sample1, by = "samplename")
  
  dge.auscad = DGEList(counts = sample1c,
                       lib.size = colSums(sample1c),
                       norm.factors = rep(1,ncol(sample1c)),
                       samples = groups.1,
                       group = unlist(groups.1[,which(colnames(groups.1) == variable1)]))
  
  keep1 = filterByExpr(dge.auscad, group=dge.auscad$samples$group) # remove low exp
  dge.auscad = dge.auscad[keep1, keep.lib.sizes = FALSE]
  dge.auscad = calcNormFactors(dge.auscad, method = "TMM") 
  
  dge.auscad = dge.auscad[,which(!is.na(dge.auscad$samples$group))]
  dge.auscad$samples$group = as.factor(dge.auscad$samples$group)
  
  data = dge.auscad$samples
  design = model.matrix(~0 + group + batch, data= dge.auscad$samples)
  colnames(design) = gsub("batch", "", colnames(design))
  colnames(design) =  gsub("group", "", colnames(design))
  colnames(design) =  gsub(" ", "", colnames(design))
  
  auscad.0m = dge.auscad[,rownames(design)]
  design = design[,which(colSums(design) > 2)]
  auscad.0m = estimateDisp(auscad.0m, design)
  glmfit.0m =  glmQLFit(auscad.0m, design)
  con.mat = makeContrasts(DGF = DGF.HD - Control, levels = design)
  
  # EdgeR
  fit.0m = glmLRT(glmfit.0m, contrast = con.mat[,"DGF"])
  top.tags.edgeR = topTags(fit.0m,  n = Inf)
  summary(decideTests(fit.0m, adjust.method = "fdr", p.value = 0.05))
  top.tags.edgeR = as.data.frame(top.tags.edgeR) %>% 
    mutate(Symbol = rownames(top.tags.edgeR))
  top.tags.edgeR = top.tags.edgeR %>% mutate(Significant = FDR < 0.05)
  top.tags.edgeR = top.tags.edgeR %>% filter(FDR<0.05)
  
  # Limma/ebayes  
  dds = voom(dge.auscad, design, plot=TRUE)
  fit = contrasts.fit(lmFit(dds, design), con.mat)
  efit = eBayes(fit, robust = FALSE)
  results = decideTests(efit, adjust.method = "BH", p.value = 0.05)
  top.tags.limma = topTable(efit, adjust.method="fdr", sort.by = "B", n = Inf)
  top.tags.limma = as.data.frame(top.tags.limma) %>% 
    mutate(Symbol = rownames(top.tags.limma))
  top.tags.limma = top.tags.limma %>% mutate(Significant = adj.P.Val < 0.05)
  top.tags.limma = top.tags.limma %>% filter(adj.P.Val < 0.05)
  
  summary.numbers = data.frame(summary(dge.auscad$samples$group))
  
  setClass("dge.list",
           slots = c(top.tags.edgeR = "data.frame", 
                     top.tags.limma = "data.frame",
                     summary.numbers = "data.frame"),
           
           prototype = list(top.tags.edgeR = data.frame(), 
                            top.tags.limma = data.frame(),
                            summary.numbers = data.frame()))
  
  output = new("dge.list",
               top.tags.edgeR = top.tags.edgeR,
               top.tags.limma = top.tags.limma,
               summary.numbers = summary.numbers)
  
  return(output)
}


######### DGF vs controls ##### 
DGF.HD = function(samples, # covariates = "nil", "organ", "multi"
                  counts,
                  covariates){
  
  # Sample data
  samples = samples[samples$dgf_define != "DGF.Cr",]
  samples$dgf_define = droplevels(samples$dgf_define)
  
  samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                  samples$subclin_1m == "No Subclin" &
                                  samples$subclin_1_3m == "No Subclin" & 
                                  samples$subclin_3m == "No Subclin", 
                                "No Subclin", "Subclin 0 - 3m")
  samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
  
  samples = samples %>%
    mutate(dsa.pre = ifelse(dsa1_pre ==0 & dsa2_pre ==0,  "No DSA", "DSA"))
  
  samples = samples %>%
    mutate(donor_criteria.dcd = ifelse(donor_criteria == "DCD" |
                                         donor_criteria == "DCD + ECD", 
                                       "DCD", "Not DCD"))
  
  samples = samples %>%  select(time, batch, Sample.Type, row.n, 
                                organ_type, donor_criteria,dsa.pre, 
                                dgf_define, dgf.severity, 
                                donor_criteria.dcd, graft_number, 
                                bpar_0_1m, bpar_1m, bpar_1_3m, bpar_3m,
                                bparupto03m, Subclin_0_1m, subclin_1m, 
                                subclin_1_3m, subclin_3m, subclin.0to3m, 
                                iIFTA_score_3m_meena1, iIFTA_score_12m_meena1, 
                                IFTA_score_3m_meena1, IFTA_score_12m_meena1)
  
  meta.sample = samples %>% mutate(samplename = rownames(samples))
  
  # Counts data
  counts = counts[,colnames(counts) %in% rownames(samples)]
  counts.sample = counts %>% mutate(ensg = rownames(counts))
  groups.sample = counts.sample %>% dplyr::filter(ensg %in% "ENSG00000237973")
  groups.sample = groups.sample %>% 
    gather(colnames(groups.sample[,-ncol(groups.sample)]), 
           key = "samplename", value = "normalized_counts")
  
  # Combine and prep  
  combine.sample.count = inner_join(meta.sample, groups.sample, by = "samplename")
  group.dgf = unlist(combine.sample.count[,which(colnames(combine.sample.count) == "dgf_define")])
  
  # Make DGElist
  dge.auscad = DGEList(counts = counts,
                       lib.size = colSums(counts),
                       norm.factors = rep(1,ncol(counts)),
                       samples = combine.sample.count,
                       group = group.dgf)
  
  # remove lowly expressed genes
  dge.auscad = dge.auscad[filterByExpr(dge.auscad, group=dge.auscad$samples$group), 
                          keep.lib.sizes = FALSE]
  
  # Calculate normalisation factors
  dge.auscad = calcNormFactors(dge.auscad, method = "TMM") 
  dge.auscad = dge.auscad[,which(!is.na(dge.auscad$samples$group))]
  dge.auscad$samples$group = as.factor(dge.auscad$samples$group)
  
    # Setting up the design matrix
    if(covariates == "nil"){
      # Design matrix without organ type in there as covariate
      design = model.matrix(~0 + group + batch , data= dge.auscad$samples)
      colnames(design) = gsub("group", "", colnames(design))
      colnames(design) = gsub("batch", "", colnames(design))
      colnames(design) =  gsub(" ", "", colnames(design))
    } else if (covariates == "organ") {
      # Design matrix without organ type in there as covariate
      design = model.matrix(~0 + group + batch + organ_type , data= dge.auscad$samples)
      colnames(design) = gsub("group", "", colnames(design))
      colnames(design) = gsub("batch", "", colnames(design))
      colnames(design) = gsub("organ_type", "", colnames(design))
      colnames(design) =  gsub(" ", "", colnames(design))
    } else if (covariates == "multi") {
      design = model.matrix(~0 + group + batch + 
                              organ_type + 
                              donor_criteria.dcd+
                              dsa.pre + 
                              graft_number, 
                            data= dge.auscad$samples)
      colnames(design) = gsub("group", "", colnames(design))
      colnames(design) = gsub("batch", "", colnames(design))
      colnames(design) = gsub("organ_type", "", colnames(design))
      colnames(design) = gsub("donor_criteria.dcd", "", colnames(design))
      colnames(design) = gsub("dsa.pre", "", colnames(design))
      colnames(design) = gsub("graft_number", "", colnames(design))
      colnames(design) =  gsub(" ", "", colnames(design))
    }
  
  design = design[,which(colSums(design) > 2)]
  con.mat = makeContrasts(DGF = DGF.HD - Control, levels = design)
  
  auscad.0m = estimateDisp(dge.auscad[,rownames(design)], design)
  glmfit.0m =  glmQLFit(auscad.0m, design)
  
  # EdgeR
  fit.0m = glmLRT(glmfit.0m, contrast = con.mat[,"DGF"])
  top.tags.edgeR = topTags(fit.0m,  n = Inf)
  summary(decideTests(fit.0m, adjust.method = "fdr", p.value = 0.05))
  top.tags.edgeR = as.data.frame(top.tags.edgeR) %>% 
    mutate(Symbol = rownames(top.tags.edgeR))
  top.tags.edgeR = top.tags.edgeR %>% mutate(Significant = FDR < 0.05)
  top.tags.edgeR = top.tags.edgeR %>% filter(FDR<0.05)
  
  if (nrow(top.tags.edgeR)>0){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(top.tags.edgeR), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    top.tags.edgeR = top.tags.edgeR[keep1,]
    top.tags.edgeR$symbol = Symbol.keep
    top.tags.edgeR$ensembl = rownames(top.tags.edgeR)}
  
  # Limma/ebayes  
  dds = voom(dge.auscad, design, plot=TRUE)
  fit = contrasts.fit(lmFit(dds, design), con.mat)
  efit = eBayes(fit, robust = FALSE)
  results = decideTests(efit, adjust.method = "BH", p.value = 0.05)
  top.tags.limma = topTable(efit, adjust.method="fdr", sort.by = "B", n = Inf)
  top.tags.limma = as.data.frame(top.tags.limma) %>% 
    mutate(Symbol = rownames(top.tags.limma))
  top.tags.limma = top.tags.limma %>% mutate(Significant = adj.P.Val < 0.05)
  top.tags.limma = top.tags.limma %>% filter(adj.P.Val < 0.05)
  
  if (nrow(top.tags.limma)>0){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(top.tags.limma), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    top.tags.limma = top.tags.limma[keep1,]
    top.tags.limma$symbol = Symbol.keep
    top.tags.limma$ensembl = rownames(top.tags.limma)}
  
  summary.numbers = data.frame(summary(dge.auscad$samples$group))
  
  setClass("dge.list",
           slots = c(top.tags.edgeR = "data.frame", 
                     top.tags.limma = "data.frame",
                     summary.numbers = "data.frame"),
           
           prototype = list(top.tags.edgeR = data.frame(), 
                            top.tags.limma = data.frame(),
                            summary.numbers = data.frame()))
  
  output = new("dge.list",
               top.tags.edgeR = top.tags.edgeR,
               top.tags.limma = top.tags.limma,
               summary.numbers = summary.numbers)
  
  return(output)
}

######### DGF vs SGF ##### 
DGF.HD.vs.Cr = function(samples, 
                        counts,
                        covariates){
  
  # Sample data
  samples = samples[samples$dgf_define != "Control",]
  samples$dgf_define = droplevels(samples$dgf_define)
  
  samples = samples %>%
    mutate(dsa.pre = ifelse(dsa1_pre ==0 & dsa2_pre ==0,  "No DSA", "DSA"))
  
  samples = samples %>%
    mutate(donor_criteria.dcd = ifelse(donor_criteria == "DCD" |
                                         donor_criteria == "DCD + ECD", 
                                       "DCD", "Not DCD"))
  
  samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                  samples$subclin_1m == "No Subclin" &
                                  samples$subclin_1_3m == "No Subclin" & 
                                  samples$subclin_3m == "No Subclin", 
                                "No Subclin", "Subclin 0 - 3m")
  samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
  
  samples = samples %>%  select(time, batch, Sample.Type, row.n, graft_number,
                                organ_type, donor_criteria,dsa.pre,
                                dgf_define, dgf.severity, donor_criteria.dcd,
                                bpar_0_1m, bpar_1m, bpar_1_3m, bpar_3m,
                                bparupto03m, Subclin_0_1m, subclin_1m, 
                                subclin_1_3m, subclin_3m, subclin.0to3m, 
                                iIFTA_score_3m_meena1, iIFTA_score_12m_meena1, 
                                IFTA_score_3m_meena1, IFTA_score_12m_meena1)
  
  meta.sample = samples %>% mutate(samplename = rownames(samples))
  
  # Counts data
  counts = counts[,colnames(counts) %in% rownames(samples)]
  counts.sample = counts %>% mutate(ensg = rownames(counts))
  groups.sample = counts.sample %>% dplyr::filter(ensg %in% "ENSG00000237973")
  groups.sample = groups.sample %>% 
    gather(colnames(groups.sample[,-ncol(groups.sample)]), 
           key = "samplename", value = "normalized_counts")
  
  # Combine and prep  
  combine.sample.count = inner_join(meta.sample, groups.sample, by = "samplename")
  group.dgf = unlist(combine.sample.count[,which(colnames(combine.sample.count) == "dgf_define")])
  
  # Make DGElist
  dge.auscad = DGEList(counts = counts,
                       lib.size = colSums(counts),
                       norm.factors = rep(1,ncol(counts)),
                       samples = combine.sample.count,
                       group = group.dgf)
  
  # remove lowly expressed genes
  dge.auscad = dge.auscad[filterByExpr(dge.auscad, group=dge.auscad$samples$group), 
                          keep.lib.sizes = FALSE]
  
  # Calculate normalisation factors
  dge.auscad = calcNormFactors(dge.auscad, method = "TMM") 
  dge.auscad = dge.auscad[,which(!is.na(dge.auscad$samples$group))]
  dge.auscad$samples$group = as.factor(dge.auscad$samples$group)
  
  # Setting up the design matrix
  if(covariates == FALSE){
    # Design matrix without organ type in there as covariate
    design = model.matrix(~0 + group + batch , data= dge.auscad$samples)
    colnames(design) = gsub("group", "", colnames(design))
    colnames(design) = gsub("batch", "", colnames(design))
    colnames(design) =  gsub(" ", "", colnames(design))
  } else if (covariates == TRUE) {
    # Design matrix without organ type in there as covariate
    design = model.matrix(~0 + group + batch + 
                            organ_type + 
                            donor_criteria.dcd+
                            dsa.pre + 
                            graft_number, 
                          data= dge.auscad$samples)
    colnames(design) = gsub("group", "", colnames(design))
    colnames(design) = gsub("batch", "", colnames(design))
    colnames(design) = gsub("organ_type", "", colnames(design))
    colnames(design) = gsub("donor_criteria.dcd", "", colnames(design))
    colnames(design) = gsub("dsa.pre", "", colnames(design))
    colnames(design) = gsub("graft_number", "", colnames(design))
    colnames(design) =  gsub(" ", "", colnames(design))
  }
  
  design = design[,which(colSums(design) > 2)]
  con.mat = makeContrasts(DGF = DGF.HD - DGF.Cr, levels = design)
  
  auscad.0m = estimateDisp(dge.auscad[,rownames(design)], design)
  glmfit.0m =  glmQLFit(auscad.0m, design)
  
  # EdgeR
  fit.0m = glmLRT(glmfit.0m, contrast = con.mat[,"DGF"])
  top.tags.edgeR = topTags(fit.0m,  n = Inf)
  summary(decideTests(fit.0m, adjust.method = "fdr", p.value = 0.05))
  top.tags.edgeR = as.data.frame(top.tags.edgeR) %>% 
    mutate(Symbol = rownames(top.tags.edgeR))
  top.tags.edgeR = top.tags.edgeR %>% mutate(Significant = FDR < 0.05)
  top.tags.edgeR = top.tags.edgeR %>% filter(FDR<0.05)
  
  if (nrow(top.tags.edgeR)>0){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(top.tags.edgeR), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    top.tags.edgeR = top.tags.edgeR[keep1,]
    top.tags.edgeR$symbol = Symbol.keep
    top.tags.edgeR$ensembl = rownames(top.tags.edgeR)}
  
  # Limma/ebayes  
  dds = voom(dge.auscad, design, plot=TRUE)
  fit = contrasts.fit(lmFit(dds, design), con.mat)
  efit = eBayes(fit, robust = FALSE)
  results = decideTests(efit, adjust.method = "BH", p.value = 0.05)
  top.tags.limma = topTable(efit, adjust.method="fdr", sort.by = "B", n = Inf)
  top.tags.limma = as.data.frame(top.tags.limma) %>% 
    mutate(Symbol = rownames(top.tags.limma))
  top.tags.limma = top.tags.limma %>% mutate(Significant = adj.P.Val < 0.05)
  top.tags.limma = top.tags.limma %>% filter(adj.P.Val < 0.05)
  
  if (nrow(top.tags.limma)>0){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(top.tags.limma), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    top.tags.limma = top.tags.limma[keep1,]
    top.tags.limma$symbol = Symbol.keep
    top.tags.limma$ensembl = rownames(top.tags.limma)}
  
  summary.numbers = data.frame(summary(dge.auscad$samples$group))
  
  setClass("dge.list",
           slots = c(top.tags.edgeR = "data.frame", 
                     top.tags.limma = "data.frame",
                     summary.numbers = "data.frame"),
           
           prototype = list(top.tags.edgeR = data.frame(), 
                            top.tags.limma = data.frame(),
                            summary.numbers = data.frame()))
  
  output = new("dge.list",
               top.tags.edgeR = top.tags.edgeR,
               top.tags.limma = top.tags.limma,
               summary.numbers = summary.numbers)
  
  return(output)
}

######### SGF vs controls ##### 
DGF.Cr.vs.Cont = function(samples, 
                          counts, 
                          covariates){
  
  # Sample data
  samples = samples[samples$dgf_define != "DGF.HD",]
  samples$dgf_define = droplevels(samples$dgf_define)
  
  samples = samples %>%
    mutate(dsa.pre = ifelse(dsa1_pre ==0 & dsa2_pre ==0,  "No DSA", "DSA"))
  
  samples = samples %>%
    mutate(donor_criteria.dcd = ifelse(donor_criteria == "DCD" |
                                         donor_criteria == "DCD + ECD", 
                                       "DCD", "Not DCD"))
  
  samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                  samples$subclin_1m == "No Subclin" &
                                  samples$subclin_1_3m == "No Subclin" & 
                                  samples$subclin_3m == "No Subclin", 
                                "No Subclin", "Subclin 0 - 3m")
  samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
  
  samples = samples %>%  select(time, batch, Sample.Type, row.n, graft_number,
                                organ_type, donor_criteria,dsa.pre,
                                dgf_define, dgf.severity, donor_criteria.dcd,
                                bpar_0_1m, bpar_1m, bpar_1_3m, bpar_3m,
                                bparupto03m, Subclin_0_1m, subclin_1m, 
                                subclin_1_3m, subclin_3m, subclin.0to3m, 
                                iIFTA_score_3m_meena1, iIFTA_score_12m_meena1, 
                                IFTA_score_3m_meena1, IFTA_score_12m_meena1)
  
  meta.sample = samples %>% mutate(samplename = rownames(samples))
  
  # Counts data
  counts = counts[,colnames(counts) %in% rownames(samples)]
  counts.sample = counts %>% mutate(ensg = rownames(counts))
  groups.sample = counts.sample %>% dplyr::filter(ensg %in% "ENSG00000237973")
  groups.sample = groups.sample %>% 
    gather(colnames(groups.sample[,-ncol(groups.sample)]), 
           key = "samplename", value = "normalized_counts")
  
  # Combine and prep  
  combine.sample.count = inner_join(meta.sample, groups.sample, by = "samplename")
  group.dgf = unlist(combine.sample.count[,which(colnames(combine.sample.count) == "dgf_define")])
  
  # Make DGElist
  dge.auscad = DGEList(counts = counts,
                       lib.size = colSums(counts),
                       norm.factors = rep(1,ncol(counts)),
                       samples = combine.sample.count,
                       group = group.dgf)
  
  # remove lowly expressed genes
  dge.auscad = dge.auscad[filterByExpr(dge.auscad, group=dge.auscad$samples$group), 
                          keep.lib.sizes = FALSE]
  
  # Calculate normalisation factors
  dge.auscad = calcNormFactors(dge.auscad, method = "TMM") 
  dge.auscad = dge.auscad[,which(!is.na(dge.auscad$samples$group))]
  dge.auscad$samples$group = as.factor(dge.auscad$samples$group)
  
  # Setting up the design matrix
  if(covariates == FALSE){
    # Design matrix without organ type in there as covariate
    design = model.matrix(~0 + group + batch , data= dge.auscad$samples)
    colnames(design) = gsub("group", "", colnames(design))
    colnames(design) = gsub("batch", "", colnames(design))
    colnames(design) =  gsub(" ", "", colnames(design))
  } else if (covariates == TRUE) {
    # Design matrix without organ type in there as covariate
    design = model.matrix(~0 + group + batch + 
                            organ_type + 
                            donor_criteria.dcd+
                            dsa.pre + 
                            graft_number, 
                          data= dge.auscad$samples)
    colnames(design) = gsub("group", "", colnames(design))
    colnames(design) = gsub("batch", "", colnames(design))
    colnames(design) = gsub("organ_type", "", colnames(design))
    colnames(design) = gsub("donor_criteria.dcd", "", colnames(design))
    colnames(design) = gsub("dsa.pre", "", colnames(design))
    colnames(design) = gsub("graft_number", "", colnames(design))
    colnames(design) =  gsub(" ", "", colnames(design))
  }
  
  design = design[,which(colSums(design) > 2)]
  con.mat = makeContrasts(DGF = DGF.Cr - Control, levels = design)
  
  auscad.0m = estimateDisp(dge.auscad[,rownames(design)], design)
  glmfit.0m =  glmQLFit(auscad.0m, design)
  
  # EdgeR
  fit.0m = glmLRT(glmfit.0m, contrast = con.mat[,"DGF"])
  top.tags.edgeR = topTags(fit.0m,  n = Inf)
  summary(decideTests(fit.0m, adjust.method = "fdr", p.value = 0.05))
  top.tags.edgeR = as.data.frame(top.tags.edgeR) %>% 
    mutate(Symbol = rownames(top.tags.edgeR))
  top.tags.edgeR = top.tags.edgeR %>% mutate(Significant = FDR < 0.05)
  top.tags.edgeR = top.tags.edgeR %>% filter(FDR<0.05)
  
  if (nrow(top.tags.edgeR)>0){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(top.tags.edgeR), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    top.tags.edgeR = top.tags.edgeR[keep1,]
    top.tags.edgeR$symbol = Symbol.keep
    top.tags.edgeR$ensembl = rownames(top.tags.edgeR)}
  
  # Limma/ebayes  
  dds = voom(dge.auscad, design, plot=TRUE)
  fit = contrasts.fit(lmFit(dds, design), con.mat)
  efit = eBayes(fit, robust = FALSE)
  results = decideTests(efit, adjust.method = "BH", p.value = 0.05)
  top.tags.limma = topTable(efit, adjust.method="fdr", sort.by = "B", n = Inf)
  top.tags.limma = as.data.frame(top.tags.limma) %>% 
    mutate(Symbol = rownames(top.tags.limma))
  top.tags.limma = top.tags.limma %>% mutate(Significant = adj.P.Val < 0.05)
  top.tags.limma = top.tags.limma %>% filter(adj.P.Val < 0.05)
  
  if (nrow(top.tags.limma)>0){
    Symbol = c()
    keep1 = c()
    Symbol = mapIds(org.Hs.eg.db, keys = rownames(top.tags.limma), 
                    keytype = "ENSEMBL",column = "SYMBOL", multiVals = "first")
    keep1 = which(!is.na(Symbol) & !duplicated(Symbol))
    Symbol.keep = Symbol[keep1]
    top.tags.limma = top.tags.limma[keep1,]
    top.tags.limma$symbol = Symbol.keep
    top.tags.limma$ensembl = rownames(top.tags.limma)}
  
  summary.numbers = data.frame(summary(dge.auscad$samples$group))
  
  setClass("dge.list",
           slots = c(top.tags.edgeR = "data.frame", 
                     top.tags.limma = "data.frame",
                     summary.numbers = "data.frame"),
           
           prototype = list(top.tags.edgeR = data.frame(), 
                            top.tags.limma = data.frame(),
                            summary.numbers = data.frame()))
  
  output = new("dge.list",
               top.tags.edgeR = top.tags.edgeR,
               top.tags.limma = top.tags.limma,
               summary.numbers = summary.numbers)
  
  return(output)
}

######### DGF severity ##### 
DGF.severity = function(samples, 
                        counts, 
                        covariates){
  
  # Sample data
  samples = samples[samples$dgf_define != "DGF.Cr",]
  samples$dgf_define = droplevels(samples$dgf_define)
  
  # rename from control, HD < 7 days, HD >= 7 days to following
  samples$dgf.severity = droplevels(samples$dgf.severity)
  levels(samples$dgf.severity) = c("Control", "shortDGF", "longDGF")
  
  samples = samples %>%
    mutate(dsa.pre = ifelse(dsa1_pre ==0 & dsa2_pre ==0,  "No DSA", "DSA"))
  
  samples = samples %>%
    mutate(donor_criteria.dcd = ifelse(donor_criteria == "DCD" |
                                         donor_criteria == "DCD + ECD", 
                                       "DCD", "Not DCD"))
  
  samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                  samples$subclin_1m == "No Subclin" &
                                  samples$subclin_1_3m == "No Subclin" & 
                                  samples$subclin_3m == "No Subclin", 
                                "No Subclin", "Subclin 0 - 3m")
  samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
  
  samples = samples %>%  select(time, batch, Sample.Type, row.n, 
                                organ_type, donor_criteria, graft_number,
                                dgf_define, dgf.severity, dsa.pre, donor_criteria.dcd,
                                bpar_0_1m, bpar_1m, bpar_1_3m, bpar_3m,
                                bparupto03m, Subclin_0_1m, subclin_1m, 
                                subclin_1_3m, subclin_3m, subclin.0to3m, 
                                iIFTA_score_3m_meena1, iIFTA_score_12m_meena1, 
                                IFTA_score_3m_meena1, IFTA_score_12m_meena1)
  
  meta.sample = samples %>% mutate(samplename = rownames(samples))
  
  # Counts data
  counts = counts[,colnames(counts) %in% rownames(samples)]
  counts.sample = counts %>% mutate(ensg = rownames(counts))
  groups.sample = counts.sample %>% dplyr::filter(ensg %in% "ENSG00000237973")
  groups.sample = groups.sample %>% 
    gather(colnames(groups.sample[,-ncol(groups.sample)]), 
           key = "samplename", value = "normalized_counts")
  
  # Combine and prep  
  combine.sample.count = inner_join(meta.sample, groups.sample, by = "samplename")
  group.dgf = unlist(combine.sample.count[,which(colnames(combine.sample.count) == "dgf.severity")])
  
  # Make DGElist
  dge.auscad = DGEList(counts = counts,
                       lib.size = colSums(counts),
                       norm.factors = rep(1,ncol(counts)),
                       samples = combine.sample.count,
                       group = group.dgf)
  
  # remove lowly expressed genes
  dge.auscad = dge.auscad[filterByExpr(dge.auscad, group=dge.auscad$samples$group), 
                          keep.lib.sizes = FALSE]
  
  # Calculate normalisation factors
  dge.auscad = calcNormFactors(dge.auscad, method = "TMM") 
  dge.auscad = dge.auscad[,which(!is.na(dge.auscad$samples$group))]
  dge.auscad$samples$group = as.factor(dge.auscad$samples$group)
  
  # Setting up the design matrix
  if(covariates == "nil"){
    # Design matrix without organ type in there as covariate
    design = model.matrix(~0 + group + batch , data= dge.auscad$samples)
    colnames(design) = gsub("group", "", colnames(design))
    colnames(design) = gsub("batch", "", colnames(design))
    colnames(design) =  gsub(" ", "", colnames(design))
  } else if (covariates == "organ") {
    # Design matrix without organ type in there as covariate
    design = model.matrix(~0 + group + batch + organ_type , data= dge.auscad$samples)
    colnames(design) = gsub("group", "", colnames(design))
    colnames(design) = gsub("batch", "", colnames(design))
    colnames(design) = gsub("organ_type", "", colnames(design))
    colnames(design) =  gsub(" ", "", colnames(design))
  } else if (covariates == "multi") {
    design = model.matrix(~0 + group + batch + 
                            organ_type + 
                            donor_criteria.dcd+
                            dsa.pre + 
                            graft_number, 
                          data= dge.auscad$samples)
    colnames(design) = gsub("group", "", colnames(design))
    colnames(design) = gsub("batch", "", colnames(design))
    colnames(design) = gsub("organ_type", "", colnames(design))
    colnames(design) = gsub("donor_criteria.dcd", "", colnames(design))
    colnames(design) = gsub("dsa.pre", "", colnames(design))
    colnames(design) = gsub("graft_number", "", colnames(design))
    colnames(design) =  gsub(" ", "", colnames(design))
  }
  
  design = design[,which(colSums(design) > 2)]
  con.mat = makeContrasts(shortDGF = shortDGF - Control, 
                          longDGF = longDGF - Control, 
                          betweenDGF = longDGF - shortDGF, 
                          levels = design)
  
  auscad.0m = estimateDisp(dge.auscad[,rownames(design)], design)
  glmfit.0m =  glmQLFit(auscad.0m, design)
  
  # EdgeR
  fit.short = glmLRT(glmfit.0m, contrast = con.mat[,"shortDGF"])
  fit.long = glmLRT(glmfit.0m, contrast = con.mat[,"longDGF"])
  fit.between = glmLRT(glmfit.0m, contrast = con.mat[,"betweenDGF"])
  top.tags.short.e = edgeR.tags(fit.short)
  top.tags.long.e = edgeR.tags(fit.long)
  top.tags.between.e = edgeR.tags(fit.between)
  
  # Limma/ebayes  
  dds = voom(dge.auscad, design, plot=TRUE)
  fit = contrasts.fit(lmFit(dds, design), con.mat)
  efit = eBayes(fit, robust = FALSE)
  results = decideTests(efit, adjust.method = "BH", p.value = 0.05)
  top.tags.short.l = limma.tags(efit, "shortDGF")
  top.tags.long.l = limma.tags(efit, "longDGF")
  top.tags.between.l = limma.tags(efit, "betweenDGF")
  
  summary.numbers = data.frame(summary(dge.auscad$samples$group))
  
  setClass("dge.list",
           slots = c(top.tags.short.e = "data.frame",
                     top.tags.long.e = "data.frame",
                     top.tags.between.e = "data.frame",
                     top.tags.short.l = "data.frame",
                     top.tags.long.l = "data.frame",
                     top.tags.between.l = "data.frame",
                     summary.numbers = "data.frame"),
           
           prototype = list(top.tags.short.e = data.frame(),
                            top.tags.long.e =data.frame(),
                            top.tags.between.e = data.frame(),
                            top.tags.short.l =data.frame(),
                            top.tags.long.l = data.frame(),
                            top.tags.between.l = data.frame(),
                            summary.numbers = data.frame()))
  
  output = new("dge.list",
               top.tags.short.e = top.tags.short.e,
               top.tags.long.e =top.tags.long.e,
               top.tags.between.e = top.tags.between.e,
               top.tags.short.l =top.tags.short.l,
               top.tags.long.l = top.tags.long.l,
               top.tags.between.l = top.tags.between.l,
               summary.numbers = summary.numbers)
  return(output) 
}

########################################################################
# function "dge.DGF.HD" = BASE DGE for DGF as main factor
# samples and counts matrix for data set
# organ.covariate = TRUE or FALSE (include organ.type (living donor) in design mat)
# rejection.factor = TRUE or FALSE (nil, subclin, bpar, any up to 3m)
########################################################################
dge.DGF.HD = function(samples, 
                      counts, 
                      covariates,
                      rejection.factor){
  
 
  if(rejection.factor == FALSE){
    output = DGF.HD(samples, counts, covariates)
  
  } else if(rejection.factor == TRUE) {
    
   samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                    samples$subclin_1m == "No Subclin" &
                                    samples$subclin_1_3m == "No Subclin" & 
                                    samples$subclin_3m == "No Subclin", 
                                  "No Subclin", "Subclin 0 - 3m")
    samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
    
    # For no rejection cohort
    samples.nil.reject = samples %>% 
      filter(subclin.0to3m == "No Subclin" & 
               bparupto03m == "No BPAR 0-3m")
    
      if(min(summary(samples.nil.reject$dgf_define)) < 3){ # min n = 3 per group
        output.no.rejection = c()
      } else { 
        output.no.rejection = DGF.HD(samples.nil.reject, counts, covariates)
      }
    
    output.no.rejection
    
    # Subclinical rejection only
    samples.subclin = samples %>% 
      filter(subclin.0to3m != "No Subclin" & 
               bparupto03m == "No BPAR 0-3m")  
    
    if(min(summary(samples.subclin$dgf_define)) < 3){
      output.subclin = c()
    } else { 
      output.subclin = DGF.HD(samples.subclin, counts, covariates)
    }
    
    # BPAR rejection only
    samples.bpar = samples %>% 
      filter(subclin.0to3m == "No Subclin" &
               bparupto03m != "No BPAR 0-3m")  
    
    if(min(summary(samples.bpar$dgf_define)) < 3){
      output.bpar = c()
    } else { 
      output.bpar = DGF.HD(samples.bpar, counts, covariates)
    }
    
    # any rejection 
    samples.any = samples %>% 
      filter(subclin.0to3m != "No Subclin" |
               bparupto03m != "No BPAR 0-3m")  
    
    if(min(summary(samples.any$dgf_define)) <3){
      output.any = c()
    } else { 
      output.any = DGF.HD(samples.any, counts, covariates)
    }

    output = list(no.reject = output.no.rejection, 
                  subclin.only = output.subclin, 
                  bpar.only = output.bpar, 
                  any.reject =output.any)
  }
  
  return(output)
  
}


######### DGF vs control for 1m samples ##### 
dge.DGF.HD.1m = function(samples, counts, 
                         covariates, 
                         rejection.factor){
  
  if(rejection.factor == FALSE){
    output = DGF.HD(samples, counts, covariates)
    
  } else if(rejection.factor == TRUE) {
    
    samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                    samples$subclin_1m == "No Subclin" &
                                    samples$subclin_1_3m == "No Subclin" & 
                                    samples$subclin_3m == "No Subclin", 
                                  "No Subclin", "Subclin 0 - 3m")
    samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
    
    # For no rejection cohort
    samples.nil.reject = samples %>% 
      filter(Subclin_0_1m == "No Subclin" & 
               bpar_0_1m == "No BPAR")
    
    if(min(summary(samples.nil.reject$dgf_define)) < 3){ # min n = 3 per group
      output.no.rejection = c()
    } else { 
      output.no.rejection = DGF.HD(samples.nil.reject, counts, covariates)
    }
    
    output.no.rejection
    
    # Subclinical rejection only
    samples.subclin = samples %>% 
      filter(Subclin_0_1m != "No Subclin" & 
               bparupto03m == "No BPAR 0-3m")  
    
    if(min(summary(samples.subclin$dgf_define)) < 3){
      output.subclin = c()
    } else { 
      output.subclin = DGF.HD(samples.subclin, counts, covariates)
    }
    
    # BPAR rejection only
    samples.bpar = samples %>% 
      filter(subclin.0to3m == "No Subclin" &
            bpar_0_1m != "No BPAR")  
    
    if(min(summary(samples.bpar$dgf_define)) < 3){
      output.bpar = c()
    } else { 
      output.bpar = DGF.HD(samples.bpar, counts, covariates)
    }
    
    # any rejection 
    samples.any = samples %>% 
      filter(subclin.0to3m != "No Subclin" |
               bparupto03m != "No BPAR 0-3m")  
    
    if(min(summary(samples.any$dgf_define)) <3){
      output.any = c()
    } else { 
      output.any = DGF.HD(samples.any, counts, covariates)
    }
    
    output = list(no.reject = output.no.rejection, 
                  subclin.only = output.subclin, 
                  bpar.only = output.bpar, 
                  any.reject =output.any)
  }
  
  return(output)
  
}

###############################################################
# DGE for DGF.severity, accounting for organ type 
# short = DGF < 7 days vs control, long = DGF > 7 days vs control
# between = DGF >7 vs <7 days
##############################################################
dge.DGF.severity = function(samples, 
                            counts, 
                            covariates,
                            rejection.factor){
  
  if(rejection.factor == FALSE){
    output = DGF.severity(samples, counts, covariates)
    
  } else if(rejection.factor == TRUE) {

    samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                    samples$subclin_1m == "No Subclin" &
                                    samples$subclin_1_3m == "No Subclin" & 
                                    samples$subclin_3m == "No Subclin", 
                                  "No Subclin", "Subclin 0 - 3m")
    samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
    
    # For no rejection cohort
    samples.nil.reject = samples %>%
      filter(subclin.0to3m == "No Subclin" &
               bparupto03m == "No BPAR 0-3m")
    
    check = c(summary(samples.nil.reject$dgf.severity)[1],
              summary(samples.nil.reject$dgf.severity)[4],
              summary(samples.nil.reject$dgf.severity)[5])

    if(min(check) < 3){ # min n = 3 per group
      output.no.rejection = c()
    } else { 
      output.no.rejection = DGF.severity(samples.nil.reject, counts, covariates)
    }
    
    # Subclinical rejection only
    samples.subclin = samples %>%
      filter(subclin.0to3m != "No Subclin" &
               bparupto03m == "No BPAR 0-3m")
    
    check = c(summary(samples.subclin$dgf.severity)[1],
              summary(samples.subclin$dgf.severity)[4],
              summary(samples.subclin$dgf.severity)[5])
    
    if(min(check) < 3){ # min n = 3 per group
      output.subclin = c()
    } else { 
      output.subclin = DGF.severity(samples.subclin, counts, covariates)
    }
    
    # BPAR rejection only
    samples.bpar = samples %>% 
      filter(subclin.0to3m == "No Subclin" &
               bparupto03m != "No BPAR 0-3m")  
    
    check = c(summary(samples.bpar$dgf.severity)[1],
              summary(samples.bpar$dgf.severity)[4],
              summary(samples.bpar$dgf.severity)[5])
    
    if(min(check) < 3){ # min n = 3 per group
      output.bpar = c()
    } else { 
      output.bpar = DGF.severity(samples.bpar, counts, covariates)
    }
    
    # any rejection
    samples.any = samples %>%
      filter(subclin.0to3m != "No Subclin" |
               bparupto03m != "No BPAR 0-3m")
    
    check = c(summary(samples.any$dgf.severity)[1],
              summary(samples.any$dgf.severity)[4],
              summary(samples.any$dgf.severity)[5])
    
    if(min(check) < 3){ # min n = 3 per group
      output.any = c()
    } else { 
      output.any = DGF.severity(samples.any, counts, covariates)
    }

    output = list(no.reject = output.no.rejection, 
                  subclin.only = output.subclin, 
                  bpar.only = output.bpar, 
                  any.reject = output.any)
  }
  
  return(output)
}


#########
dge.DGF.severity.1m = function(samples, counts, 
                               covariates,
                               rejection.factor){
  
  if(rejection.factor == FALSE){
    output = DGF.severity(samples, counts, covariates)
    
  } else if(rejection.factor == TRUE) {
    
    samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                    samples$subclin_1m == "No Subclin" &
                                    samples$subclin_1_3m == "No Subclin" & 
                                    samples$subclin_3m == "No Subclin", 
                                  "No Subclin", "Subclin 0 - 3m")
    samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
    
    # For no rejection cohort
    samples.nil.reject = samples %>%
      filter(subclin.0to3m == "No Subclin" &
               bparupto03m == "No BPAR 0-3m")
    
    check = c(summary(samples.nil.reject$dgf.severity)[1],
              summary(samples.nil.reject$dgf.severity)[4],
              summary(samples.nil.reject$dgf.severity)[5])
    
    if(min(check) < 3){ # min n = 3 per group
      output.no.rejection = c()
    } else { 
      output.no.rejection = DGF.severity(samples.nil.reject, counts, covariates)
    }
    
    # Subclinical rejection only
    samples.subclin = samples %>%
      filter(Subclin_0_1m != "No Subclin" &
               bparupto03m == "No BPAR 0-3m")
    
    check = c(summary(samples.subclin$dgf.severity)[1],
              summary(samples.subclin$dgf.severity)[4],
              summary(samples.subclin$dgf.severity)[5])
    
    if(min(check) < 3){ # min n = 3 per group
      output.subclin = c()
    } else { 
      output.subclin = DGF.severity(samples.subclin, counts, covariates)
    }
    
    # BPAR rejection only
    samples.bpar = samples %>% 
      filter(subclin.0to3m == "No Subclin" &
            bpar_0_1m != "No BPAR")  
    
    check = c(summary(samples.bpar$dgf.severity)[1],
              summary(samples.bpar$dgf.severity)[4],
              summary(samples.bpar$dgf.severity)[5])
    
    if(min(check) < 3){ # min n = 3 per group
      output.bpar = c()
    } else { 
      output.bpar = DGF.severity(samples.bpar, counts, covariates)
    }
    
    # any rejection
    samples.any = samples %>%
      filter(subclin.0to3m != "No Subclin" |
               bparupto03m != "No BPAR 0-3m")
    
    check = c(summary(samples.any$dgf.severity)[1],
              summary(samples.any$dgf.severity)[4],
              summary(samples.any$dgf.severity)[5])
    
    if(min(check) < 3){ # min n = 3 per group
      output.any = c()
    } else { 
      output.any = DGF.severity(samples.any, counts, covariates)
    }
    
    output = list(no.reject = output.no.rejection, 
                  subclin.only = output.subclin, 
                  bpar.only = output.bpar, 
                  any.reject = output.any)
  }
  
  return(output)
}


##########################################################################
# No rejection, account for organ type, DGF/control vs 12m mGFR 60 cutoff
##########################################################################
dge.DGF.mgfr = function(samples, 
                        counts, 
                        cutoff){
  # Sample data
  samples = samples[samples$dgf_define != "DGF.Cr",]
  samples$dgf_define = droplevels(samples$dgf_define)
  samples$dgf.severity = droplevels(samples$dgf.severity)
  
  # rename from control, HD < 7 days, HD >= 7 days to following
  levels(samples$dgf.severity) = c("Control", "shortDGF", "longDGF")
  
  samples = samples %>% filter( bparupto03m == "No BPAR 0-3m" &
                                  bpar_3_12m == "No BPAR" &
                                  bpar_12m == "No BPAR")  
  samples = samples %>% filter(bkvan_any1 == "No BKVAN")
  
  samples = samples %>%
    mutate(dsa.pre = ifelse(dsa1_pre ==0 & dsa2_pre ==0,  "No DSA", "DSA"))
  
  samples = samples %>%
    mutate(donor_criteria.dcd = ifelse(donor_criteria == "DCD" |
                                         donor_criteria == "DCD + ECD", 
                                       "DCD", "Not DCD"))
  
  samples$subclin.0to3m =ifelse(samples$Subclin_0_1m == "No Subclin" & 
                                  samples$subclin_1m == "No Subclin" &
                                  samples$subclin_1_3m == "No Subclin" & 
                                  samples$subclin_3m == "No Subclin", 
                                "No Subclin", "Subclin 0 - 3m")
  samples$subclin.0to3m = as.factor(samples$subclin.0to3m)
  
  
  samples = samples %>%  select(time, batch, Sample.Type, row.n, 
                                organ_type, donor_criteria,graft_number,
                                dgf_define, dgf.severity, mgfr_12m,
                                bpar_0_1m, bpar_1m, bpar_1_3m, bpar_3m,
                                bparupto03m, Subclin_0_1m, subclin_1m, 
                                subclin_1_3m, subclin_3m, dsa.pre,donor_criteria.dcd,
                                iIFTA_score_3m_meena1, iIFTA_score_12m_meena1, 
                                IFTA_score_3m_meena1, IFTA_score_12m_meena1)
  
  samples = samples %>%  
    mutate(dgf.function = 
             case_when(dgf_define == "Control" & mgfr_12m < cutoff ~ "Cont.mGFRlow",
                       dgf_define == "Control" & mgfr_12m >= cutoff ~ "Cont.mGFRhigh",
                       dgf_define == "DGF.HD" & mgfr_12m < cutoff ~ "DGF.mGFRlow",
                       dgf_define == "DGF.HD" & mgfr_12m >= cutoff ~ "DGF.mGFRhigh"))
  samples$dgf.function = as.factor(samples$dgf.function)
  
  meta.sample = samples %>% mutate(samplename = rownames(samples))
  
  # Counts data
  counts = counts[,colnames(counts) %in% rownames(samples)]
  counts.sample = counts %>% mutate(ensg = rownames(counts))
  groups.sample = counts.sample %>% dplyr::filter(ensg %in% "ENSG00000237973")
  groups.sample = groups.sample %>% 
    gather(colnames(groups.sample[,-ncol(groups.sample)]), 
           key = "samplename", value = "normalized_counts")
  
  
  # Combine and prep  
  combine.sample.count = inner_join(meta.sample, groups.sample, by = "samplename")
  group.dgf = unlist(combine.sample.count[,which(colnames(combine.sample.count) == "dgf.function")])
  
  # Make DGElist
  dge.auscad = DGEList(counts = counts,
                       lib.size = colSums(counts),
                       norm.factors = rep(1,ncol(counts)),
                       samples = combine.sample.count,
                       group = group.dgf)
  
  # remove lowly expressed genes
  dge.auscad = dge.auscad[filterByExpr(dge.auscad, group=dge.auscad$samples$group), 
                          keep.lib.sizes = FALSE]
  
  # Calculate normalisation factors
  dge.auscad = calcNormFactors(dge.auscad, method = "TMM") 
  dge.auscad = dge.auscad[,which(!is.na(dge.auscad$samples$group))]
  dge.auscad$samples$group = as.factor(dge.auscad$samples$group)
  
  # Design matrix without organ type in there as covariate
  design = model.matrix(~0 + group + batch + 
                          organ_type + 
                          donor_criteria.dcd+
                          dsa.pre + 
                          graft_number, 
                        data= dge.auscad$samples)
  colnames(design) = gsub("group", "", colnames(design))
  colnames(design) = gsub("batch", "", colnames(design))
  colnames(design) = gsub("organ_type", "", colnames(design))
  colnames(design) = gsub("donor_criteria.dcd", "", colnames(design))
  colnames(design) = gsub("dsa.pre", "", colnames(design))
  colnames(design) = gsub("graft_number", "", colnames(design))
  colnames(design) =  gsub(" ", "", colnames(design))
  
  design = design[,which(colSums(design) > 2)]
  con.mat = makeContrasts(mGFR = Cont.mGFRlow - Cont.mGFRhigh, 
                          mGFR.DGF = DGF.mGFRlow - Cont.mGFRhigh, 
                          mGFR.DGF.high = DGF.mGFRlow - DGF.mGFRhigh,
                          mGFR.DGF.low = DGF.mGFRhigh - Cont.mGFRhigh,
                          levels = design)
  
  auscad.0m = estimateDisp(dge.auscad[,rownames(design)], design)
  glmfit.0m =  glmQLFit(auscad.0m, design)
  
  # EdgeR
  fit.mGFR = glmLRT(glmfit.0m, contrast = con.mat[,"mGFR"])
  fit.mGFR.DGF = glmLRT(glmfit.0m, contrast = con.mat[,"mGFR.DGF"])
  fit.mGFR.DGF.high = glmLRT(glmfit.0m, contrast = con.mat[,"mGFR.DGF.high"])
  fit.mGFR.DGF.low = glmLRT(glmfit.0m, contrast = con.mat[,"mGFR.DGF.low"])
  top.tags.fit.mGFR.e = edgeR.tags(fit.mGFR)
  top.tags.mGFR.DGF.e = edgeR.tags(fit.mGFR.DGF)
  top.tags.mGFR.DGF.high.e = edgeR.tags(fit.mGFR.DGF.high)
  top.tags.mGFR.DGF.low.e = edgeR.tags(fit.mGFR.DGF.low)
  
  summary.numbers = data.frame(summary(dge.auscad$samples$group))
  
  setClass("dge.list",
           slots = c(control.lo.v.hi.mgfr = "data.frame", 
                     dgf.MGFRlo.v.cont.MGFRhi = "data.frame",
                     dgf.MGFRlo.vs.DGF.MGFR.hi = "data.frame",
                     DGF.MGFRhi.vs.cont.MGFRhi = "data.frame",
                     summary.numbers = "data.frame"),
           
           prototype = list(control.lo.v.hi.mgfr = data.frame(), 
                            dgf.MGFRlo.v.cont.MGFRhi = data.frame(),
                            dgf.MGFRlo.vs.DGF.MGFR.hi = data.frame(),
                            DGF.MGFRhi.vs.cont.MGFRhi = data.frame(),
                            summary.numbers = data.frame()))
  
  output = new("dge.list",
               control.lo.v.hi.mgfr = top.tags.fit.mGFR.e,
               dgf.MGFRlo.v.cont.MGFRhi = top.tags.mGFR.DGF.e,
               dgf.MGFRlo.vs.DGF.MGFR.hi = top.tags.mGFR.DGF.high.e,
               DGF.MGFRhi.vs.cont.MGFRhi = top.tags.mGFR.DGF.low.e,
              summary.numbers = summary.numbers)
  
  return(output)
}


###########
gene.by.edgeR = function(data1) {
  gene0 = c()
  gene0 = data1$logFC # the Log2FC
  names(gene0) = data1$Symbol # genes
  gene0 = sort(gene0, decreasing = TRUE) # sort decreasing order
  gene0 = gene0[!duplicated(names(gene0))]
  return(gene0)
}


###########3
go.gsea = function(data1, FC){
  
  Res = data1[abs(data1$logFC) > log2(FC),]$logFC
  names(Res) = data1[abs(data1$logFC) > log2(FC),]$ensembl
  Res = sort(Res, decreasing = TRUE)
  
  gse = gseGO(geneList=Res,
              ont ="ALL",
              keyType = "ENSEMBL",
              minGSSize = 3,
              maxGSSize = 8000,
              eps = 0,
              pvalueCutoff = 0.05,
              verbose = TRUE,
              seed = 23,
              OrgDb = org.Hs.eg.db)
  
  ggo.bp = filter(gse, p.adjust < 0.05, qvalues < 0.05)
  ggo.bp1 = as.data.frame(ggo.bp)
  
  ggo.bp1 = ggo.bp1 %>%
    dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(ggo.bp1, NES)
  
  ggo.bp1$Pathway.Direction = cut(-1*ggo.bp1$NES,
                                  c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  
  ggo.bp1$log.p.adj = ifelse(ggo.bp1$Pathway.Direction == "Suppressed",
                             -1*ggo.bp1$log.p.adj, ggo.bp1$log.p.adj)
  
  colnames(ggo.bp1)[4] = "Count"
  
  ggo.bp1 = removecrap(ggo.bp1)
  ggo.bp1 = pickrelevant(ggo.bp1)
  ggo.bp1 = trimmer(ggo.bp1)
  
  gselist = list("gsego.bp" = ggo.bp, 
                 "gsego.bp1" = ggo.bp1)
  return(gselist)
}


###################
# Biopsy kinetics
##################

bx.kinetics = function(data, dgf.groups, full.set, duration, facet){
  
  if (dgf.groups == "all") {dgf.filter1 = data 
  } else if (dgf.groups == "dgf") {
    dgf.filter1 = data[data$dgf_define != "DGF.Cr",]
  }
  
  dgf.filter1 = dgf.filter1[,c("Histo_ID", "dgf_define", "donor_criteria.main", 
                               "bpar_any1", "bparupto03m", 
                               "date_ibx1", "protocol_1m_date",
                               "i_0m", "t_0m", "ci_0m", "ct_0m",
                               "i_1m", "t_1m", "ci_1m", "ct_1m",
                               "i_3m", "t_3m", "ci_3m", "ct_3m", 
                               "i_12m", "t_12m", "ci_12m", "ct_12m", 
                               "i_ibx1", "t_ibx1", "ci_ibx1", "ct_ibx1", 
                               "i_ibx2", "t_ibx2", "ci_ibx2", "ct_ibx2", 
                               "i_ibx3", "t_ibx3", "ci_ibx3", "ct_ibx3")]
  
  if (duration == "12m") {
    ci.set = c("ci_0m", "delta.ci.01", "delta.ci.13", "delta.ci.312")
    ct.set = c("ct_0m", "delta.ct.01", "delta.ct.13","delta.ct.312")
    i.set = c("i_0m", "delta.i.01", "delta.i.13", "delta.i.312")
    t.set = c("t_0m", "delta.t.01", "delta.t.13", "delta.t.312")
    
    if (full.set == "full") {# Keep only subjects with all 0, 1, 3 and 12 month biopsies available
      dgf.filter2 = dgf.filter1 %>% filter(!is.na(i_0m) & !is.na(i_1m) & !is.na(i_3m)& !is.na(i_12m))
      dgf.filter2 = dgf.filter2 %>% filter(!is.na(t_0m) & !is.na(t_1m) & !is.na(t_3m)& !is.na(t_12m))
    } else {dgf.filter2 = dgf.filter1}
    
  } else if (duration == "3m") {
    ci.set = c("ci_0m", "delta.ci.01", "delta.ci.13")
    ct.set = c("ct_0m", "delta.ct.01", "delta.ct.13")
    i.set = c("i_0m", "delta.i.01", "delta.i.13")
    t.set = c("t_0m", "delta.t.01", "delta.t.13")
    
    if (full.set == "full") {# Keep only subjects with all 0, 1, 3 month biopsies available
      dgf.filter2 = dgf.filter1 %>% filter(!is.na(i_0m) & !is.na(i_1m) & !is.na(i_3m))
      dgf.filter2 = dgf.filter2 %>% filter(!is.na(t_0m) & !is.na(t_1m) & !is.na(t_3m))
    } else {dgf.filter2 = dgf.filter1}
    
  } else if (duration == "1m") {
    ci.set = c("ci_0m", "delta.ci.0i", "delta.ci.i1")
    ct.set = c("ct_0m", "delta.ct.0i", "delta.ct.i1")
    i.set = c("i_0m", "delta.i.0i", "delta.i.i1")
    t.set = c("t_0m", "delta.t.0i", "delta.t.i1")
    
    if (full.set == "full") {# Keep only subjects with all 0, 1, 3 month biopsies available
      dgf.filter2 = dgf.filter1 %>% filter(!is.na(i_0m) & !is.na(i_1m))
      dgf.filter2 = dgf.filter2 %>% filter(!is.na(t_0m) & !is.na(t_1m))
    } else {dgf.filter2 = dgf.filter1}
    
  } else {return("error - set duration 1m, 3m or 12m") }
  
  # Calculate delta scores  
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ci.01 = ci_1m - ci_0m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ci.13 = ci_3m - ci_1m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ci.312 = ci_12m - ci_3m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ct.01 = ct_1m - ct_0m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ct.13 = ct_3m - ct_1m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ct.312 = ct_12m - ct_3m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.i.01 = i_1m - i_0m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.i.13 = i_3m - i_1m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.i.312 = i_12m - i_3m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.t.01 = t_1m - t_0m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.t.13 = t_3m - t_1m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.t.312 = t_12m - t_3m)
  
  # If the 1-month was selection - keep indication bx if pre 1m
  dgf.filter2$keep.ibx1 = ifelse(difftime(dgf.filter2$protocol_1m_date, 
                                          dgf.filter2$date_ibx1) >0, "keep", NA)
  dgf.filter2$i_ibx1 = dgf.filter2$i_ibx1[dgf.filter2$keep.ibx1=="keep"]
  dgf.filter2$t_ibx1 = dgf.filter2$t_ibx1[dgf.filter2$keep.ibx1=="keep"]
  dgf.filter2$ci_ibx1 = dgf.filter2$ci_ibx1[dgf.filter2$keep.ibx1=="keep"]
  dgf.filter2$ct_ibx1 = dgf.filter2$ct_ibx1[dgf.filter2$keep.ibx1=="keep"]
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ci.0i = ci_ibx1 - ci_0m)
  dgf.filter2$ci_prev = ifelse(!is.na(dgf.filter2$ci_ibx1), dgf.filter2$ci_ibx1, dgf.filter2$ci_0m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ci.i1 = ci_1m - ci_prev)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ct.0i = ct_ibx1 - ct_0m)
  dgf.filter2$ct_prev = ifelse(!is.na(dgf.filter2$ct_ibx1), dgf.filter2$ct_ibx1, dgf.filter2$ct_0m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.ct.i1 = ct_1m - ct_prev)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.i.0i = i_ibx1 - i_0m)
  dgf.filter2$i_prev = ifelse(!is.na(dgf.filter2$i_ibx1), dgf.filter2$i_ibx1, dgf.filter2$i_0m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.i.i1 = i_1m - i_prev)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.t.0i = t_ibx1 - t_0m)
  dgf.filter2$t_prev = ifelse(!is.na(dgf.filter2$t_ibx1), dgf.filter2$t_ibx1, dgf.filter2$t_0m)
  dgf.filter2 = dgf.filter2 %>% mutate(delta.t.i1 = t_1m - t_prev)
  
  
  
  # Make pivot tables for plots
  dgf.filter3 = dgf.filter2 %>% 
    pivot_longer(cols = ci.set, names_to = "ci.delta", values_to = "ci.delta.scores")
  dgf.filter3$ci.delta = as.factor(dgf.filter3$ci.delta)
  dgf.filter3$ci.delta = factor(dgf.filter3$ci.delta, levels=ci.set)
  
  dgf.filter4 = dgf.filter2 %>% 
    pivot_longer(cols = ct.set, names_to = "ct.delta", values_to = "ct.delta.scores")
  dgf.filter4$ct.delta = as.factor(dgf.filter4$ct.delta)
  dgf.filter4$ct.delta = factor(dgf.filter4$ct.delta, levels=ct.set)
  
  dgf.filter5 = dgf.filter2 %>% 
    pivot_longer(cols = i.set,names_to = "i.delta", values_to = "i.delta.scores")
  dgf.filter5$i.delta = as.factor(dgf.filter5$i.delta)
  dgf.filter5$i.delta = factor(dgf.filter5$i.delta, levels=i.set)
  
  dgf.filter6 = dgf.filter2 %>% 
    pivot_longer(cols = t.set,names_to = "t.delta", values_to = "t.delta.scores")
  dgf.filter6$t.delta = as.factor(dgf.filter6$t.delta)
  dgf.filter6$t.delta = factor(dgf.filter6$t.delta,  levels=t.set)
  
  # Plot function
  plot.bx = function(data, type, title) {
    if (type == "ci"){  g1 = ggplot(data,  aes(x = ci.delta, y = ci.delta.scores, group = Histo_ID))
    } else if (type == "ct") {g1 = ggplot(data,  aes(x = ct.delta, y = ct.delta.scores, group = Histo_ID))
    } else if (type == "i") {g1 = ggplot(data,  aes(x = i.delta, y = i.delta.scores, group = Histo_ID))  
    } else if (type == "t") { g1 = ggplot(data,  aes(x = t.delta, y = t.delta.scores, group = Histo_ID))
    } else {(return ("error type: ci, ct, i, t"))}
    
    g1 + geom_jitter(aes(colour = dgf_define), width = 0.2, alpha = 0.5, size = 0.6) +
      stat_summary(fun.y = mean, geom = 'point',
                   aes(group = dgf_define, colour = dgf_define),
                   position = position_dodge(0.3)) + 
      stat_summary(fun.y = mean, geom = 'pointrange',
                   fun.ymax = function(x) mean(x) + sd(x),
                   fun.ymin = function(x) mean(x) - sd(x),
                   aes(group = dgf_define, colour = dgf_define), 
                   position = position_dodge(0.3)) + ylim(c(-1,3)) +
      stat_compare_means(aes(group = dgf_define), label = "p.format", label.y = c(2.6), size = 4)+
      theme_bw() + ggtitle(title)+ ylab("Delta scores: current - previous")}
  
  if (facet == "facet"){
    plot.ci = plot.bx(dgf.filter3, "ci", "CI scores") +
      facet_grid(dgf.filter3$donor_criteria.main~dgf.filter3$bpar_any1)
    plot.ct = plot.bx(dgf.filter4, "ct", "CT scores")+
      facet_grid(dgf.filter4$donor_criteria.main~dgf.filter4$bpar_any1)
    plot.i = plot.bx(dgf.filter5, "i", "I scores" )+
      facet_grid(dgf.filter5$donor_criteria.main~dgf.filter5$bpar_any1)
    plot.t = plot.bx(dgf.filter6, "t", "T scores" )+
      facet_grid(dgf.filter6$donor_criteria.main~dgf.filter6$bpar_any1)
  } else {
    plot.ci = plot.bx(dgf.filter3, "ci", "CI scores") 
    plot.ct = plot.bx(dgf.filter4, "ct", "CT scores")
    plot.i = plot.bx(dgf.filter5, "i", "I scores" )
    plot.t = plot.bx(dgf.filter6, "t", "T scores" )
  }
  
  plots = list(plot.i, plot.t, plot.ci, plot.ct)
  
  return(plots)
}


```

### Spatial related set up files

This chunk has setup.spatial.packages.R and setup.spatial.functions.R files combined
```{r, echo=TRUE, results = FALSE, warning = FALSE, eval = FALSE}

library(BiocParallel)
library(BiocManager)

packagesload = c()
packagesload = c("tidyverse", "dplyr", "readxl", "ggpubr", "graphics", "Gmisc", "knitr", "table1", 
                 "MatchIt", "htmlTable", "magrittr", "survminer", "survival", "lattice", "rstatix", 
                 "viridis", "pROC",  "reshape2", "rcompanion", "edgeR", "limma", "Glimma", "parallel",
                 "AnnotationDbi", "GOexpress", "Matrix", "org.Hs.eg.db", "org.Mm.eg.db", "ggfortify", 
                 "RColorBrewer", "mixOmics", "VennDiagram", "monocle", "Rtsne", "gplots", "ggplot2", 
                 "NMF", "EnhancedVolcano", "calibrate", "pheatmap", "vsn", "Seurat", "SeuratObject", 
                 "patchwork", "PCAtools", "rrcov", "pcaExplorer", "usethis", "devtools", "ComICS",
                 "pathview", "rjson","cowplot", "grid", "readbitmap", "rhdf5", "hdf5r", "data.table", 
                 "tibble", "clusterProfiler", "ReactomePA", "pathview", "enrichplot", "DOSE", 
                 "stringr", "gridExtra", "Rcpp", "NMF", "kableExtra", "imager",  "spdep", 
                 "pathfindR", "topGO", "biomaRt", "STdeconvolve", "STutility", "SpatialCPie", 
                 "clustree", "pander", "pagoda2", "harmony", "SingleCellExperiment", "SCINA", 
                 "ggcorrplot", "SpatialExperiment", "TENxVisiumData", "devtools", "FSA", 
                 "superheat", "beachmat", "SPOTlight", "scran", "directPA","scuttle",
                 "shiny", "xtable","S4Vectors", "MASS", "Giotto", "Nebulosa","scmap","GEOquery",
                 "singleCellHaystack", "NMF", "gt", "igraph", "GOplot", "ggnewscale", "ggvenn",  
                 "forcats", "stringr", "ggrepel", "readr", "tidyr", "XML", "harmony", "SingleR", 
                 "celldex", "SingleCellExperiment", "SCINA", "shiny", "ggVennDiagram")

# Install packages not yet installed, then load
installed_packages = packagesload %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packagesload[!installed_packages], dependencies = TRUE)}
invisible(lapply(packagesload, library, character.only = TRUE))

pkg.versions = data.frame(packagesload)
colnames(pkg.versions) = "packages.used"
pkg.versions$version = "NA"
for (i in 1:length(pkg.versions$packages.used)){
  pkg.versions[i,]$version = package.version(pkg.versions[i,]$packages.used)}

n = 20
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

heatmap.colors = c("lightgray", "mistyrose", "red", "darkred", "black")


####################################################
### CUSTOM FUNCITONS FOR SPATIAL
###################################################

######### Features for each spot and sample ############
se_features = function(se) {
  se_feat = c()
  se_feat = as.data.frame(levels(as.factor(se@meta.data$sample_id)))
  colnames(se_feat) = "sample"
  
  s1 = 1:length(levels(as.factor(se@meta.data$sample_id)))
  se_descrip = c()
  se_descrip1 = c()
  se_fspot=c()
  se_fnumi=c()
  se_fncount=c()
  se_ffeat=c()
  
  for (i in s1){
    se_descrip[[i]] = levels(as.factor(se@meta.data$treatment[
      se@meta.data$sample_id == (paste0("section_",i,sep=""))]))
    se_descrip1[[i]] = eval(parse(text = paste0("se_descrip.",i, sep = "")))
    se_fspot[[i]] = c(nrow(se_descrip1[[i]]@meta.data))
    se_fnumi[[i]] = c(median(se_descrip1[[i]]@meta.data$nCount_RNA))
    se_fncount[[i]] = c(median(se_descrip1[[i]]@meta.data$nCount_SCT))
    se_ffeat[[i]] =c(median(se_descrip1[[i]]@meta.data$nFeature_SCT)) }
  
  se_feat$treatment = unlist(se_descrip)
  se_feat$spots=unlist(se_fspot)
  se_feat$uMI=unlist(se_fnumi)
  se_feat$nCount=unlist(se_fncount)
  se_feat$nFeature=unlist(se_ffeat)
  return(se_feat)}

############ Number of spots per cluster ###################
clustspots = function(se) {
  clust_feat = c()
  clust_feat = as.data.frame(levels(se@meta.data$seurat_clusters))
  colnames(clust_feat) = "clusters"
  
  spot1 = c()
  # for overall
  t1 = 1: nrow(clust_feat)
  for (i in t1){
    spot1[[i]] = length(which(se@meta.data$seurat_clusters==(i-1))==TRUE) }
  
  clust_feat$all = unlist(spot1)
  
  # now adding new column per sample
  samp=c()
  spot2=c()
  store =c()
  rename = c()
  t2 = 1: length(levels(as.factor(se@meta.data$slide)))
  for (j in t2) {
    samp[[j]] = levels(as.factor(se@meta.data$slide))[j]
    for (i in t1){
      spot2[[i]] = length(which(se@meta.data$seurat_clusters==(i-1) & 
                                  se@meta.data$slide == samp[[j]])==TRUE)}
    rename = c(names(clust_feat), samp[[j]])
    clust_feat = cbind(clust_feat, unlist(spot2))
    names(clust_feat) = rename}
  return(clust_feat)}

############ stats for each clust vs rest of tissue ##############
clustvsrest = function(se, threshold){
  se.markers = c()
  se.markers = FindAllMarkers(se, only.pos = FALSE, min.pct = 0.05, test.use = "wilcox",
                              logfc.threshold = threshold, seed.use = 42)
  
  se.markers.up = c()
  se.markers.up = se.markers[which(se.markers$avg_log2FC>0), ]
  
  se.markers.down = c()
  se.markers.down = se.markers[which(se.markers$avg_log2FC<0), ]
  
  top5 = se.markers.up %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC) 
  top10 =se.markers.up %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
  top20 =se.markers.up %>% group_by(cluster) %>% top_n(n = 20, wt = avg_log2FC)
  
  se.up1 = ElbowPlot(se)
  se.up2 = VizDimLoadings(se, dims = 1:2, reduction = "pca")
  se.up3 =DimPlot(se, reduction = "tsne", split.by = "treatment", ncol = 3, 
                  label = TRUE) +theme_pubr(legend = "right") 
  se.up4 =DimPlot(se, reduction = "umap", split.by = "treatment", ncol = 3, 
                  label = TRUE) +theme_pubr(legend = "right") 
  
  plotup1= ggarrange(se.up1, se.up2, common.legend = TRUE, legend = "right",ncol = 2, nrow = 1)
  plotup2= ggarrange(se.up3, se.up4, common.legend = TRUE, legend = "right",ncol = 2, nrow = 1)
  
  # Cluster vs rest tissue (UP)
  clust_restup = c()
  clust_restup = as.data.frame(levels(se.markers.up$cluster))
  colnames(clust_restup) = "clust vs rest (up)"
  
  up = c()
  top10gene=c()
  t3=c()
  t3 = 1: nrow(clust_restup)
  for (i in t3){
    up[[i]] = length(which(se.markers.up$cluster==(i-1))==TRUE)
    top10gene[[i]] = paste0(unlist(top10$gene[which(top10$cluster==(i-1))]), sep="") }
  
  clust_restup$up = unlist(up)
  clust_restup$top10 = top10gene
  
  setClass("clustrestup", 
           slots = c(clustvsrestup = "data.frame", compstat = "data.frame"), 
           prototype = list(clustvsrestup = data.frame(), compstat = data.frame()))
  
  clust.restup = new("clustrestup",
                     clustvsrestup = se.markers.up,
                     compstat = clust_restup)
  
  # Cluster vs rest tissue (DOWN)
  clust_restdown = c()
  clust_restdown = as.data.frame(levels(se.markers.down$cluster))
  colnames(clust_restdown) = "clust vs rest (down)"
  down = c()
  top10gene=c()
  top10 =c()
  top10 = se.markers.down %>% group_by(cluster) %>% top_n(n = 10, wt = abs(avg_log2FC))
  t3=c()
  t3 = 1: nrow(clust_restdown)
  for (i in t3){
    down[[i]] = length(which(se.markers.down$cluster==(i-1))==TRUE)
    top10gene[[i]] = paste0(unlist(top10$gene[which(top10$cluster==(i-1))]), sep="")
  }
  
  clust_restdown$down = unlist(down)
  clust_restdown$top10 = top10gene
  
  setClass("clustrestdown", 
           slots = c(clustvsrestdown = "data.frame", compstat = "data.frame"), 
           prototype = list(clustvsrestdown = data.frame(), compstat = data.frame()))
  
  clust.restdown = new("clustrestdown",
                       clustvsrestdown = se.markers.down,
                       compstat = clust_restdown)
  
  clustvsrestlist = list(se.markers, se.markers.up, se.markers.down, 
                         plotup1, plotup2, clust.restup, clust.restdown)
  
  return(clustvsrestlist)
}

############# Cluster at the full set of resolutions ################
clustpack = function(se) {
  se = RunPCA(se, assay = "SCT", verbose = FALSE, seed.use = 42)
  se = FindNeighbors(se, reduction = "pca", dims = 1:10, seed.use = 42) #SNN
  se = FindClusters(se, verbose = FALSE, resolution = 
                      c(0.1, 0.2, 0.3, 0.4, 0.6, 0.8, 1, 1.2), seed.use = 42) 
  se = RunTSNE(se, reduction = "pca", dims =1:10, seed.use = 42)
  se = RunUMAP(se, reduction = "pca", dims = 1:10, seed.use = 42) # optimise
  # se = RunUMAP(object = se, dims = 1:40, verbose = FALSE, n.components = 6, 
  #               reduction = "pca", reduction.name="umap.3d")
  return(se)
}

################ Cluster at specific resolution ##################
clustpackres = function(se, resolution) {
  se = RunPCA(se, assay = "SCT", verbose = FALSE, seed.use = 42)
  se = FindNeighbors(se, reduction = "pca", dims = 1:10, seed.use = 42) #SNN
  se = FindClusters(se, verbose = FALSE, resolution = c(resolution), seed.use = 42) 
  se = RunTSNE(se, reduction = "pca", dims =1:10, seed.use = 42)
  se = RunUMAP(se, reduction = "pca", dims = 1:10, seed.use = 42) # optimise
  # se = RunUMAP(object = se, dims = 1:40, verbose = FALSE, n.components = 6, 
  #               reduction = "pca", reduction.name="umap.3d")
  return(se)
}

############# CLUSTERING RESOLUTION - optimise for low res ##############
clustresolve = function(se){
  se.2=c()
  se.2 = FindClusters(se, resolution = 0, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 0.1, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 0.2, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 0.3, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 0.4, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 0.6, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 0.8, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 1, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 1.2, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 1.4, random.seed = 42)
  se.2 = FindClusters(se.2, resolution = 1.6, random.seed = 42)
  
  se.2 = RunUMAP(se.2, reduction = "pca", dims = 1:10)
  
  s0 = DimPlot(se.2, reduction = "umap", group.by = "SCT_snn_res.0") + ggtitle("res = 0")
  s0.1 = DimPlot(se.2, reduction = "umap", group.by = "SCT_snn_res.0.1") + ggtitle("res = 0.1")
  s0.2 = DimPlot(se.2, reduction = "umap", group.by =  "SCT_snn_res.0.2") + ggtitle("res = 0.2")
  s0.3 = DimPlot(se.2, reduction = "umap", group.by =  "SCT_snn_res.0.3") + ggtitle("res = 0.3")
  s0.4 = DimPlot(se.2, reduction = "umap", group.by = "SCT_snn_res.0.4") + ggtitle("res = 0.4")
  s0.6 = DimPlot(se.2, reduction = "umap", group.by = "SCT_snn_res.0.6") + ggtitle("res = 0.6")
  s0.8 = DimPlot(se.2, reduction = "umap", group.by = "SCT_snn_res.0.8") + ggtitle("res = 0.8")
  s1 = DimPlot(se.2, reduction = "umap", group.by = "SCT_snn_res.1") + ggtitle("res = 1")
  s1.2 = DimPlot(se.2, reduction = "umap", group.by =  "SCT_snn_res.1.2") + ggtitle("res = 1.2")
  s1.4 = DimPlot(se.2, reduction = "umap", group.by =  "SCT_snn_res.1.4") + ggtitle("res = 1.4")
  s1.6 = DimPlot(se.2, reduction = "umap", group.by = "SCT_snn_res.1.6") + ggtitle("res = 1.6")
  
  # # Multi plot for a selection
  (s0.2 + s0.4+ s0.6)/ (s0.8+s1 + s1.2)
  
  clust_se = c()
  clust_se = clustree(se.2, prefix = "SCT_snn_res.", layout = "tree",
                      node_colour = "sc3_stability", node_text_colour = "white",
                      edge_width = 1, node_label_size = 5, edge_arrow = FALSE)
  c1=clust_se
  
  # # highest avg sc3_stabaility score ~ which of the possible clustering resolutions is the most stable 
  stability_se = c()
  stability_se = clust_se$data[,c("SCT_snn_res.", "sc3_stability")]
  stability_se = stability_se[stability_se$SCT_snn_res. %in%
                                names(which(table(stability_se$SCT_snn_res.) > 1)), ]
  
  stability_se.summary = c()
  stability_se.summary = as.data.frame(stability_se %>%
                                         group_by(SCT_snn_res.) %>%
                                         summarize(mean = mean(sc3_stability),
                                                   median = median(sc3_stability),
                                                   sd = sd(sc3_stability),
                                                   min = min(sc3_stability),
                                                   max = max(sc3_stability),
                                                   cv = sd(sc3_stability)/mean(sc3_stability)))
  
  rownames(stability_se.summary) = stability_se.summary$SCT_snn_res.
  stability_se.summary$SCT_snn_res. = NULL
  
  # 
  bestres_se_mean = c()
  bestres_se_med = c()
  bestres_se_lowCV = c()
  bestres_se_mean = rownames(stability_se.summary)[which.max(stability_se.summary$mean)]
  bestres_se_med = rownames(stability_se.summary)[which.max(stability_se.summary$median)]
  bestres_se_lowCV = rownames(stability_se.summary)[which.min(stability_se.summary$cv)]
  
  s1= emphasize.strong.rows(which.max(stability_se.summary$mean))
  
  p1= pander(stability_se.summary, split.cells = 5, split.table = Inf,
             caption = 'Spot per section', label = '10', digits = 2,justify ='center')
  
  # # Optimal resolution is subjective: combine biological info and stats (higher median and lower spread of data - so check median for central tendency for the non-normally distributed data)
  stability_se %>% ggplot(aes(SCT_snn_res., sc3_stability)) + geom_boxplot()+ ggtitle("Batch") +scale_y_continuous(trans='log2')+theme_pubclean()
  
  # and simplistic check to elbow plot
  e1= ElbowPlot(se)
  
  listse2 = list(se.2, p1, e1, s1, c1)
  return(listse2)
}


# ENRICHMENTS
############## pre-process the clust vs rest #######################
#  (target = cluster of interest, data1 = dataframe se.clust etc)
clustall = function(data1, target1) {
  clust = c()
  clust = data1[data1$cluster==target1,]
  clust$symbol = clust$gene
  clust$ensembl = gene.conversions$ensembl[match(clust$gene, gene.conversions$symbol)]
  # # clust$rank = clust$avg_log2FC * (-log10(clust$p_val_adj))
  # # clust$rank = ifelse(clust$rank == "Inf", 10^6, clust$rank)
  # clust = clust[order(-clust$avg_log2FC),]
  # clust = clust[!duplicated(clust$gene),]
  # if (nrow(clust) < 500) {
  #   entz=c()
  #   entz = mapIds(org.Mm.eg.db, keys=clust$ensembl, column="ENTREZID", keytype="ENSEMBL", multiVals="first")
  #   clust = cbind(clust, ENTREZID = entz)
  #   } else {
  #     entz=c()
  #     entz = bitr(clust$ensembl, fromType = "ENSEMBL", toType ="ENTREZID", OrgDb = org.Mm.eg.db, drop = FALSE)
  #     entz = entz[!duplicated(entz$ENSEMBL),]
  #     clust$ENTREZID = entz$ENTREZID
  #     }
  return(clust)
}

clustall1 = function(data1, target1) {
  clust = c()
  clust = data1[data1$cluster==target1,]
  clust$symbol = clust$gene
  clust$ensembl = gene.conversions$ensembl[match(clust$gene, gene.conversions$symbol)]
  # clust$rank = clust$avg_log2FC * (-log10(clust$p_val_adj))
  # clust$rank = ifelse(clust$rank == "Inf", 10^6, clust$rank)
  clust = clust[order(-clust$avg_log2FC),]
  clust = clust[!duplicated(clust$gene),]
  if (nrow(clust) < 500) {
    entz=c()
    entz = mapIds(org.Mm.eg.db, keys=clust$ensembl, column="ENTREZID", keytype="ENSEMBL", multiVals="first")
    clust = cbind(clust, ENTREZID = entz)
  } else {
    
    clust$ENTREZID = NA
  }
  return(clust)
}

############ Cluster vs rest (DGE - UP) ################
clustrestup = function(data1, target1) {
  clust = c()
  clust = data1@clustvsrestup[data1@clustvsrestup$cluster==target1,]
  clust$symbol = clust$gene
  clust$ensembl = gene.conversions$ensembl[match(clust$gene, gene.conversions$symbol)]
  # clust$rank = clust$avg_log2FC * (-log10(clust$p_val_adj))
  # clust$rank = ifelse(clust$rank == "Inf", 10^6, clust$rank)
  clust = clust[order(-clust$avg_log2FC),]
  clust = clust[!duplicated(clust$gene),]
  if (nrow(clust) < 500) {
    entz=c()
    entz = mapIds(org.Mm.eg.db, keys=clust$ensembl, column="ENTREZID", keytype="ENSEMBL", multiVals="first")
    clust = cbind(clust, ENTREZID = entz)
  } else {
    entz=c()
    entz = bitr(clust$ensembl, fromType = "ENSEMBL", toType ="ENTREZID", OrgDb = org.Mm.eg.db, drop = FALSE)
    entz = entz[!duplicated(entz$ENSEMBL),]
    clust$ENTREZID = entz$ENTREZID
  }
  return(clust)
}


clustrestup1 = function(data1, target1) {
  clust = c()
  clust = data1[data1$cluster==target1,]
  clust$symbol = clust$gene
  clust$ensembl = gene.conversions$ensembl[match(clust$gene, gene.conversions$symbol)]
  # clust$rank = clust$avg_log2FC * (-log10(clust$p_val_adj))
  # clust$rank = ifelse(clust$rank == "Inf", 10^6, clust$rank)
  clust = clust[order(-clust$avg_log2FC),]
  clust = clust[!duplicated(clust$gene),]
  if (nrow(clust) < 500) {
    entz=c()
    entz = mapIds(org.Mm.eg.db, keys=clust$ensembl, column="ENTREZID", keytype="ENSEMBL", multiVals="first")
    clust = cbind(clust, ENTREZID = entz)
  } else {
    entz=c()
    entz = bitr(clust$ensembl, fromType = "ENSEMBL", toType ="ENTREZID", OrgDb = org.Mm.eg.db, drop = FALSE)
    entz = entz[!duplicated(entz$ENSEMBL),]
    clust$ENTREZID = entz$ENTREZID
  }
  return(clust)
}

############ Cluster vs rest (DGE - DOWN) ################
clustrestdown = function(data1, target1) {
  clust = c()
  clust = data1@clustvsrestdown[data1@clustvsrestdown$cluster==target1,]
  clust$symbol = clust$gene
  clust$ensembl = gene.conversions$ensembl[match(clust$gene, gene.conversions$symbol)]
  # clust$rank = clust$avg_log2FC * (-log10(clust$p_val_adj))
  #   clust$rank = ifelse(clust$rank == "Inf", 10^6, clust$rank)
  clust = clust[order(-clust$avg_log2FC),]
  clust = clust[!duplicated(clust$gene),]
  if (nrow(clust) < 500) {
    entz=c()
    entz = mapIds(org.Mm.eg.db, keys=clust$ensembl, column="ENTREZID", keytype="ENSEMBL", multiVals="first")
    clust = cbind(clust, ENTREZID = entz)
  } else {
    entz=c()
    entz = bitr(clust$ensembl, fromType = "ENSEMBL", toType ="ENTREZID", OrgDb = org.Mm.eg.db, drop = FALSE)
    entz = entz[!duplicated(entz$ENSEMBL),]
    clust$ENTREZID = entz$ENTREZID
  }
  return(clust)
}

clustrestdown1 = function(data1, target1) {
  clust = c()
  clust = data1[data1$cluster==target1,]
  clust$symbol = clust$gene
  clust$ensembl = gene.conversions$ensembl[match(clust$gene, gene.conversions$symbol)]
  # clust$rank = clust$avg_log2FC * (-log10(clust$p_val_adj))
  # clust$rank = ifelse(clust$rank == "Inf", 10^6, clust$rank)
  clust = clust[order(-clust$avg_log2FC),]
  clust = clust[!duplicated(clust$gene),]
  if (nrow(clust) < 500) {
    entz=c()
    entz = mapIds(org.Mm.eg.db, keys=clust$ensembl, column="ENTREZID", keytype="ENSEMBL", multiVals="first")
    clust = cbind(clust, ENTREZID = entz)
  } else {
    entz=c()
    entz = bitr(clust$ensembl, fromType = "ENSEMBL", toType ="ENTREZID", OrgDb = org.Mm.eg.db, drop = FALSE)
    entz = entz[!duplicated(entz$ENSEMBL),]
    clust$ENTREZID = entz$ENTREZID
  }
  return(clust)
}


######## Pairwise cluster - pre-process (data 1 and target 1 = same number) ############
clustpwup = function(data1, target1, target2) {
  clust.pair = c()
  clust.pair = slot(data1, paste0("comp", target1, "vs", target2, sep  = ""))
  clust.pair = clust.pair[(clust.pair$avg_log2FC > 0),] # up (change to < 0 if down)
  clust.pair$gene = rownames(clust.pair)
  clust.pair$symbol = clust.pair$gene
  clust.pair$ensembl =  gene.conversions$ensembl[match(clust.pair$gene, gene.conversions$symbol)]
  # clust.pair$rank = clust.pair$avg_log2FC * (-log10(clust.pair$p_val_adj))
  # clust.pair$rank = ifelse(clust.pair$rank == "Inf", 10^6, clust.pair$rank)
  clust.pair = clust.pair[order(-clust.pair$avg_log2FC),]
  clust.pair = clust.pair[!duplicated(clust.pair$gene),]
  if (nrow(clust.pair) < 600) {
    entz=c()
    entz = mapIds(org.Mm.eg.db, keys=clust.pair$ensembl, column="ENTREZID", keytype="ENSEMBL", multiVals="first")
    clust.pair = cbind(clust.pair, ENTREZID = entz)
  } else {
    entz=c()
    entz = bitr(clust.pair$ensembl, fromType = "ENSEMBL", toType ="ENTREZID", OrgDb = org.Mm.eg.db, drop = FALSE)
    entz = entz[!duplicated(entz$ENSEMBL),]
    clust.pair$ENTREZID = entz$ENTREZID}
  return(clust.pair)
}


clustpwall = function(data1, target1, target2) {
  clust.pair = c()
  clust.pair = slot(data1, paste0("comp", target1, "vs", target2, sep  = ""))
  clust.pair$gene = rownames(clust.pair)
  clust.pair$symbol = clust.pair$gene
  clust.pair$ensembl =  gene.conversions$ensembl[match(clust.pair$gene, gene.conversions$symbol)]
  # clust.pair$rank = clust.pair$avg_log2FC * (-log10(clust.pair$p_val_adj))
  # clust.pair$rank = ifelse(clust.pair$rank == "Inf", 10^6, clust.pair$rank)
  clust.pair = clust.pair[order(-clust.pair$avg_log2FC),]
  clust.pair = clust.pair[!duplicated(clust.pair$gene),]
  if (nrow(clust.pair) < 600) {
    entz=c()
    entz = mapIds(org.Mm.eg.db, keys=clust.pair$ensembl, column="ENTREZID", keytype="ENSEMBL", multiVals="first")
    clust.pair = cbind(clust.pair, ENTREZID = entz)
  } else {
    entz=c()
    entz = bitr(clust.pair$ensembl, fromType = "ENSEMBL", toType ="ENTREZID", OrgDb = org.Mm.eg.db, drop = FALSE)
    entz = entz[!duplicated(entz$ENSEMBL),]
    clust.pair$ENTREZID = entz$ENTREZID}
  return(clust.pair)
}

clustpprocess = function(data1) {
  clust.pair = c()
  clust.pair = data1
  clust.pair$gene = rownames(clust.pair)
  clust.pair$symbol = clust.pair$gene
  clust.pair$ensembl =  gene.conversions$ensembl[match(clust.pair$gene,
                                                       gene.conversions$symbol)]
  # clust.pair$rank = clust.pair$avg_log2FC * (-log10(clust.pair$p_val_adj))
  # clust.pair$rank = ifelse(clust.pair$rank == "Inf", 10^6, clust.pair$rank)
  # clust.pair = clust.pair[order(-clust.pair$avg_log2FC),]
  # clust.pair = clust.pair[!duplicated(clust.pair$gene),]
  #     entz=c()
  #     entz = bitr(clust.pair$ensembl, fromType = "ENSEMBL", 
  #                  toType ="ENTREZID", OrgDb = org.Mm.eg.db, drop = FALSE)
  #     entz = entz[!duplicated(entz$ENSEMBL),]
  #     clust.pair$ENTREZID = entz$ENTREZID
  
  clust.pair$diffexpressed = "NO"
  clust.pair$diffexpressed[clust.pair$avg_log2FC > 0 & clust.pair$p_val_adj < 0.05] = "UP"
  clust.pair$diffexpressed[clust.pair$avg_log2FC < 0 & clust.pair$p_val_adj < 0.05] = "DOWN"
  clust.pair$dlabel = NA
  clust.pair$dlabel[clust.pair$diffexpressed != "NO"] =
    clust.pair$symbol[clust.pair$diffexpressed != "NO"]
  return(clust.pair)
}

##### Z scores ########
cal_z_score = function(x){(x - mean(x)) / sd(x)}

###### remove processess not relevant to our research from final list #######
removecrap = function(data){
  remove1 = c(data$Description[grep("ameboidal", data$Description, ignore.case = TRUE)], 
              data$Description[grep("glial", data$Description, ignore.case = TRUE)], 
              data$Description[grep("spine", data$Description, ignore.case = TRUE)], 
              data$Description[grep("rhythmic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("heart", data$Description, ignore.case = TRUE)], 
              data$Description[grep("hair", data$Description, ignore.case = TRUE)],
              data$Description[grep("cardiac", data$Description, ignore.case = TRUE)], 
              data$Description[grep("aorta", data$Description, ignore.case = TRUE)], 
              data$Description[grep("valve", data$Description, ignore.case = TRUE)], 
              data$Description[grep("covid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("embryo", data$Description, ignore.case = TRUE)], 
              data$Description[grep("biotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neuromuscular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("spramolecular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("clathrin", data$Description, ignore.case = TRUE)], 
              data$Description[grep("bone", data$Description, ignore.case = TRUE)], 
              data$Description[grep("endocondral", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ER", data$Description, ignore.case = TRUE)], 
              data$Description[grep("melanocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("collagen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("tube", data$Description, ignore.case = TRUE)], 
              data$Description[grep("coronary", data$Description, ignore.case = TRUE)], 
              data$Description[grep("vascular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("visual", data$Description, ignore.case = TRUE)], 
              data$Description[grep("disc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("synaptic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("tree", data$Description, ignore.case = TRUE)], 
              data$Description[grep("somatodendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("detection", data$Description, ignore.case = TRUE)], 
              data$Description[grep("sensory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("virus", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neuron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("viral", data$Description, ignore.case = TRUE)], 
              data$Description[grep("gonad", data$Description, ignore.case = TRUE)], 
              data$Description[grep("biological", data$Description, ignore.case = TRUE)], 
              data$Description[grep("organ", data$Description, ignore.case = TRUE)], 
              data$Description[grep("male", data$Description, ignore.case = TRUE)], 
              data$Description[grep("female", data$Description, ignore.case = TRUE)], 
              data$Description[grep("syncitium", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ossification", data$Description, ignore.case = TRUE)], 
              data$Description[grep("reproductive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("symbiotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("alcohol", data$Description, ignore.case = TRUE)], 
              data$Description[grep("actin", data$Description, ignore.case = TRUE)], 
              data$Description[grep("synapse", data$Description, ignore.case = TRUE)], 
              data$Description[grep("muscle", data$Description, ignore.case = TRUE)], 
              data$Description[grep("gliogenesis", data$Description, ignore.case = TRUE)],
              data$Description[grep("neuron", data$Description, ignore.case = TRUE)],
              data$Description[grep("neural", data$Description, ignore.case = TRUE)],
              data$Description[grep("striated", data$Description, ignore.case = TRUE)],
              data$Description[grep("artery", data$Description, ignore.case = TRUE)],
              data$Description[grep("biotic", data$Description, ignore.case = TRUE)],
              data$Description[grep("cartilage", data$Description, ignore.case = TRUE)],
              data$Description[grep("vessel", data$Description, ignore.case = TRUE)],
              data$Description[grep("organic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lithium", data$Description, ignore.case = TRUE)], 
              data$Description[grep("progesterone", data$Description, ignore.case = TRUE)],
              data$Description[grep("spindle", data$Description, ignore.case = TRUE)],
              data$Description[grep("multicellular", data$Description, ignore.case = TRUE)],
              data$Description[grep("myoblast", data$Description, ignore.case = TRUE)],
              data$Description[grep("skeletal", data$Description, ignore.case = TRUE)],
              data$Description[grep("wound", data$Description, ignore.case = TRUE)],
              data$Description[grep("parkinson", data$Description, ignore.case = TRUE)],
              data$Description[grep("cytoskeleton", data$Description, ignore.case = TRUE)])
  
  data = data[!data$Description %in% remove1,]
  return(data)
}

##### Check immune modules ###########3
pickimmune = function(data){
  immune1 = c(data$Description[grep("immune", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammatory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("myeloid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("nk", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)], 
              data$Description[grep("innate", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adaptive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("complement", data$Description, ignore.case = TRUE)],
              data$Description[grep("toll", data$Description, ignore.case = TRUE)],
              data$Description[grep("mhc", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("chemotaxis", data$Description, ignore.case = TRUE)],
              data$Description[grep("migration", data$Description, ignore.case = TRUE)],
              data$Description[grep("death", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("immune", data$Description, ignore.case = TRUE)],
              data$Description[grep("pyroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necrosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("autophagy", data$Description, ignore.case = TRUE)],
              data$Description[grep("ferroptosis", data$Description, ignore.case = TRUE)])
  
  data = data[data$Description %in% immune1,]
  return(data)
}

####### Check biologically relevant modules #########
pickrelevant = function(data){
  immune1 = c(data$Description[grep("immune", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphoid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammatory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("myeloid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("nk", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)], 
              data$Description[grep("innate", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adaptive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("complement", data$Description, ignore.case = TRUE)],
              data$Description[grep("toll", data$Description, ignore.case = TRUE)],
              data$Description[grep("mhc", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("chemotaxis", data$Description, ignore.case = TRUE)],
              data$Description[grep("caspase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NLRP3", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammasome", data$Description, ignore.case = TRUE)], 
              data$Description[grep("aim2", data$Description, ignore.case = TRUE)], 
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("repair", data$Description, ignore.case = TRUE)], 
              data$Description[grep("migration", data$Description, ignore.case = TRUE)],
              data$Description[grep("death", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptotitc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("immune", data$Description, ignore.case = TRUE)],
              data$Description[grep("pyroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necrosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("autophagy", data$Description, ignore.case = TRUE)],
              data$Description[grep("mitochondria", data$Description, ignore.case = TRUE)],
              data$Description[grep("mitochondrial", data$Description, ignore.case = TRUE)],
              data$Description[grep("oxidative", data$Description, ignore.case = TRUE)],
              data$Description[grep("oxidation", data$Description, ignore.case = TRUE)],
              data$Description[grep("fatty acid", data$Description, ignore.case = TRUE)],
              data$Description[grep("lipid", data$Description, ignore.case = TRUE)],
              data$Description[grep("peroxisomes", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("glutathione", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ferroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("cycle", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adhesion", data$Description, ignore.case = TRUE)],  
              data$Description[grep("polarity", data$Description, ignore.case = TRUE)],  
              data$Description[grep("mitotic", data$Description, ignore.case = TRUE)],  
              data$Description[grep("epithelial", data$Description, ignore.case = TRUE)],
              data$Description[grep("fibroblast", data$Description, ignore.case = TRUE)], 
              data$Description[grep("exocytosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("arachadonic", data$Description, ignore.case = TRUE)],
              data$Description[grep("electron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("locomotion", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respiration", data$Description, ignore.case = TRUE)], 
              data$Description[grep("angiogenesis", data$Description, ignore.case = TRUE)],
              data$Description[grep("reduction", data$Description, ignore.case = TRUE)], 
              data$Description[grep("oxygen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("plasma membrane", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NADH", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dehydrogenase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respirasome", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respiratory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("oxidoreductase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("iron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("heme", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NAD", data$Description, ignore.case = TRUE)],
              data$Description[grep("NF", data$Description, ignore.case = TRUE)], 
              data$Description[grep("kappa", data$Description, ignore.case = TRUE)], 
              data$Description[grep("phosphatidylinositol", data$Description, ignore.case = TRUE)])
  
  data = data[data$Description %in% immune1,]
  return(data)
}


########### sort genes in order for symbol #####################
gene0symbol = function(data1) {
  gene0 = c()
  gene0 = data1$avg_log2FC # the Log2FC
  names(gene0) = data1$symbol # genes
  gene0 = sort(gene0, decreasing = TRUE) # sort decreasing order
  gene0 = gene0[!duplicated(names(gene0))]
  return(gene0)}

########### sort genes in order for ensembl ##################
gene0ensembl = function(data1) {
  gene0 = c()
  gene0 = data1$avg_log2FC # the Log2FC
  names(gene0) = data1$ensembl # genes
  gene0 = sort(gene0, decreasing = TRUE) # sort decreasing order
  gene0 = gene0[!duplicated(names(gene0))]
  return(gene0)}

########### sort genes in order for entrezid #####################
gene0entrezid = function(data1) {
  gene0 = c()
  gene0 = data1$avg_log2FC # the Log2FC
  names(gene0) = data1$ENTREZID # genes
  gene0 = sort(gene0, decreasing = TRUE) # sort decreasing order
  gene0 = gene0[!duplicated(names(gene0))]
  return(gene0)}


######## Over representation analysis with GO (clusterprofiler) ###########
egosummary = function (gene0, pcutoff, qcutoff, adjmethod) {
  # Over representation enrichment analysis
  # ontology cytosolic component
  ego.cc = c()
  ego.cc = enrichGO(gene     = names(gene0),
                    OrgDb         = org.Mm.eg.db,
                    keyType       = 'ENTREZID',
                    ont           = "CC",
                    pAdjustMethod = adjmethod,
                    pvalueCutoff  = pcutoff,
                    qvalueCutoff  = qcutoff, 
                    readable      = TRUE)
  egocc = c()
  egocc = filter(ego.cc, p.adjust < 0.05, qvalue < 0.05)
  egocc = mutate(egocc, geneRatio = parse_ratio(GeneRatio)) %>% arrange(desc(geneRatio))
  egocc = mutate(egocc, richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
  egocc = mutate(egocc, FoldEnrichment = parse_ratio(GeneRatio) / parse_ratio(BgRatio))
  
  cc1 = barplot(egocc, showCategory=20, title ="cytosolic component")
  cc2 = dotplot(egocc, showCategory=20, title ="cytosolic component")
  cc3 = upsetplot(egocc)
  cc4 = heatplot(egocc)
  cc5 = goplot(egocc)
  cc6 = ggplot(egocc, showCategory = 20, aes(FoldEnrichment, 
                                             fct_reorder(Description, FoldEnrichment))) + 
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() + xlab("FoldEnrichment") +
    ylab(NULL) + ggtitle("Enriched GO:CC - FE")
  
  listcc = list(cc1, cc2, cc3, cc4, cc5, cc6)
  
  # ontology = molecular function
  ego.mf = c()
  ego.mf = enrichGO(gene   = names(gene0),
                    OrgDb         = org.Mm.eg.db,
                    keyType       = 'ENTREZID',
                    ont           = "MF",
                    pAdjustMethod = adjmethod,
                    pvalueCutoff  = pcutoff,
                    qvalueCutoff  = qcutoff, 
                    readable      = TRUE)
  
  egomf = c()
  egomf = filter(ego.mf, p.adjust < 0.05, qvalue < 0.05)
  egomf = mutate(egomf, geneRatio = parse_ratio(GeneRatio)) %>% arrange(desc(geneRatio))
  egomf = mutate(egomf, richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
  egomf = mutate(egomf, FoldEnrichment = parse_ratio(GeneRatio) / parse_ratio(BgRatio))
  
  mf1 = barplot(egomf, showCategory=20, title ="molecular function")
  mf2 = dotplot(egomf, showCategory=20, title ="molecular function")
  mf3 = upsetplot(egomf)
  mf4 = heatplot(egomf)
  mf5 = goplot(egomf)
  mf6  = ggplot(egomf, showCategory = 20, aes(FoldEnrichment, 
                                              fct_reorder(Description, FoldEnrichment))) + 
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() + xlab("FoldEnrichment") +
    ylab(NULL) + ggtitle("Enriched GO:MF - FE")
  
  listmf = list(mf1, mf2, mf3, mf4, mf5, mf6)
  
  # ontology = biological process
  ego.bp = c()
  ego.bp = enrichGO(gene   = names(gene0),
                    OrgDb         = org.Mm.eg.db,
                    keyType       = 'ENTREZID',
                    ont           = "BP",
                    pAdjustMethod = adjmethod,
                    pvalueCutoff  = pcutoff,
                    qvalueCutoff  = qcutoff, 
                    readable      = TRUE)
  
  egobp = c()
  egobp = filter(ego.bp, p.adjust < 0.05, qvalue < 0.05)
  egobp = mutate(egobp, geneRatio = parse_ratio(GeneRatio)) %>% arrange(desc(geneRatio))
  egobp = mutate(egobp, richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
  egobp = mutate(egobp, FoldEnrichment = parse_ratio(GeneRatio) / parse_ratio(BgRatio))
  
  
  bp1 = barplot(egobp, showCategory=20,  title ="biological process")
  bp2 = dotplot(egobp, showCategory=20,  title ="biological process")
  bp3 = upsetplot(egobp)
  bp4 = heatplot(egobp)
  bp5 = goplot(egobp)
  bp6 = ggplot(egobp, showCategory = 20, 
               aes(FoldEnrichment, fct_reorder(Description, FoldEnrichment))) + 
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() + xlab("FoldEnrichment") +
    ylab(NULL) + ggtitle("Enriched GO:BP")
  
  listbp=list(bp1, bp2, bp3, bp4, bp5, bp)
}


####### Over representation analysis with KEGG (clusterprofiler) #############
ekeggsummary = function (gene0, pcutoff, qcutoff, adjmethod) {
  # Enrich for KEGG
  ekegg.mmu = c()
  ekegg.mmu = enrichKEGG(gene  = names(gene0),
                         organism     = 'mmu',
                         pAdjustMethod = adjmethod,
                         pvalueCutoff = pcutoff,
                         qvalueCutoff = qcutoff)
  
  ekegg = c()
  ekegg = filter(ekegg.mmu, p.adjust < 0.05, qvalue < 0.05)
  ekegg = mutate(ekegg, geneRatio = parse_ratio(GeneRatio)) %>% arrange(desc(geneRatio))
  ekegg = mutate(ekegg, richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
  ekegg = mutate(ekegg, FoldEnrichment = parse_ratio(GeneRatio) / parse_ratio(BgRatio))
  
  ek1 = barplot(ekegg, showCategory=20,  title ="KEGG")
  ek2 = dotplot(ekegg, showCategory=20,  title ="KEGG")
  ek3 = upsetplot(ekegg)
  ek4 = heatplot(ekegg)
  ek5 = ggplot(ekegg, showCategory = 20, aes(geneRatio, fct_reorder(Description, geneRatio))) +
    geom_point(aes(color=p.adjust, size = Count))+ #geom_segment(aes(xend=0, yend = Description)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() +
    xlab("GeneRatio") +ylab(NULL) + ggtitle("Enriched KEGG - GR")
  ek6 = ggplot(ekegg, showCategory = 20, aes(richFactor, fct_reorder(Description, richFactor))) +
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) + theme_minimal() + xlab("RichFactor") +
    ylab(NULL) + ggtitle("Enriched KEGG - RF")
  ek7 = ggplot(ekegg, showCategory = 20, aes(FoldEnrichment, fct_reorder(Description, FoldEnrichment))) +
    geom_point(aes(color=p.adjust, size = Count)) +
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 10)) +theme_minimal() + xlab("FoldEnrichment") +
    ylab(NULL) + ggtitle("Enriched KEGG - FE")
  
  listkegg = list(ek1, ek2, ek3, ek4, ek5, ek6, ek7)
  
  enrichlist = list("egoKEGG" = ekegg,
                    "ekeggplot" = listkegg)
  return(enrichlist)
}


############# GSEA with GO (clusterprofiler) ######################
ggosummary = function (gene0, pcutoff, adjmethod, ont){
  g.go.bp = c()
  g.go.bp = gseGO(geneList = gene0, 
                  ont =ont, # options: All, BP (biol process), MF (mol func), CC (cytosolic comp)
                  keyType = "SYMBOL", 
                  OrgDb = org.Mm.eg.db, 
                  nPerm = 10000, # permutations, set 10,000 when correct
                  minGSSize = 10, # min number genes in set
                  maxGSSize = 1000, # max genes in a set
                  pvalueCutoff = pcutoff,
                  verbose = FALSE, 
                  seed = 42,
                  pAdjustMethod = adjmethod)
  g.go.bp.orig = g.go.bp
  ggo.bp = filter(g.go.bp, p.adjust < 0.05, qvalues < 0.05)
  x2.bp = pairwise_termsim(ggo.bp)
  
  ggo.bp1 = as.data.frame(ggo.bp)
  ggo.bp1 = ggo.bp1 %>% dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(ggo.bp1, NES)
  ggo.bp1$Pathway.Direction = cut(-1*ggo.bp1$NES, c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  colnames(ggo.bp1)[4] = "Count"
  ggo.bp1 = removecrap(ggo.bp1)
  
  
  pg1.bp = dotplot(ggo.bp, showCategory = 20, title = "GSEA-GO", 
                   split = ".sign") + facet_grid(.~.sign)
  pg2.bp = gseaplot(ggo.bp, by = "all", geneSetID = 1)
  pg3.bp = ridgeplot(ggo.bp) + labs(x = "enrichment distribution")
  pg4.bp = emapplot(x2.bp)
  pg5.bp = ggplot(ggo.bp1, aes(x = log.p.adj, y = Description)) + 
    geom_point(aes(color= p.adjust, size = setSize)) + theme_bw() + 
    geom_vline(xintercept  = 0, linetype = "dashed")+
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) + 
    theme(axis.text.y = element_text(size = 10)) +xlab("-log10 of P-value") +
    ylab("Description") + 
    ggtitle("GSEA-GO:BP") + 
    facet_grid(~Pathway.Direction)
  pg6.bp = cnetplot(x2.bp, categorySize = "p.adjust", 
                    colorEdge = TRUE, foldChange = gene0, 
                    node_label = "all", cex_label_category = 1.3)
  
  listgsego.bp = list(pg1.bp, pg2.bp, pg3.bp, pg4.bp, pg5.bp, pg6.bp)
  
  gselist = list("gsego.bp" = ggo.bp, 
                 "gsegoplot.bp" = listgsego.bp,
                 "for.cnet" = g.go.bp.orig)
  # "gsego.mf" = ggo.mf, "gsegoplot.mf" = listgsego.mf)
  # # "gsego.cc" = ggo.cc, "gsegoplot.cc" = listgsego.cc)
  
  return(gselist)
}

custom.gsea = function(data){
  test1 = data.frame(data)
  test1 = test1 %>% dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(test1, NES)
  test1$Pathway.Direction = cut(-1*test1$NES, c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  test1 = removecrap(test1)
  return(test1)
}

ggosummarybp <- function (gene0, pcutoff, adjmethod, ont){
  g.go.bp <- c()
  g.go.bp <- gseGO(geneList = gene0, 
                   ont =ont, # options: All, BP (biol process), MF (mol func), CC (cytosolic comp)
                   keyType = "ENTREZID", 
                   OrgDb = org.Mm.eg.db, 
                   nPerm = 10000, # permutations, set 10,000 when correct
                   minGSSize = 10, # min number genes in set
                   maxGSSize = 1000, # max genes in a set
                   pvalueCutoff = pcutoff,
                   verbose = FALSE, 
                   pAdjustMethod = adjmethod)
  
  ggo.bp <- c()
  x2.bp <- c()
  ggo.bp <- filter(g.go.bp, p.adjust < 0.05, qvalues < 0.05)
  x2.bp <- pairwise_termsim(ggo.bp)
  
  pg1.bp <- dotplot(ggo.bp, showCategory = 20, title = "GSEA-GO", split = ".sign") + facet_grid(.~.sign)
  pg2.bp <- gseaplot(ggo.bp, by = "all", geneSetID = 1)
  pg3.bp <- ridgeplot(ggo.bp) + labs(x = "enrichment distribution")
  pg4.bp <- emapplot(x2.bp)
  
  listgsego.bp <- list(pg1.bp, pg2.bp, pg3.bp, pg4.bp)
  
  
  # g.go.mf <- c()
  # g.go.mf <- gseGO(geneList = gene0, 
  #            ont ="MF", # options: All, mf (biol process), MF (mol func), CC (cytosolic comp)
  #            keyType = "ENTREZID", 
  #            OrgDb = org.Mm.eg.db, 
  #            nPerm = 10000, # permutations, set 10,000 when correct
  #            minGSSize = 10, # min number genes in set
  #            maxGSSize = 1000, # max genes in a set
  #            pvalueCutoff = pcutoff,
  #            verbose = FALSE, 
  #            pAdjustMethod = adjmethod)
  # 
  # ggo.mf <- c()
  # x2.mf <- c()
  # ggo.mf <- filter(g.go.mf, p.adjust < 0.05, qvalues < 0.05)
  # x2.mf <- pairwise_termsim(ggo.mf)
  # 
  # pg1.mf <- dotplot(ggo.mf, showCategory = 20, title = "GSEA-GO", split = ".sign") + facet_grid(.~.sign)
  # pg2.mf <- gseaplot(ggo.mf, by = "all", title = ggo$Description[1], geneSetID = 1)
  # pg3.mf <- ridgeplot(ggo.mf) + labs(x = "enrichment distribution")
  # pg4.mf <- emapplot(x2.mf)
  # 
  # listgsego.mf <- list(pg1.mf, pg2.mf, pg3.mf, pg4.mf)
  # 
  # 
  
  # g.go.cc <- c()
  # g.go.cc <- gseGO(geneList = gene0, 
  #            ont ="CC", # options: All, cc (biol process), MF (mol func), CC (cytosolic comp)
  #            keyType = "ENTREZID", 
  #            OrgDb = org.Mm.eg.db, 
  #            nPerm = 10000, # permutations, set 10,000 when correct
  #            minGSSize = 10, # min number genes in set
  #            maxGSSize = 1000, # max genes in a set
  #            pvalueCutoff = pcutoff,
  #            verbose = FALSE, 
  #            pAdjustMethod = adjmethod)
  # 
  # ggo.cc <- c()
  # x2.cc <- c()
  # ggo.cc <- filter(g.go.cc, p.adjust < 0.05, qvalues < 0.05)
  # x2.cc <- pairwise_termsim(ggo.cc)
  # 
  # pg1.cc <- dotplot(ggo.cc, showCategory = 20, title = "GSEA-GO", split = ".sign") + facet_grid(.~.sign)
  # pg2.cc <- gseaplot(ggo.cc, by = "all", title = ggo$Description[1], geneSetID = 1)
  # pg3.cc <- ridgeplot(ggo.cc) + labs(x = "enrichment distribution")
  # pg4.cc <- emapplot(x2.cc)
  # listgsego.cc <- list(pg1.cc, pg2.cc, pg3.cc, pg4.cc)
  
  
  gselist <- list("gsego.bp" = ggo.bp, "gsegoplot.bp" = listgsego.bp)
  # "gsego.mf" = ggo.mf, "gsegoplot.mf" = listgsego.mf)
  # # "gsego.cc" = ggo.cc, "gsegoplot.cc" = listgsego.cc)
  
  return(gselist)
}


############# GSEA with KEGG (clusterprofiler)###################
gkeggsummary = function (gene0, pcutoff, adjmethod){
  pcutoff = 0.05
  adjmethod = "BH"
  
  g.kegg = c()
  g.kegg = gseKEGG(geneList  = gene0,
                   organism = "mmu",
                   keyType = "kegg",
                   minGSSize = 5,
                   maxGSSize = 1000,
                   pvalueCutoff = pcutoff,
                   pAdjustMethod = adjmethod,
                   verbose      = FALSE)
  
  gkegg = c()
  x2 = c()
  gkegg = filter(g.kegg, p.adjust < 0.05, qvalues < 0.05)
  x2 = pairwise_termsim(gkegg)
  
  pk1 = dotplot(gkegg, showCategory = 20, title = "GSEA-kegg", 
                split = ".sign") + facet_grid(.~.sign)
  pk2 = gseaplot(gkegg, by = "all", title = gkegg$Description[1], geneSetID = 1)
  pk3 = ridgeplot(gkegg, showCategory = 20) + labs(x = "enrichment distribution")
  # pk4 = emapplot(x2)
  
  listgsego = list(pk1, pk2, pk3)
  gselist = list("gsekegg" = gkegg, "gsekeggplot" = listgsego)
  
  return(gselist)
}

#### PathfindR pathway analysis for non human species ########
pathsummary = function (clustxvsy){
  clustxvsypath = clustxvsy[,c("symbol", "avg_log2FC", "p_val_adj")]
  pathrun = c()
  pathrun = run_pathfindR(clustxvsypath,
                          enrichment_threshold = 0.01,
                          gene_sets = "Custom",
                          custom_genes = mmu_kegg_genes,
                          custom_descriptions = mmu_kegg_descriptions,
                          output_dir = "pathfind")
  
  tablepath = knitr::kable(head(pathrun, 20))
  chartpath = enrichment_chart(result_df = pathrun, top_terms = 20)
  genepath = term_gene_graph(result_df = pathrun, use_description = TRUE)  
  heatpath = term_gene_heatmap(result_df = pathrun, genes_df = clustxvsypath)
  upsetpath = UpSet_plot(result_df = pathrun, genes_df = clustxvsypath)
  
  plotpath = list(tablepath, chartpath, genepath, heatpath, upsetpath)
  listpath = list("pathway" = pathrun, "pathway plots" = plotpath)
  
  return(listpath)}



####### summary for each pairwise cluster enrichment analysis #####
summary.clustpw = function (i) {
  if (i == 0) {
    clust = se.clust.vs.0
  } else if (i == 1) {
    clust = se.clust.vs.1
  } else if (i == 2) {
    clust = se.clust.vs.1
  } else if (i == 3) {
    clust = se.clust.vs.1
  } else if (i == 4) {
    clust = se.clust.vs.1
  } else if (i == 5) {
    clust = se.clust.vs.1
  } else if (i == 6) {
    clust = se.clust.vs.1
  } else if (i == 7) {
    clust = se.clust.vs.1
  } else if (i == 8) {
    clust = se.clust.vs.1
  } else if (i == 9) {
    clust = se.clust.vs.1
  } else if (i == 10) {
    clust = se.clust.vs.1
  } 
  
  no.clusters = c()
  no.clusters=as.numeric(levels(se@meta.data$seurat_clusters))
  t1 = c()
  t1 = (i+1):no.clusters[length(no.clusters)]
  cxor.temp = c()
  gxor.temp = c()
  cego = c()
  cekegg = c()
  
  cxgse.temp = c()
  gxgse = c()
  cggo = c()
  cgkegg = c()
  cpfr = c()
  
  for (j in t1) {
    cxor.temp[[j]] = clustpwup(clust, i, j)
    gxor.temp[[j]] = gene0entrezid(cxor.temp[[j]])
    cego[[k]] = egosummary(gxor.temp[[j]], 0.05, 0.05, "BH")
    cekegg[[j]] = ekeggsummary(gxor.temp[[j]], 0.05, 0.05, "BH")
    
    cxgse.temp[[j]] = clustpwall(clust, i, j)
    gxgse[[j]] = gene0entrezid(cxgse.temp[[j]])
    cggo[[j]] = ggosummary(gxgse[[j]], 0.05, "BH")
    cgkegg[[j]] = gkeggsummary(gxgse[[j]], 0.05, "BH")
    
    cpfr[[j]] = pathsummary(cxgse.temp[[j]])
  }
  
  matrices = list(cego, cekegg, cpfr)
  return(matrices)}

######## modified violin plots #########
modify_vlnplot<- function(obj, feature, pt.size = 0, 
                          plot.margin = unit(c(-0.75, 0, -0.75, 0), "cm"),
                          ...) {
  p<- VlnPlot(obj, features = feature, pt.size = pt.size, ... )  + 
    xlab("") + ylab(feature) + ggtitle("") + 
    theme(legend.position = "none", 
          axis.text.x = element_blank(), 
          axis.ticks.x = element_blank(),
          axis.title.y = element_text(size = rel(1), angle = 0), 
          axis.text.y = element_text(size = rel(1)), 
          plot.margin = plot.margin ) 
  return(p)
}

extract_max<- function(p){
  ymax<- max(ggplot_build(p)$layout$panel_scales_y[[1]]$range$range)
  return(ceiling(ymax))
}

StackedVlnPlot<- function(obj, features,
                          pt.size = 0, 
                          plot.margin = unit(c(-0.75, 0, -0.75, 0), "cm"),
                          ...) {
  
  plot_list<- purrr::map(features, function(x) modify_vlnplot(obj = obj,feature = x, ...))
  
  # Add back x-axis title to bottom plot. patchwork is going to support this?
  plot_list[[length(plot_list)]]<- plot_list[[length(plot_list)]] +
    theme(axis.text.x=element_text(angle = 45, hjust = 1, vjust = 1), 
          axis.ticks.x = element_line())
  
  # change the y-axis tick to only max value 
  ymaxs<- purrr::map_dbl(plot_list, extract_max)
  plot_list<- purrr::map2(plot_list, ymaxs, function(x,y) x + 
                            scale_y_continuous(breaks = c(y)) + 
                            expand_limits(y = y))
  
  p<- patchwork::wrap_plots(plotlist = plot_list, ncol = 1)
  return(p)
}

###### Plot genes of interest on spatial sets ###########
dispgoi = function(se, ftx, splitby) {
  
  fdisp = c()
  for (i in 1:length(ftx)) {
    if (splitby == "treatment") {
      fdisp[[i]] = FeaturePlot(se, features = ftx[[i]], reduction = "umap", order = TRUE, 
                               cols = heatmap.colors, split.by = "treatment", ncol = 3)
    } else if (splitby == "slide") {
      fdisp[[i]] = FeaturePlot(se, features = ftx[[i]], reduction = "umap", order = TRUE, 
                               cols = heatmap.colors, split.by = "slide", ncol = 3)
    } else {
      fdisp[[i]] = FeatureOverlay(se, features = ftx[[i]], sampleids = 1:6, 
                                  cols = c("lightgray", "mistyrose", "red", "darkred", "black"), 
                                  pt.size = 1.5,  pt.alpha = 0.5, ncol = 3)
    }}
  
  return(fdisp)
}


######## Gsea for LPSTolDC vs other groups #########
gsea.lpstol.v.rest.03 = function(se, cluster,threshold){
  id1 = "LPSTol"
  id2 = "TolDC"
  id3 = "PBS"
  check = c()
  check = SubsetSTData(se, expression = SCT_snn_res.0.3 == cluster)
  Idents(check) = 'SCT_snn_res.0.3'
  
  check.pbs = SubsetSTData(check, expression = treatment == "PBS")
  check.ltoldc = SubsetSTData(check, expression = treatment == "LPSTol")
  check.toldc = SubsetSTData(check, expression = treatment == "TolDC")
  check.m = MergeSTData(check.pbs,c(check.toldc,  check.ltoldc))
  
  # Cluster 7 FindMarkers id1 (LPS-Tol) vs id2 (TolDC)
  check.markers.id1v2 = c()
  check.markers.id1v2 = FindMarkers(check.m, ident.1 = id1, ident.2 = id2, 
                                    group.by = 'treatment', 
                                    subset.ident = as.character(cluster), 
                                    recorrect_umi = FALSE,
                                    logfc.threshold = threshold, 
                                    min.pct = 0.05)
  check.markers.id1v2 = clustpprocess(check.markers.id1v2)
  
  volcanoid1v2 = ggplot(data=check.markers.id1v2, 
                        aes(x=avg_log2FC, y=-log10(p_val_adj), 
                            col=diffexpressed, label=dlabel)) +
    geom_point() + theme_minimal() + geom_text_repel() +
    scale_color_manual(values=c("blue", "black", "red")) +
    geom_vline(xintercept=c(-0.5, 0.5), col="pink") +
    geom_hline(yintercept=-log10(0.05), col="pink") + 
    ggtitle("LPSTolDC vs TolDC")
  
  # GSE analysis
  c0v1ggo.id1v2bp = c()
  c0v1ggo.id1v2bp = ggosummarybp(gene0symbol(check.markers.id1v2), 0.05, "BH", "all")
  
  test1 = data.frame(c0v1ggo.id1v2bp$gsego.bp)
  test1 = test1 %>% dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(test1, NES)
  test1$Pathway.Direction = cut(-1*test1$NES, c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  test1 = removecrap(test1)
  test1.a = pickimmune(test1)
  
  # Cluster 7 FindMarkers id1 (LPS-Tol) vs id3 (PBS)
  check.markers.id1v3 = c()
  check.markers.id1v3 = FindMarkers(check.m, ident.1 = id1, ident.2 = id3, 
                                    group.by = 'treatment', 
                                    subset.ident = as.character(cluster), 
                                    recorrect_umi = FALSE,
                                    logfc.threshold = threshold, 
                                    min.pct = 0.05)
  check.markers.id1v3 = clustpprocess(check.markers.id1v3)
  
  volcanoid1v3 = c()
  volcanoid1v3 = ggplot(data=check.markers.id1v3, 
                        aes(x=avg_log2FC, y=-log10(p_val_adj), 
                            col=diffexpressed, label=dlabel)) +
    geom_point() + theme_minimal() + geom_text_repel() +
    scale_color_manual(values=c("blue", "black", "red")) +
    geom_vline(xintercept=c(-0.5, 0.5), col="pink") +
    geom_hline(yintercept=-log10(0.05), col="pink") + 
    ggtitle("LPSTolDC vs PBS")
  
  # GSE analysis
  c0v1ggo.id1v3bp = ggosummarybp(gene0symbol(check.markers.id1v3), 0.05, "BH", "all")
  
  test2 = data.frame(c0v1ggo.id1v3bp$gsego.bp)
  test2 = test2 %>% dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(test2, NES)
  test2$Pathway.Direction = cut(-1*test2$NES, c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  test2 = removecrap(test2)
  test2.a = pickimmune(test2)
  
  # Find common for Cluster 7 LPSTol vs Tol/PBS
  common = test1[test1$Description %in% test2$Description,]
  common.keep = common[common$Pathway.Direction == test2$Pathway.Direction,]
  common.keep = common.keep[!is.na(common.keep$Pathway.Direction),]
  remove = common.keep$Description[grep("anatomical", common.keep$Description, ignore.case = TRUE)]
  common.keep = common.keep[!(common.keep$Description %in% remove),]
  
  list1 = list(test1, test1.a, test2, test2.a, common.keep)
  return(list1)}

custom.gsea = function(data){
  test1 = data.frame(data)
  test1 = test1 %>% dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(test1, NES)
  test1$Pathway.Direction = cut(-1*test1$NES, c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  test1 = removecrap(test1)
  return(test1)
}

############# further process and filter for digestible results ################
trimmer = function(data){
  data = data[data$p.adjust < 0.05,]
  
  data = data[!(data$Description == "viral entry into host cell"),]
  data = data[!(data$Description == "neuroinflammatory response"),]
  data = data[!(data$Description == "immune response"),]
  data = data[!(data$Description == "immune system process"),]
  data = data[!(data$Description == "enzyme linked receptor protein signaling pathway"),]
  data = data[!(data$Description == "inflammatory response"),]
  data = data[!(data$Description == "tissue migration"),]
  data = data[!(data$Description == "movement in host environment"),]
  
  remove = c(data$Description[grep("regulation",  data$Description, ignore.case = TRUE)],  
             data$Description[grep("epithelium",  data$Description, ignore.case = TRUE)],
             data$Description[grep("projection",  data$Description, ignore.case = TRUE)],
             data$Description[grep("sprouting",  data$Description, ignore.case = TRUE)],
             data$Description[grep("complex I",   data$Description, ignore.case = TRUE)], 
             data$Description[grep("plasma membrane",   data$Description, ignore.case = TRUE)],
             data$Description[grep("cellular lipid",   data$Description, ignore.case = TRUE)],
             data$Description[grep("locomotion",   data$Description, ignore.case = TRUE)],
             data$Description[grep("adhesion",   data$Description, ignore.case = TRUE)],
             data$Description[grep("protein",   data$Description, ignore.case = TRUE)],
             data$Description[grep("migration",   data$Description, ignore.case = TRUE)])
  data = data[!(data$Description %in% remove),]
  
  myeloid = c(data$Description[grep("myeloid", data$Description, ignore.case = TRUE)],
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("mononuclear", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("granulocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)],
              data$Description[grep("tumour", data$Description, ignore.case = TRUE)],
              data$Description[grep("tumor", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)],
              data$Description[grep("innate", data$Description, ignore.case = TRUE)])
  
  lymphoid = c(data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)],
               data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
               data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
               data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
               data$Description[grep("effector", data$Description, ignore.case = TRUE)], 
               data$Description[grep("adaptive", data$Description, ignore.case = TRUE)])
  lymphoid = lymphoid[!(lymphoid %in% myeloid)]
  
  c.death = c(data$Description[grep("death", data$Description, ignore.case = TRUE)],
              data$Description[grep("apoptotic", data$Description, ignore.case = TRUE)],
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("immune", data$Description, ignore.case = TRUE)])
  
  metab = c(data$Description[grep("oxidation", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxidative", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxygen", data$Description, ignore.case = TRUE)],
            data$Description[grep("heme", data$Description, ignore.case = TRUE)],
            data$Description[grep("fatty", data$Description, ignore.case = TRUE)],
            data$Description[grep("lipid", data$Description, ignore.case = TRUE)],
            data$Description[grep("iron", data$Description, ignore.case = TRUE)],
            data$Description[grep("respiratory", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxidoreductase", data$Description, ignore.case = TRUE)], 
            data$Description[grep("dehydrogenase", data$Description, ignore.case = TRUE)], 
            data$Description[grep("glutathione", data$Description, ignore.case = TRUE)], 
            data$Description[grep("NAD", data$Description, ignore.case = TRUE)], 
            data$Description[grep("tricarboxylic", data$Description, ignore.case = TRUE)], 
            data$Description[grep("respirasome", data$Description, ignore.case = TRUE)],
            data$Description[grep("respiration", data$Description, ignore.case = TRUE)],
            data$Description[grep("electron", data$Description, ignore.case = TRUE)], 
            data$Description[grep("mitochondrial", data$Description, ignore.case = TRUE)], 
            data$Description[grep("mitochondria", data$Description, ignore.case = TRUE)])
  
  adh.cycle = c(data$Description[grep("adhesion", data$Description, ignore.case = TRUE)],
                data$Description[grep("epithelial", data$Description, ignore.case = TRUE)],
                data$Description[grep("angiogenesis", data$Description, ignore.case = TRUE)],
                data$Description[grep("mitotic", data$Description, ignore.case = TRUE)],
                data$Description[grep("exocytosis", data$Description, ignore.case = TRUE)],
                data$Description[grep("membrane", data$Description, ignore.case = TRUE)],
                data$Description[grep("fibroblast", data$Description, ignore.case = TRUE)],
                data$Description[grep("endothelial", data$Description, ignore.case = TRUE)],
                data$Description[grep("polarity", data$Description, ignore.case = TRUE)],
                data$Description[grep("phosphatidylinositol", data$Description, ignore.case = TRUE)],
                data$Description[grep("cycle", data$Description, ignore.case = TRUE)])
  adh.cycle = adh.cycle[!(adh.cycle%in% metab)]
  adh.cycle = adh.cycle[!(adh.cycle%in% c.death)]
  
  data$group  = NA
  data$group = ifelse(data$Description %in% myeloid, "innate", data$group)
  data$group = ifelse(data$Description %in% lymphoid, "adaptive", data$group)
  data$group = ifelse(data$Description %in% metab, "metab", data$group)
  data$group = ifelse(data$Description %in% adh.cycle, "cell", data$group)
  data$group = ifelse(data$Description %in% c.death, "death", data$group)
  
  return(data)}


# From spotlight package - modify colour scheme
plotInteractions <- function(x,
                             which = c("heatmap", "network"),
                             metric = c("prop", "jaccard"),
                             min_prop = 0, ...) {
  # check validity of input arguments
  which <- match.arg(which)
  metric <- match.arg(metric)
  
  # get interactions table
  if (is.null(colnames(x))) {
    colnames(x) <- seq_len(ncol(x))}
  df <- .count_interactions(x, min_prop)
  df <- .statistics_interaction(x, df)
  
  switch(which,
         heatmap = .plot_heatmap(x, df, metric),
         network = .plot_network(x, df, metric, ...))
}

.plot_heatmap <- function(x, df, metric) {
  p <- ggplot(df)
  
  if (metric == "prop") {
    p <- p + geom_tile(aes_string("i", "j", fill = "pi")) +
      geom_tile(aes_string("j", "i", fill = "pj"))
    
  } else if (metric == "jaccard") {
    # p <- p + geom_tile(aes_string("i", "j", fill = "jaccard"))
    p <- p + geom_tile(aes(i, j, fill = jaccard, color = "white")) 
  }
  
  # Prettify the plot :)
  p + scale_y_discrete(limits = function(.) rev(.)) +
    scale_fill_viridis_c(option = "magma")+
    coord_fixed(expand = FALSE) +
    labs(x = "From", y = "To", fill = "jaccard") +
    theme_linedraw() +
    theme(panel.grid = element_blank(),
          axis.text.x = element_text(size = 11, angle = 50, hjust = 1),
          axis.text.y = element_text(size = 12))
}

.count_interactions <- function(x, min_prop) {
  # for each pair of groups count how many
  # samples have value above 'min_prop'
  x <- x > min_prop
  ij <- combn(colnames(x), 2)
  y <- apply(ij, 2, function(.) sum(rowAlls(x[, ., drop = FALSE])))
  
  # construct 'data.frame'
  df <- data.frame(t(ij), y)
  names(df) <- c("from", "to", "n")
  
  # assure are properly ordered
  y <- colnames(x)
  df$i <- factor(df$from, y)
  df$j <- factor(df$to, rev(y))
  
  return(df)
}

.statistics_interaction <- function(x, df) {
  # compute proportion of samples that have all groups
  y <- colnames(x)
  t <- colSums(x > 0)
  i <- match(df$from, y)
  j <- match(df$to, y)
  df$ti <- t[i]
  df$tj <- t[j]
  df$pi <- df$n / df$ti
  df$pj <- df$n / df$tj
  df$jaccard <- df$n / (df$ti + df$tj - df$n)
  return(df)
}


.plot_network <- function(x, df, metric, ...) {
  # Check necessary packages are installed and if not STOP
  
  w <- switch(metric,
              prop = scale(df[, "n"], 1),
              jaccard = df[, "jaccard"])
  
  g <- igraph::graph_from_data_frame(df,
                                     vertices = colnames(x),
                                     directed = FALSE)
  
  igraph::plot.igraph(g, edge.width = w, ...)
}


```

### TolDC related set up files

This chunk has setup.toldc.R file
```{r, echo=TRUE, results = FALSE, warning = FALSE, eval = FALSE}

###############################################################################
# Load packages
###############################################################################
library(BiocParallel)
library(BiocManager)

packagesload = c()
packagesload = c("tidyverse", "dplyr", "readxl", "ggpubr", "graphics", "Gmisc", "knitr", "table1", 
                 "MatchIt", "htmlTable", "magrittr", "survminer", "survival", "lattice", "rstatix", 
                 "viridis", "pROC",  "reshape2", "rcompanion", "edgeR", "limma", "Glimma", "parallel",
                 "AnnotationDbi", "GOexpress", "Matrix", "org.Hs.eg.db", "org.Mm.eg.db", "ggfortify", 
                 "RColorBrewer", "mixOmics", "VennDiagram", "monocle", "Rtsne", "gplots", "ggplot2", 
                 "NMF", "EnhancedVolcano", "calibrate", "pheatmap", "vsn", "Seurat", "SeuratObject", 
                 "patchwork", "PCAtools", "rrcov", "pcaExplorer", "usethis", "devtools", "ComICS",
                 "pathview", "rjson","cowplot", "grid", "readbitmap", "rhdf5", "hdf5r", "data.table", 
                 "tibble", "clusterProfiler", "ReactomePA", "pathview", "enrichplot", "DOSE", 
                 "stringr", "gridExtra", "Rcpp", "NMF", "kableExtra", "imager",  "spdep", "scuttle",
                 "pathfindR", "topGO", "biomaRt", "STdeconvolve", "STutility", "SpatialCPie", "scran",
                 "clustree", "pander", "pagoda2", "harmony", "SingleCellExperiment", "SCINA", 
                 "ggcorrplot", "SpatialExperiment", "TENxVisiumData", "devtools", "FSA", 
                 "superheat", "beachmat",
                 "shiny", "xtable","S4Vectors", "MASS", "Giotto", "Nebulosa","scmap","GEOquery",
                 "singleCellHaystack", "NMF", "gt", "igraph", "GOplot", "ggnewscale", "ggvenn",  
                 "forcats", "stringr", "ggrepel", "readr", "tidyr", "XML", "harmony", "SingleR", 
                 "celldex", "SingleCellExperiment", "SCINA", "shiny", "ggVennDiagram", "directPA")

# Install packages not yet installed, then load
installed_packages = packagesload %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packagesload[!installed_packages], dependencies = TRUE)}
invisible(lapply(packagesload, library, character.only = TRUE))

pkg.versions = data.frame(packagesload)
colnames(pkg.versions) = "packages.used"
pkg.versions$version = "NA"
for (i in 1:length(pkg.versions$packages.used)){
  pkg.versions[i,]$version = package.version(pkg.versions[i,]$packages.used)}

n = 20
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

heatmap.colors = c("lightgray", "mistyrose", "red", "darkred", "black")
###############################################################################

###############################################################################

cal_z_score = function(x){(x - mean(x)) / sd(x)}

removecrap = function(data){
  remove1 = c(data$Description[grep("ameboidal", data$Description, ignore.case = TRUE)], 
              data$Description[grep("glial", data$Description, ignore.case = TRUE)], 
              data$Description[grep("spine", data$Description, ignore.case = TRUE)], 
              data$Description[grep("rhythmic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("heart", data$Description, ignore.case = TRUE)], 
              data$Description[grep("hair", data$Description, ignore.case = TRUE)],
              data$Description[grep("cardiac", data$Description, ignore.case = TRUE)], 
              data$Description[grep("aorta", data$Description, ignore.case = TRUE)], 
              data$Description[grep("valve", data$Description, ignore.case = TRUE)], 
              data$Description[grep("covid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("embryo", data$Description, ignore.case = TRUE)], 
              data$Description[grep("biotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neuromuscular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("spramolecular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("clathrin", data$Description, ignore.case = TRUE)], 
              data$Description[grep("bone", data$Description, ignore.case = TRUE)], 
              data$Description[grep("endocondral", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ER", data$Description, ignore.case = TRUE)], 
              data$Description[grep("melanocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("collagen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("coronary", data$Description, ignore.case = TRUE)], 
              data$Description[grep("vascular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("visual", data$Description, ignore.case = TRUE)], 
              data$Description[grep("detection", data$Description, ignore.case = TRUE)], 
              data$Description[grep("sensory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("virus", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ossification", data$Description, ignore.case = TRUE)], 
              data$Description[grep("reproductive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("symbiotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("synapse", data$Description, ignore.case = TRUE)], 
              data$Description[grep("muscle", data$Description, ignore.case = TRUE)], 
              data$Description[grep("gliogenesis", data$Description, ignore.case = TRUE)],
              data$Description[grep("neuron", data$Description, ignore.case = TRUE)],
              data$Description[grep("neural", data$Description, ignore.case = TRUE)],
              data$Description[grep("striated", data$Description, ignore.case = TRUE)],
              data$Description[grep("artery", data$Description, ignore.case = TRUE)],
              data$Description[grep("biotic", data$Description, ignore.case = TRUE)],
              data$Description[grep("cartilage", data$Description, ignore.case = TRUE)],
              data$Description[grep("vessel", data$Description, ignore.case = TRUE)],
              data$Description[grep("organic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lithium", data$Description, ignore.case = TRUE)], 
              data$Description[grep("progesterone", data$Description, ignore.case = TRUE)],
              data$Description[grep("spindle", data$Description, ignore.case = TRUE)],
              data$Description[grep("multicellular", data$Description, ignore.case = TRUE)],
              data$Description[grep("myoblast", data$Description, ignore.case = TRUE)],
              data$Description[grep("skeletal", data$Description, ignore.case = TRUE)],
              data$Description[grep("wound", data$Description, ignore.case = TRUE)],
              data$Description[grep("ctyoskeleton", data$Description, ignore.case = TRUE)])
  
  data = data[!data$Description %in% remove1,]
  return(data)
}

pickrelevant = function(data){
  immune1 = c(data$Description[grep("immune", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphoid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammatory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("myeloid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("nk", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)], 
              data$Description[grep("innate", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adaptive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("complement", data$Description, ignore.case = TRUE)],
              data$Description[grep("toll", data$Description, ignore.case = TRUE)],
              data$Description[grep("mhc", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("chemotaxis", data$Description, ignore.case = TRUE)],
              data$Description[grep("caspase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NLRP3", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammasome", data$Description, ignore.case = TRUE)], 
              data$Description[grep("aim2", data$Description, ignore.case = TRUE)], 
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("repair", data$Description, ignore.case = TRUE)], 
              data$Description[grep("migration", data$Description, ignore.case = TRUE)],
              data$Description[grep("death", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptotitc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("immune", data$Description, ignore.case = TRUE)],
              data$Description[grep("pyroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necrosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("autophagy", data$Description, ignore.case = TRUE)],
              data$Description[grep("mitochondria", data$Description, ignore.case = TRUE)],
              data$Description[grep("mitochondrial", data$Description, ignore.case = TRUE)],
              data$Description[grep("oxidative", data$Description, ignore.case = TRUE)],
              data$Description[grep("oxidation", data$Description, ignore.case = TRUE)],
              data$Description[grep("fatty acid", data$Description, ignore.case = TRUE)],
              data$Description[grep("lipid", data$Description, ignore.case = TRUE)],
              data$Description[grep("peroxisomes", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("glutathione", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ferroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("cycle", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adhesion", data$Description, ignore.case = TRUE)],  
              data$Description[grep("polarity", data$Description, ignore.case = TRUE)],  
              data$Description[grep("mitotic", data$Description, ignore.case = TRUE)],  
              data$Description[grep("epithelial", data$Description, ignore.case = TRUE)],
              data$Description[grep("fibroblast", data$Description, ignore.case = TRUE)], 
              data$Description[grep("exocytosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("arachadonic", data$Description, ignore.case = TRUE)],
              data$Description[grep("electron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("locomotion", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respiration", data$Description, ignore.case = TRUE)], 
              data$Description[grep("angiogenesis", data$Description, ignore.case = TRUE)],
              data$Description[grep("reduction", data$Description, ignore.case = TRUE)], 
              data$Description[grep("oxygen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("plasma membrane", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NADH", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dehydrogenase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respirasome", data$Description, ignore.case = TRUE)], 
              data$Description[grep("respiratory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("oxidoreductase", data$Description, ignore.case = TRUE)], 
              data$Description[grep("iron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("heme", data$Description, ignore.case = TRUE)], 
              data$Description[grep("NAD", data$Description, ignore.case = TRUE)],
              data$Description[grep("NF", data$Description, ignore.case = TRUE)], 
              data$Description[grep("kappa", data$Description, ignore.case = TRUE)], 
              data$Description[grep("phosphatidylinositol", data$Description, ignore.case = TRUE)])
  
  data = data[data$Description %in% immune1,]
  return(data)
}



pickimmune = function(data){
  
  immune1 = c(data$Description[grep("immune", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
              data$Description[grep("inflammatory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("myeloid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("nk", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)], 
              data$Description[grep("innate", data$Description, ignore.case = TRUE)], 
              data$Description[grep("adaptive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("complement", data$Description, ignore.case = TRUE)],
              data$Description[grep("toll", data$Description, ignore.case = TRUE)],
              data$Description[grep("mhc", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("chemotaxis", data$Description, ignore.case = TRUE)],
              data$Description[grep("migration", data$Description, ignore.case = TRUE)],
              data$Description[grep("death", data$Description, ignore.case = TRUE)], 
              data$Description[grep("apoptosis", data$Description, ignore.case = TRUE)], 
              data$Description[grep("immune", data$Description, ignore.case = TRUE)],
              data$Description[grep("pyroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necroptosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("necrosis", data$Description, ignore.case = TRUE)],
              data$Description[grep("autophagy", data$Description, ignore.case = TRUE)],
              data$Description[grep("ferroptosis", data$Description, ignore.case = TRUE)])
  
  data = data[data$Description %in% immune1,]
  return(data)
}


# glmfit function
glmfitdeg = function (glmfit, cutoff1, condition1){
  lrt1 = glmQLFTest(glmfit, contrast = contrast.mat[,condition1])
  tag.lpst.tol = topTags(lrt1,  n = Inf)
  data1 = as.data.frame(tag.lpst.tol) %>% mutate(Symbol = rownames(tag.lpst.tol))
  data1 = subset(data1, select=c(gene_id, ENTREZID, 10:15))
  data1 = filter(data1, (abs(logFC) > cutoff1 & FDR < 0.05))
  data1 = data1 %>% arrange(desc(data1$logFC))
  data1 = data1 %>% mutate(dir =  ifelse(data1$logFC > cutoff1, "up", "down"))}

glmfitdeg.volcano = function (glmfit, condition1){
  lrt1 = glmQLFTest(glmfit, contrast = contrast.mat[,condition1])
  tag.lpst.tol = topTags(lrt1,  n = Inf)
  data1 = as.data.frame(tag.lpst.tol) %>% mutate(Symbol = rownames(tag.lpst.tol))
  data1 = subset(data1, select=c(gene_id, ENTREZID, 10:15))
  data1 = filter(data1, (FDR < 0.05))
  data1 = data1 %>% arrange(desc(data1$logFC))}

# OR analysis
OR.GO.analysis = function(gene.ensembl, pval, qval, process, dir){
  ego.bp.cup = c()
  ego.bp.cup = enrichGO(gene = not.diff.set$ensembl,
                        OrgDb   = org.Mm.eg.db,  ont  = process, 
                        keyType  = "ENSEMBL", pAdjustMethod = "BH", 
                        pvalueCutoff= pval, qvalueCutoff = qval, 
                        readable = TRUE)
  
  ego.bp.cup = filter(ego.bp.cup, p.adjust < pval, qvalue < qval)
  ego.bp.cup = mutate(ego.bp.cup, geneRatio = 
                        parse_ratio(GeneRatio))  %>% arrange(desc(geneRatio))
  ego.bp.cup = mutate(ego.bp.cup, richFactor = Count / 
                        as.numeric(sub("/\\d+", "", BgRatio)))
  ego.bp.cup = mutate(ego.bp.cup, FoldEnrichment = 
                        parse_ratio(GeneRatio) / parse_ratio(BgRatio))
  
  if (dir == "up") {
    title1 = paste0("Upregulated genes - GO:", process)
  } else {
    title1 = paste0("Suppressed genes - GO:", process)
  }
  
  plot.1 = ggplot(ego.bp.cup, showCategory = 50,  
                  aes(FoldEnrichment, fct_reorder(Description, FoldEnrichment))) + 
    geom_point(aes(colour = p.adjust, size = Count)) +     
    scale_color_viridis_c(guide= guide_colorbar(reverse=TRUE)) +
    scale_size_continuous(range=c(2, 5)) +
    theme_minimal() + scale_x_continuous()+
    xlab("FoldEnrichment") + ylab(NULL) + 
    geom_vline(xintercept = 0, linetype = "dashed", colour = "gray") + 
    ggtitle(title1)
  
  return(list(ego.bp.cup, plot.1))
}

# GSEA
gsea.bp.z = function(genelist){
  genelist = sort(genelist, decreasing = TRUE)
  gse.temp = gseGO(geneList=genelist, 
                   ont ="all", 
                   keyType = "SYMBOL",
                   minGSSize = 5, 
                   maxGSSize = 800, 
                   pvalueCutoff = 0.05, 
                   pAdjustMethod = "BH",
                   verbose = TRUE,
                   seed = 42,
                   OrgDb = org.Mm.eg.db)
  
  gse = as.data.frame(gse.temp)
  gse = gse %>% dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(gse, NES)
  gse$Pathway.Direction = cut(-1*gse$NES, c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  colnames(gse)[4] = "Count"
  gse = removecrap(gse)
  
  plot.gse = ggplot(gse, aes(x = log.p.adj, y = Description)) + 
    geom_point(aes(color= p.adjust, size = Count)) + theme_bw() + 
    geom_vline(xintercept  = 0, linetype = "dashed")+
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) + 
    theme(axis.text.y = element_text(size = 10)) +xlab("-log10 of P-value") +
    ylab("Description") + 
    ggtitle("GSEA-GO:BP") + 
    facet_grid(~Pathway.Direction)
  
  return(list(gse.temp, gse, plot.gse))
}

# gsea.bp.z = function(genelist){
#   genelist = sort(genelist, decreasing = TRUE)
#   gse.temp = gseGO(geneList=genelist, 
#                    ont ="all", 
#                    keyType = "SYMBOL",
#                    minGSSize = 5, 
#                    maxGSSize = 800, 
#                    pvalueCutoff = 0.05, 
#                    pAdjustMethod = "BH",
#                    verbose = TRUE,
#                    seed = 42,
#                    OrgDb = org.Mm.eg.db)
#   
#   gse = as.data.frame(gse.temp)
#   gse = gse %>% dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(gse, NES)
#   gse$Pathway.Direction = cut(-1*gse$NES, c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
#   colnames(gse)[4] = "Count"
#   gse = removecrap(gse)
#   
#   plot.gse = ggplot(gse, aes(x = log.p.adj, y = Description)) + 
#     geom_point(aes(color= p.adjust, size = Count)) + theme_bw() + 
#     geom_vline(xintercept  = 0, linetype = "dashed")+
#     scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) + 
#     theme(axis.text.y = element_text(size = 10)) +xlab("-log10 of P-value") +
#     ylab("Description") + 
#     ggtitle("GSEA-GO:BP") + 
#     facet_grid(~Pathway.Direction)
#   
#   return(list(gse.temp, gse, plot.gse))
# }

### for edgeR analysis, adjust the threshold, FDR < 0.05
edgeR.to.DEG = function (fc.threshold){
  
  source("setup/raw.to.R")
  
  glmfit = glmQLFit(dds, design)
  cutoff1 = fc.threshold

  # DEGs 
  lpst.tol = glmfitdeg(glmfit, cutoff1, "lpstol.tol")
  lpstol.lps = glmfitdeg(glmfit, cutoff1, "lpstol.lps")
  lpstol.nil = glmfitdeg(glmfit, cutoff1, "lpstol.nil")
  tol.lps = glmfitdeg(glmfit, cutoff1, "tol.lps")
  tol.nil = glmfitdeg(glmfit, cutoff1, "tol.nil")
  lps.nil = glmfitdeg(glmfit, cutoff1, "lps.nil")
  keep2 = Reduce(intersect, list(rownames(lps.nil), rownames(tol.nil), 
                                 rownames(tol.lps), rownames(lpstol.nil), 
                                 rownames(lpstol.lps), rownames(lpst.tol)))


  lpst.tol = lpst.tol %>% mutate(significant = FDR < 0.05)
  lpstol.lps = lpstol.lps %>% mutate(significant = FDR < 0.05)
  lpstol.nil = lpstol.nil %>% mutate(significant = FDR < 0.05)
  
  tol.nil = tol.nil %>% mutate(significant = FDR < 0.05)
  tol.lps = tol.lps %>% mutate(significant = FDR < 0.05)
  lps.nil = lps.nil %>% mutate(significant = FDR < 0.05)

  setClass("toldc.edgeR",  
         slots = c(lpst.tol = "data.frame", lpstol.lps = "data.frame", 
                   lpstol.nil = "data.frame", tol.lps = "data.frame",
                   tol.nil = "data.frame", lps.nil = "data.frame"),
         
         prototype = list(lpst.tol = data.frame(), lpstol.lps = data.frame(), 
                          lpstol.nil = data.frame(), tol.lps = data.frame(),
                          tol.nil = data.frame(), lps.nil = data.frame()))

  toldc.edgeR = new("toldc.edgeR", 
                  lpst.tol = lpst.tol, 
                  lpstol.lps = lpstol.lps, 
                  lpstol.nil = lpstol.nil, 
                  tol.lps =  tol.lps,
                  tol.nil = tol.nil, 
                  lps.nil = lps.nil )

  return(toldc.edgeR)
}

### Limma to DEG, fdr < 0.05
limma.to.DEG = function(fc.threshold){
  
  source("setup/raw.to.R")
  
  dds1 = voom(dds, design, plot=FALSE)
  fit = lmFit(dds1, design)
  fit2 = contrasts.fit(fit, contrast.mat)
  efit = eBayes(fit2, robust = TRUE)
  
  e.lpstol.tol = c()
  e.lpstol.tol = topTable(efit, coef = "lpstol.tol", adjust.method="fdr", sort.by = "B", n = Inf) 
  e.lpstol.tol = e.lpstol.tol %>% data.frame() %>% mutate(Symbol = rownames(e.lpstol.tol))
  e.lpstol.tol = subset(e.lpstol.tol, select=c(gene_id, ENTREZID, logFC, AveExpr, t, P.Value, adj.P.Val, B, Symbol))
  e.lpstol.tol = filter(e.lpstol.tol, adj.P.Val < 0.05)
  e.lpstol.tol = filter(e.lpstol.tol, logFC > log2(fc.threshold))
  
  e.lpstol.lps = c()
  e.lpstol.lps = topTable(efit, coef = "lpstol.lps", adjust.method="fdr", sort.by = "B", n = Inf)
  e.lpstol.lps = e.lpstol.lps %>% data.frame() %>% mutate(Symbol = rownames(e.lpstol.lps))
  e.lpstol.lps = subset(e.lpstol.lps, select=c(gene_id, ENTREZID, logFC, AveExpr, t, P.Value, adj.P.Val, B, Symbol))
  e.lpstol.lps = filter(e.lpstol.lps, adj.P.Val < 0.05)
  e.lpstol.lps = filter(e.lpstol.lps, logFC > log2(fc.threshold))
  
  e.lpstol.nil = c()
  e.lpstol.nil = topTable(efit, coef = "lpstol.nil", adjust.method="fdr", sort.by = "B", n = Inf)
  e.lpstol.nil = e.lpstol.nil %>% data.frame() %>% mutate(Symbol = rownames(e.lpstol.nil))
  e.lpstol.nil = subset(e.lpstol.nil, select=c(gene_id, ENTREZID, logFC, AveExpr, t, P.Value, adj.P.Val, B, Symbol))
  e.lpstol.nil = filter(e.lpstol.nil, adj.P.Val < 0.05)
  e.lpstol.nil = filter(e.lpstol.nil, logFC > log2(fc.threshold))
  
  e.tol.nil = c()
  e.tol.nil = topTable(efit, coef = "tol.nil", adjust.method="fdr", sort.by = "B", n = Inf)
  e.tol.nil = e.tol.nil %>% data.frame() %>% mutate(Symbol = rownames(e.tol.nil))
  e.tol.nil = subset(e.tol.nil, select=c(gene_id, ENTREZID, logFC, AveExpr, t, P.Value, adj.P.Val, B, Symbol))
  e.tol.nil = filter(e.tol.nil, adj.P.Val < 0.05)
  e.tol.nil = filter(e.tol.nil, logFC > log2(fc.threshold))
  
  e.lps.nil = c()
  e.lps.nil = topTable(efit, coef = "lps.nil", adjust.method="fdr", sort.by = "B", n = Inf)
  e.lps.nil = e.lps.nil %>% data.frame() %>% mutate(Symbol = rownames(e.lps.nil))
  e.lps.nil = subset(e.lps.nil, select=c(gene_id, ENTREZID, logFC, AveExpr, t, P.Value, adj.P.Val, B, Symbol))
  e.lps.nil = filter(e.lps.nil, adj.P.Val < 0.05)
  e.lps.nil = filter(e.lps.nil, logFC > log2(fc.threshold))
  
  e.tol.lps = c()
  e.tol.lps = topTable(efit, coef = "tol.lps", adjust.method="fdr", sort.by = "B", n = Inf)
  e.tol.lps = e.tol.lps %>% data.frame() %>% mutate(Symbol = rownames(e.tol.lps))
  e.tol.lps = subset(e.tol.lps, select=c(gene_id, ENTREZID, logFC, AveExpr, t, P.Value, adj.P.Val, B, Symbol))
  e.tol.lps = filter(e.tol.lps, adj.P.Val < 0.05)
  e.tol.lps = filter(e.tol.lps, logFC > log2(fc.threshold))
  
  setClass("toldc.limma",  
           slots = c(lpst.tol = "data.frame", 
                     lpstol.lps = "data.frame", 
                     lpstol.nil = "data.frame", 
                     tol.lps = "data.frame",
                     tol.nil = "data.frame", 
                     lps.nil = "data.frame"),
           
           prototype = list(lpst.tol = data.frame(), 
                            lpstol.lps = data.frame(), 
                            lpstol.nil = data.frame(), 
                            tol.lps = data.frame(),
                            tol.nil = data.frame(), 
                            lps.nil = data.frame()))
  
  toldc.limma = new("toldc.limma", 
                    lpst.tol = e.lpstol.tol, 
                    lpstol.lps = e.lpstol.lps, 
                    lpstol.nil = e.lpstol.nil, 
                    tol.lps =  e.tol.lps,
                    tol.nil = e.tol.nil, 
                    lps.nil = e.lps.nil )
  
  return(toldc.limma)
}





trimmer = function(data){
  data = data[data$p.adjust < 0.05,]
  
  data = data[!(data$Description == "viral entry into host cell"),]
  data = data[!(data$Description == "neuroinflammatory response"),]
  data = data[!(data$Description == "immune response"),]
  data = data[!(data$Description == "immune system process"),]
  data = data[!(data$Description == "enzyme linked receptor protein signaling pathway"),]
  data = data[!(data$Description == "inflammatory response"),]
  data = data[!(data$Description == "tissue migration"),]
  data = data[!(data$Description == "movement in host environment"),]
  
  remove = c(data$Description[grep("regulation",  data$Description, ignore.case = TRUE)],  
             data$Description[grep("epithelium",  data$Description, ignore.case = TRUE)],
             data$Description[grep("projection",  data$Description, ignore.case = TRUE)],
             data$Description[grep("sprouting",  data$Description, ignore.case = TRUE)],
             data$Description[grep("complex I",   data$Description, ignore.case = TRUE)], 
             data$Description[grep("plasma membrane",   data$Description, ignore.case = TRUE)],
             data$Description[grep("cellular lipid",   data$Description, ignore.case = TRUE)],
             data$Description[grep("locomotion",   data$Description, ignore.case = TRUE)],
             data$Description[grep("adhesion",   data$Description, ignore.case = TRUE)],
             data$Description[grep("protein",   data$Description, ignore.case = TRUE)],
             data$Description[grep("migration",   data$Description, ignore.case = TRUE)])
  data = data[!(data$Description %in% remove),]
  
  myeloid = c(data$Description[grep("myeloid", data$Description, ignore.case = TRUE)],
              data$Description[grep("monocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("mononuclear", data$Description, ignore.case = TRUE)], 
              data$Description[grep("macrophage", data$Description, ignore.case = TRUE)], 
              data$Description[grep("granulocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("dendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)],
              data$Description[grep("tumour", data$Description, ignore.case = TRUE)],
              data$Description[grep("tumor", data$Description, ignore.case = TRUE)],
              data$Description[grep("antigen", data$Description, ignore.case = TRUE)],
              data$Description[grep("neutrophil", data$Description, ignore.case = TRUE)],
              data$Description[grep("innate", data$Description, ignore.case = TRUE)])
  
  lymphoid = c(data$Description[grep("lymphocyte", data$Description, ignore.case = TRUE)],
               data$Description[grep("leukocyte", data$Description, ignore.case = TRUE)], 
               data$Description[grep("T cell", data$Description, ignore.case = TRUE)], 
               data$Description[grep("B cell", data$Description, ignore.case = TRUE)], 
               data$Description[grep("effector", data$Description, ignore.case = TRUE)], 
               data$Description[grep("adaptive", data$Description, ignore.case = TRUE)])
  lymphoid = lymphoid[!(lymphoid %in% myeloid)]
  
  c.death = c(data$Description[grep("death", data$Description, ignore.case = TRUE)],
              data$Description[grep("apoptotic", data$Description, ignore.case = TRUE)],
              data$Description[grep("platelet", data$Description, ignore.case = TRUE)],
              data$Description[grep("immune", data$Description, ignore.case = TRUE)])
  
  metab = c(data$Description[grep("oxidation", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxidative", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxygen", data$Description, ignore.case = TRUE)],
            data$Description[grep("heme", data$Description, ignore.case = TRUE)],
            data$Description[grep("fatty", data$Description, ignore.case = TRUE)],
            data$Description[grep("lipid", data$Description, ignore.case = TRUE)],
            data$Description[grep("iron", data$Description, ignore.case = TRUE)],
            data$Description[grep("respiratory", data$Description, ignore.case = TRUE)],
            data$Description[grep("oxidoreductase", data$Description, ignore.case = TRUE)], 
            data$Description[grep("dehydrogenase", data$Description, ignore.case = TRUE)], 
            data$Description[grep("glutathione", data$Description, ignore.case = TRUE)], 
            data$Description[grep("NAD", data$Description, ignore.case = TRUE)], 
            data$Description[grep("tricarboxylic", data$Description, ignore.case = TRUE)], 
            data$Description[grep("respirasome", data$Description, ignore.case = TRUE)],
            data$Description[grep("respiration", data$Description, ignore.case = TRUE)],
            data$Description[grep("electron", data$Description, ignore.case = TRUE)], 
            data$Description[grep("mitochondrial", data$Description, ignore.case = TRUE)], 
            data$Description[grep("mitochondria", data$Description, ignore.case = TRUE)])
  
  adh.cycle = c(data$Description[grep("adhesion", data$Description, ignore.case = TRUE)],
                data$Description[grep("epithelial", data$Description, ignore.case = TRUE)],
                data$Description[grep("angiogenesis", data$Description, ignore.case = TRUE)],
                data$Description[grep("mitotic", data$Description, ignore.case = TRUE)],
                data$Description[grep("exocytosis", data$Description, ignore.case = TRUE)],
                data$Description[grep("membrane", data$Description, ignore.case = TRUE)],
                data$Description[grep("fibroblast", data$Description, ignore.case = TRUE)],
                data$Description[grep("endothelial", data$Description, ignore.case = TRUE)],
                data$Description[grep("polarity", data$Description, ignore.case = TRUE)],
                data$Description[grep("phosphatidylinositol", data$Description, ignore.case = TRUE)],
                data$Description[grep("cycle", data$Description, ignore.case = TRUE)])
  adh.cycle = adh.cycle[!(adh.cycle%in% metab)]
  adh.cycle = adh.cycle[!(adh.cycle%in% c.death)]
  
  data$group  = NA
  data$group = ifelse(data$Description %in% myeloid, "innate", data$group)
  data$group = ifelse(data$Description %in% lymphoid, "adaptive", data$group)
  data$group = ifelse(data$Description %in% metab, "metab", data$group)
  data$group = ifelse(data$Description %in% adh.cycle, "cell", data$group)
  data$group = ifelse(data$Description %in% c.death, "death", data$group)
  
  return(data)}


###### remove processess not relevant to our research from final list #######
removecrap = function(data){
  remove1 = c(data$Description[grep("ameboidal", data$Description, ignore.case = TRUE)], 
              data$Description[grep("glial", data$Description, ignore.case = TRUE)], 
              data$Description[grep("spine", data$Description, ignore.case = TRUE)], 
              data$Description[grep("rhythmic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("heart", data$Description, ignore.case = TRUE)], 
              data$Description[grep("hair", data$Description, ignore.case = TRUE)],
              data$Description[grep("cardiac", data$Description, ignore.case = TRUE)], 
              data$Description[grep("aorta", data$Description, ignore.case = TRUE)], 
              data$Description[grep("valve", data$Description, ignore.case = TRUE)], 
              data$Description[grep("covid", data$Description, ignore.case = TRUE)], 
              data$Description[grep("embryo", data$Description, ignore.case = TRUE)], 
              data$Description[grep("biotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neuromuscular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("spramolecular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("clathrin", data$Description, ignore.case = TRUE)], 
              data$Description[grep("bone", data$Description, ignore.case = TRUE)], 
              data$Description[grep("endocondral", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ER", data$Description, ignore.case = TRUE)], 
              data$Description[grep("melanocyte", data$Description, ignore.case = TRUE)], 
              data$Description[grep("collagen", data$Description, ignore.case = TRUE)], 
              data$Description[grep("tube", data$Description, ignore.case = TRUE)], 
              data$Description[grep("coronary", data$Description, ignore.case = TRUE)], 
              data$Description[grep("vascular", data$Description, ignore.case = TRUE)], 
              data$Description[grep("visual", data$Description, ignore.case = TRUE)], 
              data$Description[grep("disc", data$Description, ignore.case = TRUE)], 
              data$Description[grep("synaptic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("tree", data$Description, ignore.case = TRUE)], 
              data$Description[grep("somatodendritic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("detection", data$Description, ignore.case = TRUE)], 
              data$Description[grep("sensory", data$Description, ignore.case = TRUE)], 
              data$Description[grep("virus", data$Description, ignore.case = TRUE)], 
              data$Description[grep("neuron", data$Description, ignore.case = TRUE)], 
              data$Description[grep("viral", data$Description, ignore.case = TRUE)], 
              data$Description[grep("gonad", data$Description, ignore.case = TRUE)], 
              data$Description[grep("biological", data$Description, ignore.case = TRUE)], 
              data$Description[grep("organ", data$Description, ignore.case = TRUE)], 
              data$Description[grep("male", data$Description, ignore.case = TRUE)], 
              data$Description[grep("female", data$Description, ignore.case = TRUE)], 
              data$Description[grep("syncitium", data$Description, ignore.case = TRUE)], 
              data$Description[grep("ossification", data$Description, ignore.case = TRUE)], 
              data$Description[grep("reproductive", data$Description, ignore.case = TRUE)], 
              data$Description[grep("symbiotic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("alcohol", data$Description, ignore.case = TRUE)], 
              data$Description[grep("actin", data$Description, ignore.case = TRUE)], 
              data$Description[grep("synapse", data$Description, ignore.case = TRUE)], 
              data$Description[grep("muscle", data$Description, ignore.case = TRUE)], 
              data$Description[grep("gliogenesis", data$Description, ignore.case = TRUE)],
              data$Description[grep("neuron", data$Description, ignore.case = TRUE)],
              data$Description[grep("neural", data$Description, ignore.case = TRUE)],
              data$Description[grep("striated", data$Description, ignore.case = TRUE)],
              data$Description[grep("artery", data$Description, ignore.case = TRUE)],
              data$Description[grep("biotic", data$Description, ignore.case = TRUE)],
              data$Description[grep("cartilage", data$Description, ignore.case = TRUE)],
              data$Description[grep("vessel", data$Description, ignore.case = TRUE)],
              data$Description[grep("organic", data$Description, ignore.case = TRUE)], 
              data$Description[grep("lithium", data$Description, ignore.case = TRUE)], 
              data$Description[grep("progesterone", data$Description, ignore.case = TRUE)],
              data$Description[grep("spindle", data$Description, ignore.case = TRUE)],
              data$Description[grep("multicellular", data$Description, ignore.case = TRUE)],
              data$Description[grep("myoblast", data$Description, ignore.case = TRUE)],
              data$Description[grep("skeletal", data$Description, ignore.case = TRUE)],
              data$Description[grep("wound", data$Description, ignore.case = TRUE)],
              data$Description[grep("parkinson", data$Description, ignore.case = TRUE)],
              data$Description[grep("cytoskeleton", data$Description, ignore.case = TRUE)])
  
  data = data[!data$Description %in% remove1,]
  return(data)
}

############# GSEA with GO (clusterprofiler) ######################
ggosummary = function (gene0, pcutoff, adjmethod, ont){
  g.go.bp = c()
  g.go.bp = gseGO(geneList = gene0, 
                  ont =ont, # options: All, BP (biol process), MF (mol func), CC (cytosolic comp)
                  keyType = "SYMBOL", 
                  OrgDb = org.Mm.eg.db, 
                  nPerm = 10000, # permutations, set 10,000 when correct
                  minGSSize = 10, # min number genes in set
                  maxGSSize = 1000, # max genes in a set
                  pvalueCutoff = pcutoff,
                  verbose = FALSE, 
                  seed = 42,
                  pAdjustMethod = adjmethod)
  
  ggo.bp = filter(g.go.bp, p.adjust < 0.05, qvalues < 0.05)
  x2.bp = pairwise_termsim(ggo.bp)
  
  ggo.bp1 = as.data.frame(ggo.bp)
  ggo.bp1 = ggo.bp1 %>% dplyr::mutate(log.p.adj = -log(p.adjust)) %>% arrange(ggo.bp1, NES)
  ggo.bp1$Pathway.Direction = cut(-1*ggo.bp1$NES, c(-Inf,0,Inf), c("Upregulated", "Suppressed"))
  colnames(ggo.bp1)[4] = "Count"
  ggo.bp1 = removecrap(ggo.bp1)
  
  
  pg1.bp = dotplot(ggo.bp, showCategory = 20, title = "GSEA-GO", split = ".sign") + facet_grid(.~.sign)
  pg2.bp = gseaplot(ggo.bp, by = "all", geneSetID = 1)
  pg3.bp = ridgeplot(ggo.bp) + labs(x = "enrichment distribution")
  pg4.bp = emapplot(x2.bp)
  pg5.bp = ggplot(ggo.bp1, aes(x = log.p.adj, y = Description)) + 
    geom_point(aes(color= p.adjust, size = setSize)) + theme_bw() + 
    geom_vline(xintercept  = 0, linetype = "dashed")+
    scale_color_viridis_c(guide=guide_colorbar(reverse=TRUE)) + 
    theme(axis.text.y = element_text(size = 10)) +xlab("-log10 of P-value") +
    ylab("Description") + 
    ggtitle("GSEA-GO:BP") + 
    facet_grid(~Pathway.Direction)
  pg6.bp = cnetplot(x2.bp, categorySize = "p.adjust", 
                    colorEdge = TRUE, foldChange = gene0, 
                    node_label = "all", cex_label_category = 1.3)
  
  listgsego.bp = list(pg1.bp, pg2.bp, pg3.bp, pg4.bp, pg5.bp, pg6.bp)
  
  gselist = list("gsego.bp" = ggo.bp, "gsegoplot.bp" = listgsego.bp)
  # "gsego.mf" = ggo.mf, "gsegoplot.mf" = listgsego.mf)
  # # "gsego.cc" = ggo.cc, "gsegoplot.cc" = listgsego.cc)
  
  return(gselist)
}

```
